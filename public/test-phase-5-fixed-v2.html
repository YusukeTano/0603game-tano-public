<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; worker-src 'self' blob:; object-src 'none';">
    <title>Phase 5 Integration Test - 診断機能強化版</title>
    
    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <script>
        // CSPエラー監視とTone.js状態確認
        window.addEventListener('securitypolicyviolation', (event) => {
            if (event.blockedURI.includes('blob:')) {
                console.log('🛡️ CSP: Blob Worker作成をブロック（Tone.js関連、正常動作）');
            } else if (event.blockedURI.includes('chrome-extension:')) {
                console.log('🛡️ CSP: Chrome拡張機能をブロック（正常動作）');
            } else {
                console.warn('⚠️ 予期しないCSP違反:', event.blockedURI);
            }
        });
        
        // Tone.js読み込み確認
        window.addEventListener('load', () => {
            if (typeof Tone === 'undefined') {
                console.error('❌ Tone.js 読み込み失敗');
            } else {
                console.log('✅ Tone.js 読み込み成功:', Tone.version);
                
                // WorkerエラーでもTone.jsは基本機能が使える
                console.log('🎵 Tone.js基本機能利用可能（Workerエラーは無視可能）');
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .diagnostic-panel {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .diagnostic-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }
        
        .diagnostic-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .status-ok { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #FF9800; }
        .status-pending { background: #2196F3; }
        
        .error-details {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); color: #81C784; }
        .log-warning { background: rgba(255, 152, 0, 0.2); color: #FFB74D; }
        .log-error { background: rgba(244, 67, 54, 0.2); color: #E57373; }
        .log-info { background: rgba(33, 150, 243, 0.2); color: #64B5F6; }
        
        .file-check-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .file-check-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .hidden-ui {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🔬 Phase 5 Integration Test - 診断強化版</h1>
            <p>詳細なエラー診断とデバッグ機能</p>
        </div>
        
        <!-- 診断パネル -->
        <div class="diagnostic-panel">
            <h3>📊 環境診断結果</h3>
            <div id="diagnostic-results">
                <div class="diagnostic-item">
                    <div class="diagnostic-status status-pending"></div>
                    <span>診断待機中...</span>
                </div>
            </div>
        </div>
        
        <!-- テストコントロール -->
        <div class="test-controls">
            <button onclick="runFullDiagnostics()">🔍 完全診断実行</button>
            <button onclick="checkFileExistence()">📁 ファイル存在確認</button>
            <button onclick="testModuleImports()">📦 モジュールテスト</button>
            <button onclick="testAudioSystem()">🔊 音響システムテスト</button>
            <button onclick="initializeGame()">🎮 ゲーム初期化</button>
            <button onclick="testPhase5Features()">🚀 Phase 5 機能テスト</button>
        </div>
        
        <!-- ファイルチェック結果 -->
        <div class="diagnostic-panel" id="file-check-panel" style="display: none;">
            <h3>📁 ファイル存在確認</h3>
            <div class="file-check-list" id="file-check-results"></div>
        </div>
        
        <!-- エラー詳細 -->
        <div id="error-panel" style="display: none;">
            <h3>❌ エラー詳細</h3>
            <div class="error-details" id="error-details"></div>
        </div>
        
        <!-- テストログ -->
        <div class="test-log" id="test-log">
            <div class="log-entry log-info">診断システム起動完了</div>
        </div>
    </div>
    
    <!-- 必須のゲームUI要素（非表示） -->
    <div class="hidden-ui">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <!-- ボタン要素 -->
        <button id="start-game-btn">ゲーム開始</button>
        <button id="instructions-btn">操作方法</button>
        <button id="back-to-menu-btn">メニューに戻る</button>
        <button id="resume-btn">再開</button>
        <button id="restart-btn">リスタート</button>
        <button id="quit-btn">終了</button>
        <button id="play-again-btn">もう一度プレイ</button>
        <button id="main-menu-btn">メインメニュー</button>
        <button id="settings-btn">設定</button>
        <button id="pause-btn">ポーズ</button>
        <button id="mobile-pause-btn">モバイルポーズ</button>
        
        <!-- UI要素 -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- 音量調整 -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ゲーム情報表示 -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- スキル関連 -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- 中間エリア -->
        <div class="middle-area">
            <div class="stats-container">
                <div class="stats-bar"></div>
                <div class="health-bar"></div>
                <div class="exp-bar"></div>
            </div>
            <div class="skills-container">
                <div class="skill-icons"></div>
                <div class="skill-numbers"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // グローバル変数
        let game = null;
        const diagnosticResults = {};
        
        // エラーハンドリング（Chrome拡張機能エラーを除外）
        window.addEventListener('error', (event) => {
            // Chrome拡張機能のエラーを無視
            if (event.filename && event.filename.includes('chrome-extension://')) {
                console.log('Chrome拡張機能エラーを無視:', event.filename);
                return;
            }
            
            logError(`グローバルエラー: ${event.error?.message || event.message}`);
            showErrorDetails(event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            // Chrome拡張機能のPromiseエラーを無視
            if (event.reason && event.reason.toString().includes('chrome-extension://')) {
                console.log('Chrome拡張機能Promiseエラーを無視:', event.reason);
                return;
            }
            
            logError(`Promiseエラー: ${event.reason}`);
            showErrorDetails(event.reason);
        });
        
        // 完全診断
        window.runFullDiagnostics = async function() {
            logInfo('=== 完全診断開始 ===');
            const results = document.getElementById('diagnostic-results');
            results.innerHTML = '';
            
            // 診断項目
            const checks = [
                { name: 'プロトコル確認', check: () => window.location.protocol !== 'file:' },
                { name: 'Tone.js読み込み', check: () => typeof Tone !== 'undefined' },
                { name: 'ES6モジュール対応', check: () => 'noModule' in HTMLScriptElement.prototype },
                { name: 'Web Audio API', check: () => typeof AudioContext !== 'undefined' },
                { name: 'Canvas要素', check: () => document.getElementById('game-canvas') !== null },
                { name: '必須UI要素', check: () => checkRequiredElements() }
            ];
            
            for (const item of checks) {
                const status = item.check() ? 'ok' : 'error';
                diagnosticResults[item.name] = status;
                
                const div = document.createElement('div');
                div.className = 'diagnostic-item';
                div.innerHTML = `
                    <div class="diagnostic-status status-${status}"></div>
                    <span>${item.name}: ${status === 'ok' ? '✅ OK' : '❌ NG'}</span>
                `;
                results.appendChild(div);
                
                logInfo(`${item.name}: ${status === 'ok' ? '成功' : '失敗'}`);
            }
            
            // 詳細情報
            logInfo(`現在のURL: ${window.location.href}`);
            logInfo(`Tone.jsバージョン: ${typeof Tone !== 'undefined' ? Tone.version : '未読み込み'}`);
        };
        
        // ファイル存在確認
        window.checkFileExistence = async function() {
            logInfo('=== ファイル存在確認 ===');
            document.getElementById('file-check-panel').style.display = 'block';
            const results = document.getElementById('file-check-results');
            results.innerHTML = '';
            
            const files = [
                'game.js',
                'js/systems/phase5-integration-controller.js',
                'js/systems/phase5-safe-integration-layer.js',
                'js/systems/phase5-performance-optimizer.js',
                'js/systems/phase5-edge-case-handler.js',
                'js/systems/phase4-audio-facade.js',
                'js/systems/integrated-audio-manager.js'
            ];
            
            for (const file of files) {
                try {
                    const response = await fetch(`./${file}`, { method: 'HEAD' });
                    const status = response.ok ? 'ok' : 'error';
                    
                    const div = document.createElement('div');
                    div.className = 'file-check-item';
                    div.innerHTML = `
                        <div class="diagnostic-status status-${status}"></div>
                        <span>${file} ${response.ok ? '✅' : `❌ (${response.status})`}</span>
                    `;
                    results.appendChild(div);
                    
                    logInfo(`${file}: ${response.ok ? '存在' : `不在 (${response.status})`}`);
                } catch (error) {
                    logError(`${file}: エラー - ${error.message}`);
                }
            }
        };
        
        // モジュールインポートテスト
        window.testModuleImports = async function() {
            logInfo('=== モジュールインポートテスト ===');
            
            const modules = [
                { path: './game.js', name: 'game.js' },
                { path: './js/systems/phase5-integration-controller.js', name: 'Phase5IntegrationController' },
                { path: './js/systems/integrated-audio-manager.js', name: 'IntegratedAudioManager' }
            ];
            
            for (const mod of modules) {
                try {
                    const module = await import(mod.path);
                    logSuccess(`✅ ${mod.name} インポート成功`);
                    logInfo(`エクスポート: ${Object.keys(module).join(', ')}`);
                } catch (error) {
                    logError(`❌ ${mod.name} インポート失敗: ${error.message}`);
                    showErrorDetails(error);
                }
            }
        };
        
        // 音響システムテスト
        window.testAudioSystem = async function() {
            logInfo('=== 音響システムテスト ===');
            
            if (typeof Tone === 'undefined') {
                logError('Tone.jsが読み込まれていません');
                return;
            }
            
            try {
                // Tone.js開始
                await Tone.start();
                logSuccess('✅ Tone.js AudioContext開始');
                
                // テスト音再生
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n");
                logSuccess('✅ テスト音再生成功');
                
                // AudioContext状態確認
                logInfo(`AudioContext状態: ${Tone.context.state}`);
                logInfo(`サンプルレート: ${Tone.context.sampleRate}`);
                
            } catch (error) {
                logError(`音響システムエラー: ${error.message}`);
                showErrorDetails(error);
            }
        };
        
        // ゲーム初期化
        window.initializeGame = async function() {
            logInfo('=== ゲーム初期化 ===');
            
            try {
                const { ZombieSurvival } = await import('./game.js');
                game = new ZombieSurvival();
                logSuccess('✅ ゲームインスタンス作成');
                
                await game.init();
                logSuccess('✅ ゲーム初期化完了');
                
                // 音響システム初期化
                if (game.audioSystem === null) {
                    await game.initializeAudioSystem();
                    logSuccess('✅ 音響システム初期化');
                }
                
                // Phase 5確認
                if (game.phase5Integration) {
                    logSuccess('✅ Phase 5 Integration検出');
                    logInfo(`Phase 5ステータス: ${game.phase5Integration.initialized ? '初期化済み' : '未初期化'}`);
                } else {
                    logWarning('Phase 5 Integrationが見つかりません');
                }
                
            } catch (error) {
                logError(`ゲーム初期化エラー: ${error.message}`);
                showErrorDetails(error);
            }
        };
        
        // Phase 5機能テスト
        window.testPhase5Features = async function() {
            if (!game || !game.phase5Integration) {
                logError('ゲームまたはPhase 5が初期化されていません');
                return;
            }
            
            logInfo('=== Phase 5機能テスト ===');
            
            const tests = [
                {
                    name: 'アイテム取得音',
                    test: () => game.phase5Integration.playPickupSound('health')
                },
                {
                    name: 'レベルアップ音',
                    test: () => game.phase5Integration.playLevelUpSound(false)
                },
                {
                    name: 'コンボ音',
                    test: () => game.phase5Integration.handleComboSound(0, 10)
                },
                {
                    name: 'フィーチャー切り替え',
                    test: () => game.phase5Integration.toggleFeature('pickupSounds', true)
                }
            ];
            
            for (const test of tests) {
                try {
                    test.test();
                    logSuccess(`✅ ${test.name} 成功`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    logError(`❌ ${test.name} 失敗: ${error.message}`);
                }
            }
        };
        
        // ヘルパー関数
        function checkRequiredElements() {
            const requiredIds = [
                'game-canvas', 'start-game-btn', 'loading-screen',
                'main-menu', 'game-screen', 'master-volume'
            ];
            
            return requiredIds.every(id => document.getElementById(id) !== null);
        }
        
        function showErrorDetails(error) {
            const panel = document.getElementById('error-panel');
            const details = document.getElementById('error-details');
            
            panel.style.display = 'block';
            details.textContent = error.stack || error.toString();
        }
        
        function logInfo(message) {
            addLogEntry('info', message);
        }
        
        function logSuccess(message) {
            addLogEntry('success', message);
        }
        
        function logWarning(message) {
            addLogEntry('warning', message);
        }
        
        function logError(message) {
            addLogEntry('error', message);
        }
        
        function addLogEntry(type, message) {
            const log = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // 初期診断
        setTimeout(() => {
            runFullDiagnostics();
        }, 500);
    </script>
</body>
</html>