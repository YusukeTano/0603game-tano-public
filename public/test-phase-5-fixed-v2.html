<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; worker-src 'self' blob:; object-src 'none';">
    <title>Phase 5 Integration Test - è¨ºæ–­æ©Ÿèƒ½å¼·åŒ–ç‰ˆ</title>
    
    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <script>
        // CSPã‚¨ãƒ©ãƒ¼ç›£è¦–ã¨Tone.jsçŠ¶æ…‹ç¢ºèª
        window.addEventListener('securitypolicyviolation', (event) => {
            if (event.blockedURI.includes('blob:')) {
                console.log('ğŸ›¡ï¸ CSP: Blob Workerä½œæˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆTone.jsé–¢é€£ã€æ­£å¸¸å‹•ä½œï¼‰');
            } else if (event.blockedURI.includes('chrome-extension:')) {
                console.log('ğŸ›¡ï¸ CSP: Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ­£å¸¸å‹•ä½œï¼‰');
            } else {
                console.warn('âš ï¸ äºˆæœŸã—ãªã„CSPé•å:', event.blockedURI);
            }
        });
        
        // Tone.jsèª­ã¿è¾¼ã¿ç¢ºèª
        window.addEventListener('load', () => {
            if (typeof Tone === 'undefined') {
                console.error('âŒ Tone.js èª­ã¿è¾¼ã¿å¤±æ•—');
            } else {
                console.log('âœ… Tone.js èª­ã¿è¾¼ã¿æˆåŠŸ:', Tone.version);
                
                // Workerã‚¨ãƒ©ãƒ¼ã§ã‚‚Tone.jsã¯åŸºæœ¬æ©Ÿèƒ½ãŒä½¿ãˆã‚‹
                console.log('ğŸµ Tone.jsåŸºæœ¬æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½ï¼ˆWorkerã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–å¯èƒ½ï¼‰');
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .diagnostic-panel {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .diagnostic-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }
        
        .diagnostic-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .status-ok { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #FF9800; }
        .status-pending { background: #2196F3; }
        
        .error-details {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); color: #81C784; }
        .log-warning { background: rgba(255, 152, 0, 0.2); color: #FFB74D; }
        .log-error { background: rgba(244, 67, 54, 0.2); color: #E57373; }
        .log-info { background: rgba(33, 150, 243, 0.2); color: #64B5F6; }
        
        .file-check-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .file-check-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .hidden-ui {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ”¬ Phase 5 Integration Test - è¨ºæ–­å¼·åŒ–ç‰ˆ</h1>
            <p>è©³ç´°ãªã‚¨ãƒ©ãƒ¼è¨ºæ–­ã¨ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</p>
        </div>
        
        <!-- è¨ºæ–­ãƒ‘ãƒãƒ« -->
        <div class="diagnostic-panel">
            <h3>ğŸ“Š ç’°å¢ƒè¨ºæ–­çµæœ</h3>
            <div id="diagnostic-results">
                <div class="diagnostic-item">
                    <div class="diagnostic-status status-pending"></div>
                    <span>è¨ºæ–­å¾…æ©Ÿä¸­...</span>
                </div>
            </div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="test-controls">
            <button onclick="runFullDiagnostics()">ğŸ” å®Œå…¨è¨ºæ–­å®Ÿè¡Œ</button>
            <button onclick="checkFileExistence()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª</button>
            <button onclick="testModuleImports()">ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testAudioSystem()">ğŸ”Š éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="initializeGame()">ğŸ® ã‚²ãƒ¼ãƒ åˆæœŸåŒ–</button>
            <button onclick="testPhase5Features()">ğŸš€ Phase 5 æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯çµæœ -->
        <div class="diagnostic-panel" id="file-check-panel" style="display: none;">
            <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª</h3>
            <div class="file-check-list" id="file-check-results"></div>
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼è©³ç´° -->
        <div id="error-panel" style="display: none;">
            <h3>âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</h3>
            <div class="error-details" id="error-details"></div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆãƒ­ã‚° -->
        <div class="test-log" id="test-log">
            <div class="log-entry log-info">è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†</div>
        </div>
    </div>
    
    <!-- å¿…é ˆã®ã‚²ãƒ¼ãƒ UIè¦ç´ ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div class="hidden-ui">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <!-- ãƒœã‚¿ãƒ³è¦ç´  -->
        <button id="start-game-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button id="instructions-btn">æ“ä½œæ–¹æ³•</button>
        <button id="back-to-menu-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button id="resume-btn">å†é–‹</button>
        <button id="restart-btn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="quit-btn">çµ‚äº†</button>
        <button id="play-again-btn">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        <button id="main-menu-btn">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button id="settings-btn">è¨­å®š</button>
        <button id="pause-btn">ãƒãƒ¼ã‚º</button>
        <button id="mobile-pause-btn">ãƒ¢ãƒã‚¤ãƒ«ãƒãƒ¼ã‚º</button>
        
        <!-- UIè¦ç´  -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- éŸ³é‡èª¿æ•´ -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- ã‚¹ã‚­ãƒ«é–¢é€£ -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- ä¸­é–“ã‚¨ãƒªã‚¢ -->
        <div class="middle-area">
            <div class="stats-container">
                <div class="stats-bar"></div>
                <div class="health-bar"></div>
                <div class="exp-bar"></div>
            </div>
            <div class="skills-container">
                <div class="skill-icons"></div>
                <div class="skill-numbers"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let game = null;
        const diagnosticResults = {};
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆChromeæ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼ã‚’é™¤å¤–ï¼‰
        window.addEventListener('error', (event) => {
            // Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
            if (event.filename && event.filename.includes('chrome-extension://')) {
                console.log('Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–:', event.filename);
                return;
            }
            
            logError(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`);
            showErrorDetails(event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            // Chromeæ‹¡å¼µæ©Ÿèƒ½ã®Promiseã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
            if (event.reason && event.reason.toString().includes('chrome-extension://')) {
                console.log('Chromeæ‹¡å¼µæ©Ÿèƒ½Promiseã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–:', event.reason);
                return;
            }
            
            logError(`Promiseã‚¨ãƒ©ãƒ¼: ${event.reason}`);
            showErrorDetails(event.reason);
        });
        
        // å®Œå…¨è¨ºæ–­
        window.runFullDiagnostics = async function() {
            logInfo('=== å®Œå…¨è¨ºæ–­é–‹å§‹ ===');
            const results = document.getElementById('diagnostic-results');
            results.innerHTML = '';
            
            // è¨ºæ–­é …ç›®
            const checks = [
                { name: 'ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç¢ºèª', check: () => window.location.protocol !== 'file:' },
                { name: 'Tone.jsèª­ã¿è¾¼ã¿', check: () => typeof Tone !== 'undefined' },
                { name: 'ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œ', check: () => 'noModule' in HTMLScriptElement.prototype },
                { name: 'Web Audio API', check: () => typeof AudioContext !== 'undefined' },
                { name: 'Canvasè¦ç´ ', check: () => document.getElementById('game-canvas') !== null },
                { name: 'å¿…é ˆUIè¦ç´ ', check: () => checkRequiredElements() }
            ];
            
            for (const item of checks) {
                const status = item.check() ? 'ok' : 'error';
                diagnosticResults[item.name] = status;
                
                const div = document.createElement('div');
                div.className = 'diagnostic-item';
                div.innerHTML = `
                    <div class="diagnostic-status status-${status}"></div>
                    <span>${item.name}: ${status === 'ok' ? 'âœ… OK' : 'âŒ NG'}</span>
                `;
                results.appendChild(div);
                
                logInfo(`${item.name}: ${status === 'ok' ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
            }
            
            // è©³ç´°æƒ…å ±
            logInfo(`ç¾åœ¨ã®URL: ${window.location.href}`);
            logInfo(`Tone.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${typeof Tone !== 'undefined' ? Tone.version : 'æœªèª­ã¿è¾¼ã¿'}`);
        };
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
        window.checkFileExistence = async function() {
            logInfo('=== ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª ===');
            document.getElementById('file-check-panel').style.display = 'block';
            const results = document.getElementById('file-check-results');
            results.innerHTML = '';
            
            const files = [
                'game.js',
                'js/systems/phase5-integration-controller.js',
                'js/systems/phase5-safe-integration-layer.js',
                'js/systems/phase5-performance-optimizer.js',
                'js/systems/phase5-edge-case-handler.js',
                'js/systems/phase4-audio-facade.js',
                'js/systems/integrated-audio-manager.js'
            ];
            
            for (const file of files) {
                try {
                    const response = await fetch(`./${file}`, { method: 'HEAD' });
                    const status = response.ok ? 'ok' : 'error';
                    
                    const div = document.createElement('div');
                    div.className = 'file-check-item';
                    div.innerHTML = `
                        <div class="diagnostic-status status-${status}"></div>
                        <span>${file} ${response.ok ? 'âœ…' : `âŒ (${response.status})`}</span>
                    `;
                    results.appendChild(div);
                    
                    logInfo(`${file}: ${response.ok ? 'å­˜åœ¨' : `ä¸åœ¨ (${response.status})`}`);
                } catch (error) {
                    logError(`${file}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                }
            }
        };
        
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        window.testModuleImports = async function() {
            logInfo('=== ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ ===');
            
            const modules = [
                { path: './game.js', name: 'game.js' },
                { path: './js/systems/phase5-integration-controller.js', name: 'Phase5IntegrationController' },
                { path: './js/systems/integrated-audio-manager.js', name: 'IntegratedAudioManager' }
            ];
            
            for (const mod of modules) {
                try {
                    const module = await import(mod.path);
                    logSuccess(`âœ… ${mod.name} ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ`);
                    logInfo(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: ${Object.keys(module).join(', ')}`);
                } catch (error) {
                    logError(`âŒ ${mod.name} ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ${error.message}`);
                    showErrorDetails(error);
                }
            }
        };
        
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        window.testAudioSystem = async function() {
            logInfo('=== éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ ===');
            
            if (typeof Tone === 'undefined') {
                logError('Tone.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                // Tone.jsé–‹å§‹
                await Tone.start();
                logSuccess('âœ… Tone.js AudioContexté–‹å§‹');
                
                // ãƒ†ã‚¹ãƒˆéŸ³å†ç”Ÿ
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n");
                logSuccess('âœ… ãƒ†ã‚¹ãƒˆéŸ³å†ç”ŸæˆåŠŸ');
                
                // AudioContextçŠ¶æ…‹ç¢ºèª
                logInfo(`AudioContextçŠ¶æ…‹: ${Tone.context.state}`);
                logInfo(`ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ: ${Tone.context.sampleRate}`);
                
            } catch (error) {
                logError(`éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showErrorDetails(error);
            }
        };
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        window.initializeGame = async function() {
            logInfo('=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ===');
            
            try {
                const { ZombieSurvival } = await import('./game.js');
                game = new ZombieSurvival();
                logSuccess('âœ… ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ');
                
                await game.init();
                logSuccess('âœ… ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
                
                // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                if (game.audioSystem === null) {
                    await game.initializeAudioSystem();
                    logSuccess('âœ… éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');
                }
                
                // Phase 5ç¢ºèª
                if (game.phase5Integration) {
                    logSuccess('âœ… Phase 5 Integrationæ¤œå‡º');
                    logInfo(`Phase 5ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${game.phase5Integration.initialized ? 'åˆæœŸåŒ–æ¸ˆã¿' : 'æœªåˆæœŸåŒ–'}`);
                } else {
                    logWarning('Phase 5 IntegrationãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                logError(`ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showErrorDetails(error);
            }
        };
        
        // Phase 5æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        window.testPhase5Features = async function() {
            if (!game || !game.phase5Integration) {
                logError('ã‚²ãƒ¼ãƒ ã¾ãŸã¯Phase 5ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            logInfo('=== Phase 5æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===');
            
            const tests = [
                {
                    name: 'ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³',
                    test: () => game.phase5Integration.playPickupSound('health')
                },
                {
                    name: 'ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³',
                    test: () => game.phase5Integration.playLevelUpSound(false)
                },
                {
                    name: 'ã‚³ãƒ³ãƒœéŸ³',
                    test: () => game.phase5Integration.handleComboSound(0, 10)
                },
                {
                    name: 'ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ‡ã‚Šæ›¿ãˆ',
                    test: () => game.phase5Integration.toggleFeature('pickupSounds', true)
                }
            ];
            
            for (const test of tests) {
                try {
                    test.test();
                    logSuccess(`âœ… ${test.name} æˆåŠŸ`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    logError(`âŒ ${test.name} å¤±æ•—: ${error.message}`);
                }
            }
        };
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function checkRequiredElements() {
            const requiredIds = [
                'game-canvas', 'start-game-btn', 'loading-screen',
                'main-menu', 'game-screen', 'master-volume'
            ];
            
            return requiredIds.every(id => document.getElementById(id) !== null);
        }
        
        function showErrorDetails(error) {
            const panel = document.getElementById('error-panel');
            const details = document.getElementById('error-details');
            
            panel.style.display = 'block';
            details.textContent = error.stack || error.toString();
        }
        
        function logInfo(message) {
            addLogEntry('info', message);
        }
        
        function logSuccess(message) {
            addLogEntry('success', message);
        }
        
        function logWarning(message) {
            addLogEntry('warning', message);
        }
        
        function logError(message) {
            addLogEntry('error', message);
        }
        
        function addLogEntry(type, message) {
            const log = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // åˆæœŸè¨ºæ–­
        setTimeout(() => {
            runFullDiagnostics();
        }, 500);
    </script>
</body>
</html>