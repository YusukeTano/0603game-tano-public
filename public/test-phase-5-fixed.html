<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 5 Integration Test - ä¿®æ­£ç‰ˆ</title>
    
    <!-- Tone.js CDN with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    <script>
        // Tone.jsã®èª­ã¿è¾¼ã¿ç¢ºèª
        window.addEventListener('load', () => {
            if (typeof Tone === 'undefined') {
                console.error('âŒ Tone.js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                document.getElementById('phase5-status').innerHTML = 
                    '<span class="status-indicator status-error"></span>Tone.jsèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
            } else {
                console.log('âœ… Tone.js èª­ã¿è¾¼ã¿æˆåŠŸ:', Tone.version);
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .error-messages {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .error-messages.show {
            display: block;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-panel h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-success { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196F3; }
        
        .test-results {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); }
        .log-warning { background: rgba(255, 152, 0, 0.2); }
        .log-error { background: rgba(244, 67, 54, 0.2); }
        .log-info { background: rgba(33, 150, 243, 0.2); }
        
        .debug-info {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸš€ Phase 5 Integration Test - ä¿®æ­£ç‰ˆ</h1>
            <p>ã‚¨ãƒ©ãƒ¼è¨ºæ–­æ©Ÿèƒ½ä»˜ããƒ†ã‚¹ãƒˆç’°å¢ƒ</p>
            <div id="phase5-status">
                <span class="status-indicator status-info"></span>
                åˆæœŸåŒ–å¾…æ©Ÿä¸­...
            </div>
        </div>
        
        <div class="error-messages" id="error-messages">
            <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼æƒ…å ±</h3>
            <div id="error-details"></div>
        </div>
        
        <div class="test-controls">
            <!-- è¨ºæ–­ãƒ„ãƒ¼ãƒ« -->
            <div class="control-panel">
                <h3>ğŸ” è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h3>
                <button onclick="runDiagnostics()">ç’°å¢ƒè¨ºæ–­å®Ÿè¡Œ</button>
                <button onclick="checkDependencies()">ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯</button>
                <button onclick="testBasicAudio()">åŸºæœ¬éŸ³éŸ¿ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="clearErrors()">ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢</button>
            </div>
            
            <!-- åŸºæœ¬åˆ¶å¾¡ -->
            <div class="control-panel">
                <h3>ğŸ® åŸºæœ¬åˆ¶å¾¡</h3>
                <button onclick="initializePhase5()" id="init-btn">Phase 5 åˆæœŸåŒ–</button>
                <button onclick="startSimpleTest()" id="simple-test-btn" disabled>ç°¡æ˜“ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="startFullTest()" id="full-test-btn" disabled>å®Œå…¨ãƒ†ã‚¹ãƒˆ</button>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
        <div class="debug-info" id="debug-info">
            <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>
            <div id="debug-content">å¾…æ©Ÿä¸­...</div>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆçµæœ -->
        <div class="test-results">
            <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div class="test-log" id="test-log">
                <div class="log-entry log-info">ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆç’°å¢ƒèµ·å‹•</div>
            </div>
        </div>
    </div>
    
    <!-- å¿…é ˆã®ã‚²ãƒ¼ãƒ UIè¦ç´ ï¼ˆè¡¨ç¤ºçŠ¶æ…‹ï¼‰ -->
    <div style="position: absolute; left: -9999px;">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <!-- ãƒœã‚¿ãƒ³è¦ç´  -->
        <button id="start-game-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button id="instructions-btn">æ“ä½œæ–¹æ³•</button>
        <button id="back-to-menu-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button id="resume-btn">å†é–‹</button>
        <button id="restart-btn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="quit-btn">çµ‚äº†</button>
        <button id="play-again-btn">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        <button id="main-menu-btn">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button id="settings-btn">è¨­å®š</button>
        
        <!-- UIè¦ç´  -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- éŸ³é‡èª¿æ•´ -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- ã‚¹ã‚­ãƒ«é–¢é€£ -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- ä¸­é–“ã‚¨ãƒªã‚¢ -->
        <div class="middle-area">
            <div class="stats-container"></div>
            <div class="skills-container"></div>
        </div>
    </div>
    
    <script type="module">
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            showError(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå‡¦ç†ã®Promiseã‚¨ãƒ©ãƒ¼:', event.reason);
            showError(`Promiseã‚¨ãƒ©ãƒ¼: ${event.reason}`);
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let game = null;
        let errors = [];
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errors.push(message);
            const errorDiv = document.getElementById('error-messages');
            const errorDetails = document.getElementById('error-details');
            
            errorDiv.classList.add('show');
            errorDetails.innerHTML = errors.map((err, i) => 
                `<div>${i + 1}. ${err}</div>`
            ).join('');
            
            logMessage('error', message);
        }
        
        // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
        window.clearErrors = function() {
            errors = [];
            document.getElementById('error-messages').classList.remove('show');
            logMessage('info', 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        };
        
        // ç’°å¢ƒè¨ºæ–­
        window.runDiagnostics = async function() {
            logMessage('info', '=== ç’°å¢ƒè¨ºæ–­é–‹å§‹ ===');
            
            const diagnostics = {
                browser: navigator.userAgent,
                protocol: window.location.protocol,
                host: window.location.host,
                toneJs: typeof Tone !== 'undefined',
                audioContext: typeof AudioContext !== 'undefined',
                modules: 'noModule' in HTMLScriptElement.prototype
            };
            
            updateDebugInfo(diagnostics);
            
            // è¨ºæ–­çµæœ
            if (diagnostics.protocol === 'file:') {
                showError('file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚HTTPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
            }
            
            if (!diagnostics.toneJs) {
                showError('Tone.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
            
            if (!diagnostics.modules) {
                showError('ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
            }
            
            logMessage('success', 'ç’°å¢ƒè¨ºæ–­å®Œäº†');
        };
        
        // ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        window.checkDependencies = async function() {
            logMessage('info', 'ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
            
            try {
                // game.js ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
                const gameModule = await import('./game.js');
                logMessage('success', 'âœ… game.js ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                
                // å¿…è¦ãªã‚¯ãƒ©ã‚¹ã®ç¢ºèª
                if (gameModule.ZombieSurvival) {
                    logMessage('success', 'âœ… ZombieSurvival ã‚¯ãƒ©ã‚¹ç¢ºèª');
                } else {
                    showError('ZombieSurvival ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                showError(`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // åŸºæœ¬éŸ³éŸ¿ãƒ†ã‚¹ãƒˆ
        window.testBasicAudio = async function() {
            logMessage('info', 'åŸºæœ¬éŸ³éŸ¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            if (typeof Tone === 'undefined') {
                showError('Tone.js ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            try {
                // AudioContexté–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å¾Œï¼‰
                await Tone.start();
                logMessage('success', 'âœ… Tone.js AudioContext é–‹å§‹');
                
                // ç°¡å˜ãªéŸ³ã‚’å†ç”Ÿ
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n");
                logMessage('success', 'âœ… ãƒ†ã‚¹ãƒˆéŸ³å†ç”ŸæˆåŠŸ');
                
            } catch (error) {
                showError(`éŸ³éŸ¿ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // Phase 5 åˆæœŸåŒ–
        window.initializePhase5 = async function() {
            logMessage('info', 'Phase 5 åˆæœŸåŒ–é–‹å§‹...');
            updateStatus('info', 'åˆæœŸåŒ–ä¸­...');
            
            try {
                // game.js ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                const { ZombieSurvival } = await import('./game.js');
                
                // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                game = new ZombieSurvival();
                logMessage('success', 'âœ… ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ');
                
                // åˆæœŸåŒ–
                await game.init();
                logMessage('success', 'âœ… ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
                
                // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å¾Œï¼‰
                if (game.audioSystem === null) {
                    await game.initializeAudioSystem();
                    logMessage('success', 'âœ… éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');
                }
                
                // Phase 5 ç¢ºèª
                if (game.phase5Integration) {
                    updateStatus('success', 'Phase 5 æº–å‚™å®Œäº†');
                    document.getElementById('simple-test-btn').disabled = false;
                    document.getElementById('full-test-btn').disabled = false;
                    logMessage('success', 'âœ… Phase 5 Integration æœ‰åŠ¹');
                } else {
                    showError('Phase 5 Integration ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                showError(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('error', 'åˆæœŸåŒ–å¤±æ•—');
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        };
        
        // ç°¡æ˜“ãƒ†ã‚¹ãƒˆ
        window.startSimpleTest = async function() {
            if (!game || !game.phase5Integration) {
                showError('Phase 5ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            logMessage('info', '=== ç°¡æ˜“ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                // åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                game.phase5Integration.playPickupSound('health');
                logMessage('success', 'âœ… ã‚¢ã‚¤ãƒ†ãƒ éŸ³å†ç”Ÿ');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                game.phase5Integration.playLevelUpSound(false);
                logMessage('success', 'âœ… ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³å†ç”Ÿ');
                
                logMessage('success', 'ç°¡æ˜“ãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                showError(`ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // UIæ›´æ–°é–¢æ•°
        function updateStatus(type, message) {
            const statusElement = document.getElementById('phase5-status');
            statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${message}`;
        }
        
        function logMessage(type, message) {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateDebugInfo(info) {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = Object.entries(info).map(([key, value]) => 
                `${key}: ${value}`
            ).join('<br>');
        }
        
        // åˆæœŸè¨ºæ–­
        window.addEventListener('load', () => {
            setTimeout(() => {
                runDiagnostics();
            }, 100);
        });
    </script>
</body>
</html>