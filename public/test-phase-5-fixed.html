<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 5 Integration Test - 修正版</title>
    
    <!-- Tone.js CDN with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    <script>
        // Tone.jsの読み込み確認
        window.addEventListener('load', () => {
            if (typeof Tone === 'undefined') {
                console.error('❌ Tone.js の読み込みに失敗しました');
                document.getElementById('phase5-status').innerHTML = 
                    '<span class="status-indicator status-error"></span>Tone.js読み込みエラー';
            } else {
                console.log('✅ Tone.js 読み込み成功:', Tone.version);
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .error-messages {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .error-messages.show {
            display: block;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-panel h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-success { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196F3; }
        
        .test-results {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); }
        .log-warning { background: rgba(255, 152, 0, 0.2); }
        .log-error { background: rgba(244, 67, 54, 0.2); }
        .log-info { background: rgba(33, 150, 243, 0.2); }
        
        .debug-info {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🚀 Phase 5 Integration Test - 修正版</h1>
            <p>エラー診断機能付きテスト環境</p>
            <div id="phase5-status">
                <span class="status-indicator status-info"></span>
                初期化待機中...
            </div>
        </div>
        
        <div class="error-messages" id="error-messages">
            <h3>⚠️ エラー情報</h3>
            <div id="error-details"></div>
        </div>
        
        <div class="test-controls">
            <!-- 診断ツール -->
            <div class="control-panel">
                <h3>🔍 診断ツール</h3>
                <button onclick="runDiagnostics()">環境診断実行</button>
                <button onclick="checkDependencies()">依存関係チェック</button>
                <button onclick="testBasicAudio()">基本音響テスト</button>
                <button onclick="clearErrors()">エラークリア</button>
            </div>
            
            <!-- 基本制御 -->
            <div class="control-panel">
                <h3>🎮 基本制御</h3>
                <button onclick="initializePhase5()" id="init-btn">Phase 5 初期化</button>
                <button onclick="startSimpleTest()" id="simple-test-btn" disabled>簡易テスト</button>
                <button onclick="startFullTest()" id="full-test-btn" disabled>完全テスト</button>
            </div>
        </div>
        
        <!-- デバッグ情報 -->
        <div class="debug-info" id="debug-info">
            <strong>デバッグ情報:</strong>
            <div id="debug-content">待機中...</div>
        </div>
        
        <!-- テスト結果 -->
        <div class="test-results">
            <h3>📊 テスト結果</h3>
            <div class="test-log" id="test-log">
                <div class="log-entry log-info">修正版テスト環境起動</div>
            </div>
        </div>
    </div>
    
    <!-- 必須のゲームUI要素（表示状態） -->
    <div style="position: absolute; left: -9999px;">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <!-- ボタン要素 -->
        <button id="start-game-btn">ゲーム開始</button>
        <button id="instructions-btn">操作方法</button>
        <button id="back-to-menu-btn">メニューに戻る</button>
        <button id="resume-btn">再開</button>
        <button id="restart-btn">リスタート</button>
        <button id="quit-btn">終了</button>
        <button id="play-again-btn">もう一度プレイ</button>
        <button id="main-menu-btn">メインメニュー</button>
        <button id="settings-btn">設定</button>
        
        <!-- UI要素 -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- 音量調整 -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ゲーム情報表示 -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- スキル関連 -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- 中間エリア -->
        <div class="middle-area">
            <div class="stats-container"></div>
            <div class="skills-container"></div>
        </div>
    </div>
    
    <script type="module">
        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('グローバルエラー:', event.error);
            showError(`グローバルエラー: ${event.error?.message || event.message}`);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('未処理のPromiseエラー:', event.reason);
            showError(`Promiseエラー: ${event.reason}`);
        });
        
        // グローバル変数
        let game = null;
        let errors = [];
        
        // エラー表示
        function showError(message) {
            errors.push(message);
            const errorDiv = document.getElementById('error-messages');
            const errorDetails = document.getElementById('error-details');
            
            errorDiv.classList.add('show');
            errorDetails.innerHTML = errors.map((err, i) => 
                `<div>${i + 1}. ${err}</div>`
            ).join('');
            
            logMessage('error', message);
        }
        
        // エラークリア
        window.clearErrors = function() {
            errors = [];
            document.getElementById('error-messages').classList.remove('show');
            logMessage('info', 'エラーログをクリアしました');
        };
        
        // 環境診断
        window.runDiagnostics = async function() {
            logMessage('info', '=== 環境診断開始 ===');
            
            const diagnostics = {
                browser: navigator.userAgent,
                protocol: window.location.protocol,
                host: window.location.host,
                toneJs: typeof Tone !== 'undefined',
                audioContext: typeof AudioContext !== 'undefined',
                modules: 'noModule' in HTMLScriptElement.prototype
            };
            
            updateDebugInfo(diagnostics);
            
            // 診断結果
            if (diagnostics.protocol === 'file:') {
                showError('file:// プロトコルでは動作しません。HTTPサーバーを使用してください。');
            }
            
            if (!diagnostics.toneJs) {
                showError('Tone.js が読み込まれていません。ネットワーク接続を確認してください。');
            }
            
            if (!diagnostics.modules) {
                showError('ES6モジュールがサポートされていません。最新のブラウザを使用してください。');
            }
            
            logMessage('success', '環境診断完了');
        };
        
        // 依存関係チェック
        window.checkDependencies = async function() {
            logMessage('info', '依存関係チェック開始...');
            
            try {
                // game.js のインポートテスト
                const gameModule = await import('./game.js');
                logMessage('success', '✅ game.js モジュール読み込み成功');
                
                // 必要なクラスの確認
                if (gameModule.ZombieSurvival) {
                    logMessage('success', '✅ ZombieSurvival クラス確認');
                } else {
                    showError('ZombieSurvival クラスが見つかりません');
                }
                
            } catch (error) {
                showError(`モジュール読み込みエラー: ${error.message}`);
            }
        };
        
        // 基本音響テスト
        window.testBasicAudio = async function() {
            logMessage('info', '基本音響テスト開始...');
            
            if (typeof Tone === 'undefined') {
                showError('Tone.js が利用できません');
                return;
            }
            
            try {
                // AudioContext開始（ユーザージェスチャー後）
                await Tone.start();
                logMessage('success', '✅ Tone.js AudioContext 開始');
                
                // 簡単な音を再生
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n");
                logMessage('success', '✅ テスト音再生成功');
                
            } catch (error) {
                showError(`音響テストエラー: ${error.message}`);
            }
        };
        
        // Phase 5 初期化
        window.initializePhase5 = async function() {
            logMessage('info', 'Phase 5 初期化開始...');
            updateStatus('info', '初期化中...');
            
            try {
                // game.js インポート
                const { ZombieSurvival } = await import('./game.js');
                
                // ゲームインスタンス作成
                game = new ZombieSurvival();
                logMessage('success', '✅ ゲームインスタンス作成');
                
                // 初期化
                await game.init();
                logMessage('success', '✅ ゲーム初期化完了');
                
                // 音響システム初期化（ユーザージェスチャー後）
                if (game.audioSystem === null) {
                    await game.initializeAudioSystem();
                    logMessage('success', '✅ 音響システム初期化');
                }
                
                // Phase 5 確認
                if (game.phase5Integration) {
                    updateStatus('success', 'Phase 5 準備完了');
                    document.getElementById('simple-test-btn').disabled = false;
                    document.getElementById('full-test-btn').disabled = false;
                    logMessage('success', '✅ Phase 5 Integration 有効');
                } else {
                    showError('Phase 5 Integration が見つかりません');
                }
                
            } catch (error) {
                showError(`初期化エラー: ${error.message}`);
                updateStatus('error', '初期化失敗');
                console.error('初期化エラー詳細:', error);
            }
        };
        
        // 簡易テスト
        window.startSimpleTest = async function() {
            if (!game || !game.phase5Integration) {
                showError('Phase 5が初期化されていません');
                return;
            }
            
            logMessage('info', '=== 簡易テスト開始 ===');
            
            try {
                // 基本機能テスト
                game.phase5Integration.playPickupSound('health');
                logMessage('success', '✅ アイテム音再生');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                game.phase5Integration.playLevelUpSound(false);
                logMessage('success', '✅ レベルアップ音再生');
                
                logMessage('success', '簡易テスト完了');
                
            } catch (error) {
                showError(`テストエラー: ${error.message}`);
            }
        };
        
        // UI更新関数
        function updateStatus(type, message) {
            const statusElement = document.getElementById('phase5-status');
            statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${message}`;
        }
        
        function logMessage(type, message) {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateDebugInfo(info) {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = Object.entries(info).map(([key, value]) => 
                `${key}: ${value}`
            ).join('<br>');
        }
        
        // 初期診断
        window.addEventListener('load', () => {
            setTimeout(() => {
                runDiagnostics();
            }, 100);
        });
    </script>
</body>
</html>