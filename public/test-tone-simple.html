<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone.js ç°¡å˜ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        
        button {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background: #0066cc;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #0088ff;
        }
        
        .status {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .success { color: #00ff88; }
        .error { color: #ff4444; }
        .info { color: #00ccff; }
    </style>
    
    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>
    <h1>ğŸµ Tone.js ç°¡å˜ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="status" id="status">
        ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...
    </div>
    
    <button onclick="initializeSystem()">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
    <button onclick="testBasicSounds()">åŸºæœ¬éŸ³ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testGameSounds()">ã‚²ãƒ¼ãƒ éŸ³ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
    
    <script type="module">
        import { ToneAudioSystem } from './js/systems/audio-system.js';
        
        let audioSystem = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            status.scrollTop = status.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function initializeSystem() {
            log('Tone.js Audio Systemã‚’åˆæœŸåŒ–ä¸­...', 'info');
            
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§éŸ³éŸ¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’é–‹å§‹
                if (typeof Tone !== 'undefined') {
                    await Tone.start();
                    log('Tone.jsã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé–‹å§‹æˆåŠŸ', 'success');
                } else {
                    throw new Error('Tone.js not loaded');
                }
                
                audioSystem = new ToneAudioSystem({ audioSystem: null });
                await audioSystem.initAudio();
                
                if (audioSystem.isInitialized) {
                    log('ToneAudioSystemåˆæœŸåŒ–æˆåŠŸ', 'success');
                    log(`ãƒ¢ãƒ¼ãƒ‰: ${audioSystem.isToneReady ? 'Tone.js' : 'Fallback'}`, 'info');
                    log(`ã‚·ãƒ³ã‚»æ•°: ${Object.keys(audioSystem.toneSynths).length}`, 'info');
                    log(`åŠ¹æœéŸ³æ•°: ${Object.keys(audioSystem.sounds).length}`, 'info');
                } else {
                    throw new Error('System initialization failed');
                }
                
            } catch (error) {
                log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function testBasicSounds() {
            if (!audioSystem) {
                log('å…ˆã«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            log('åŸºæœ¬éŸ³ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            const sounds = ['shoot', 'enemyKill', 'pickup', 'levelUp'];
            let index = 0;
            
            function playNext() {
                if (index < sounds.length) {
                    const soundName = sounds[index];
                    log(`${soundName} å†ç”Ÿä¸­...`, 'info');
                    
                    if (audioSystem.sounds[soundName]) {
                        audioSystem.sounds[soundName]();
                    } else {
                        log(`${soundName} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    }
                    
                    index++;
                    setTimeout(playNext, 1000);
                } else {
                    log('åŸºæœ¬éŸ³ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                }
            }
            
            playNext();
        }
        
        function testGameSounds() {
            if (!audioSystem) {
                log('å…ˆã«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            log('ã‚²ãƒ¼ãƒ éŸ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...', 'info');
            
            // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            let step = 0;
            const gameSequence = [
                { sound: 'shoot', message: 'å°„æ’ƒéŸ³' },
                { sound: 'enemyKill', message: 'æ•µæ’ƒç ´éŸ³' },
                { sound: 'pickup', message: 'ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³' },
                { sound: 'shoot', message: 'å°„æ’ƒéŸ³ (é€£ç¶š)' },
                { sound: 'shoot', message: 'å°„æ’ƒéŸ³ (é€£ç¶š)' },
                { sound: 'damage', message: 'ãƒ€ãƒ¡ãƒ¼ã‚¸éŸ³' },
                { sound: 'pickupHealth', message: 'ãƒ˜ãƒ«ã‚¹å›å¾©éŸ³' },
                { sound: 'levelUp', message: 'ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³' }
            ];
            
            function playSequence() {
                if (step < gameSequence.length) {
                    const { sound, message } = gameSequence[step];
                    log(`${message} (${sound})`, 'info');
                    
                    if (audioSystem.sounds[sound]) {
                        audioSystem.sounds[sound]();
                    }
                    
                    step++;
                    setTimeout(playSequence, 800);
                } else {
                    log('ã‚²ãƒ¼ãƒ éŸ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                }
            }
            
            playSequence();
        }
        
        function testPerformance() {
            if (!audioSystem) {
                log('å…ˆã«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            const iterations = 20;
            const times = [];
            let completed = 0;
            
            function performTest() {
                const startTime = performance.now();
                
                audioSystem.sounds.shoot();
                
                const endTime = performance.now();
                times.push(endTime - startTime);
                completed++;
                
                if (completed < iterations) {
                    setTimeout(performTest, 100);
                } else {
                    // çµæœè¨ˆç®—
                    const avg = times.reduce((a, b) => a + b, 0) / times.length;
                    const min = Math.min(...times);
                    const max = Math.max(...times);
                    
                    log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ:', 'success');
                    log(`å¹³å‡å†ç”Ÿæ™‚é–“: ${avg.toFixed(2)}ms`, 'info');
                    log(`æœ€å°å†ç”Ÿæ™‚é–“: ${min.toFixed(2)}ms`, 'info');
                    log(`æœ€å¤§å†ç”Ÿæ™‚é–“: ${max.toFixed(2)}ms`, 'info');
                    
                    // ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚‚è¡¨ç¤º
                    if (audioSystem.getPerformanceStats) {
                        const stats = audioSystem.getPerformanceStats();
                        log(`ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ:`, 'info');
                        log(`- åˆæœŸåŒ–æ™‚é–“: ${stats.initTime.toFixed(2)}ms`, 'info');
                        log(`- å¹³å‡å†ç”Ÿæ™‚é–“: ${stats.avgPlayTime.toFixed(2)}ms`, 'info');
                        log(`- å†ç”Ÿå›æ•°: ${stats.playCount}`, 'info');
                        log(`- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: ${stats.fallbackMode}`, 'info');
                    }
                }
            }
            
            performTest();
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.initializeSystem = initializeSystem;
        window.testBasicSounds = testBasicSounds;
        window.testGameSounds = testGameSounds;
        window.testPerformance = testPerformance;
        
        log('Tone.js ç°¡å˜ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†', 'success');
        log('ã€Œã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>