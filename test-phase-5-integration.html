<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 5 Integration - 包括的実ゲームテスト</title>
    
    <!-- Tone.js CDN (必須依存ライブラリ) -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-panel h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-success { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196F3; }
        
        .test-results {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); }
        .log-warning { background: rgba(255, 152, 0, 0.2); }
        .log-error { background: rgba(244, 67, 54, 0.2); }
        .log-info { background: rgba(33, 150, 243, 0.2); }
        
        .metrics-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .metric-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #666;
            border-radius: 25px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        
        .toggle-switch.active .toggle-knob {
            left: 27px;
        }
        
        .game-canvas {
            display: none; /* メインゲームは非表示 */
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🚀 Phase 5 Integration Test</h1>
            <p>音響システム Phase 5 完全統合テスト環境</p>
            <div id="phase5-status">
                <span class="status-indicator status-info"></span>
                初期化中...
            </div>
        </div>
        
        <div class="test-controls">
            <!-- 基本制御 -->
            <div class="control-panel">
                <h3>🎮 基本制御</h3>
                <button onclick="initializePhase5()">Phase 5 初期化</button>
                <button onclick="startComprehensiveTest()">包括テスト開始</button>
                <button onclick="generateTestReport()">レポート生成</button>
                <button onclick="simulateGameSession()">ゲームセッション模擬</button>
            </div>
            
            <!-- フィーチャー制御 -->
            <div class="control-panel">
                <h3>🎯 フィーチャー制御</h3>
                <div class="feature-toggle">
                    <span>アイテム取得音</span>
                    <div class="toggle-switch" onclick="toggleFeature('pickupSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>レベルアップ音</span>
                    <div class="toggle-switch" onclick="toggleFeature('levelUpSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>コンボ音響</span>
                    <div class="toggle-switch" onclick="toggleFeature('comboSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>環境音</span>
                    <div class="toggle-switch" onclick="toggleFeature('environmentSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>
            
            <!-- パフォーマンステスト -->
            <div class="control-panel">
                <h3>⚡ パフォーマンステスト</h3>
                <button onclick="stressTestAudio()">音響ストレステスト</button>
                <button onclick="memoryPressureTest()">メモリ圧迫テスト</button>
                <button onclick="concurrencyTest()">同時再生テスト</button>
                <button onclick="performanceOptimizationTest()">最適化テスト</button>
            </div>
            
            <!-- エッジケーステスト -->
            <div class="control-panel">
                <h3>🛡️ エッジケーステスト</h3>
                <button onclick="simulateNetworkFailure()">ネットワーク切断模擬</button>
                <button onclick="simulateMemoryPressure()">メモリ不足模擬</button>
                <button onclick="simulateTabVisibility()">タブ切り替え模擬</button>
                <button onclick="simulateAudioContextSuspend()">AudioContext停止模擬</button>
            </div>
        </div>
        
        <!-- メトリクス表示 -->
        <div class="metrics-display" id="metrics-display">
            <!-- 動的に生成 -->
        </div>
        
        <!-- テスト結果 -->
        <div class="test-results">
            <h3>📊 テスト結果</h3>
            <div class="test-log" id="test-log">
                <div class="log-entry log-info">Phase 5 Integration Test 環境準備完了</div>
            </div>
        </div>
    </div>
    
    <!-- ゲーム用UI要素（非表示・テスト用） -->
    <div style="display: none;">
        <!-- 必須ボタン要素 -->
        <button id="start-game-btn">ゲーム開始</button>
        <button id="instructions-btn">操作方法</button>
        <button id="back-to-menu-btn">メニューに戻る</button>
        <button id="resume-btn">再開</button>
        <button id="restart-btn">リスタート</button>
        <button id="quit-btn">終了</button>
        <button id="play-again-btn">もう一度プレイ</button>
        <button id="main-menu-btn">メインメニュー</button>
        <button id="settings-btn">設定</button>
        
        <!-- 必須UI要素 -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- 音量調整 -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ゲーム情報表示 -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- スキル関連 -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- 中間エリア（UISystem用） -->
        <div class="middle-area">
            <div class="stats-container"></div>
            <div class="skills-container"></div>
        </div>
    </div>
    
    <!-- ゲームキャンバス（非表示） -->
    <canvas id="game-canvas" class="game-canvas" width="1280" height="720"></canvas>
    
    <script type="module">
        import { ZombieSurvival } from './public/game.js';
        
        // グローバル変数
        let game = null;
        let testMetrics = {
            testsRun: 0,
            testsPassed: 0,
            testsFailed: 0,
            averageFrameTime: 0,
            memoryUsage: 0,
            audioLatency: 0
        };
        
        // ゲーム初期化
        async function initializeGame() {
            try {
                game = new ZombieSurvival();
                await game.init();
                updateStatus('success', 'ゲーム初期化完了');
                return true;
            } catch (error) {
                updateStatus('error', `ゲーム初期化失敗: ${error.message}`);
                return false;
            }
        }
        
        // Phase 5 初期化
        window.initializePhase5 = async function() {
            logMessage('info', 'Phase 5 初期化開始...');
            
            if (!game) {
                const gameReady = await initializeGame();
                if (!gameReady) return;
            }
            
            // ユーザーインタラクション後の音響初期化
            if (game.audioSystem === null) {
                await game.initializeAudioSystem();
            }
            
            // Phase 5 Integration の確認
            if (game.phase5Integration) {
                updateStatus('success', 'Phase 5 統合システム有効');
                logMessage('success', 'Phase 5 Integration 検出完了');
                updateMetricsDisplay();
            } else {
                updateStatus('warning', 'Phase 5 統合システム未検出');
                logMessage('warning', 'Phase 5 Integration が初期化されていません');
            }
        };
        
        // 包括テスト開始
        window.startComprehensiveTest = async function() {
            logMessage('info', '=== 包括テスト開始 ===');
            
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 が初期化されていません');
                return;
            }
            
            testMetrics.testsRun = 0;
            testMetrics.testsPassed = 0;
            testMetrics.testsFailed = 0;
            
            // テストシーケンス実行
            await runTestSequence([
                () => testBasicIntegration(),
                () => testAudioFeatures(),
                () => testPerformanceOptimization(),
                () => testEdgeCases(),
                () => testSystemStability()
            ]);
            
            logMessage('info', `=== テスト完了 (${testMetrics.testsPassed}/${testMetrics.testsRun} 成功) ===`);
            updateMetricsDisplay();
        };
        
        // テストシーケンス実行
        async function runTestSequence(tests) {
            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 500)); // 0.5秒待機
                } catch (error) {
                    logMessage('error', `テスト実行エラー: ${error.message}`);
                }
            }
        }
        
        // 基本統合テスト
        async function testBasicIntegration() {
            logMessage('info', '--- 基本統合テスト ---');
            
            // Phase 5 コンポーネント存在確認
            runTest('Phase5IntegrationController存在確認', () => {
                return !!game.phase5Integration;
            });
            
            // SafeIntegrationLayer存在確認
            runTest('SafeIntegrationLayer存在確認', () => {
                return !!game.phase5Integration.safeIntegrationLayer;
            });
            
            // AudioFacade存在確認
            runTest('AudioFacade存在確認', () => {
                return !!game.phase5Integration.audioFacade;
            });
            
            // 統合レポート取得テスト
            runTest('統合レポート取得', () => {
                const report = game.phase5Integration.getIntegrationReport();
                return report && report.phase5Status;
            });
        }
        
        // 音響フィーチャーテスト
        async function testAudioFeatures() {
            logMessage('info', '--- 音響フィーチャーテスト ---');
            
            // アイテム取得音テスト
            runTest('アイテム取得音再生', () => {
                game.phase5Integration.playPickupSound('health');
                return true;
            });
            
            // レベルアップ音テスト
            runTest('レベルアップ音再生', () => {
                game.phase5Integration.playLevelUpSound(false);
                return true;
            });
            
            // コンボ音テスト
            runTest('コンボ音再生', () => {
                game.phase5Integration.handleComboSound(0, 10);
                return true;
            });
            
            // フィーチャー切り替えテスト
            runTest('フィーチャー切り替え', () => {
                const result1 = game.phase5Integration.toggleFeature('pickupSounds', true);
                const result2 = game.phase5Integration.toggleFeature('pickupSounds', false);
                return result1 && result2;
            });
        }
        
        // パフォーマンス最適化テスト
        async function testPerformanceOptimization() {
            logMessage('info', '--- パフォーマンス最適化テスト ---');
            
            // メトリクス収集テスト
            runTest('パフォーマンスメトリクス収集', () => {
                // 模擬的なパフォーマンステスト
                const startTime = performance.now();
                
                // 複数の音響処理を同時実行
                for (let i = 0; i < 10; i++) {
                    game.phase5Integration.playPickupSound('experience');
                }
                
                const endTime = performance.now();
                testMetrics.averageFrameTime = endTime - startTime;
                
                return testMetrics.averageFrameTime < 50; // 50ms以下なら成功
            });
            
            // メモリ使用量テスト
            runTest('メモリ使用量チェック', () => {
                if (performance.memory) {
                    const usage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
                    testMetrics.memoryUsage = usage;
                    return usage < 0.8; // 80%以下なら成功
                }
                return true; // メモリAPIが利用できない場合は成功とする
            });
        }
        
        // エッジケーステスト
        async function testEdgeCases() {
            logMessage('info', '--- エッジケーステスト ---');
            
            // エラーハンドリングテスト
            runTest('エラーハンドリング', () => {
                try {
                    game.phase5Integration.safeIntegrationLayer.safeAudioCall('nonExistentMethod');
                    return true; // エラーが発生しても安全に処理される
                } catch (error) {
                    return false; // 例外が発生した場合は失敗
                }
            });
            
            // ロールバック機能テスト
            runTest('ロールバック機能', () => {
                const beforeState = game.audioSystem;
                
                // 意図的にエラーを発生させてロールバックをトリガー
                for (let i = 0; i < 10; i++) {
                    game.phase5Integration.safeIntegrationLayer.handleAudioError(
                        new Error('テストエラー'), 'testMethod', []
                    );
                }
                
                return !!beforeState; // システムが生存していれば成功
            });
        }
        
        // システム安定性テスト
        async function testSystemStability() {
            logMessage('info', '--- システム安定性テスト ---');
            
            // 長時間実行テスト
            runTest('連続実行安定性', async () => {
                for (let i = 0; i < 100; i++) {
                    game.phase5Integration.update(16.67); // 60fps相当
                    
                    if (i % 20 === 0) {
                        // 20回ごとに音響再生
                        game.phase5Integration.playPickupSound('speed');
                    }
                    
                    // 適度な待機
                    if (i % 50 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                return true;
            });
            
            // リソースリーク確認
            runTest('リソースリーク確認', () => {
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                // 大量の音響処理を実行
                for (let i = 0; i < 1000; i++) {
                    game.phase5Integration.playPickupSound('experience');
                }
                
                // 強制ガベージコレクション（可能な場合）
                if (window.gc) {
                    window.gc();
                }
                
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const memoryIncrease = finalMemory - initialMemory;
                
                // メモリ増加量が10MB以下なら成功
                return memoryIncrease < 10 * 1024 * 1024;
            });
        }
        
        // テスト実行ヘルパー
        function runTest(testName, testFunction) {
            testMetrics.testsRun++;
            
            try {
                const result = testFunction();
                
                if (result === true || (result && result.then)) {
                    testMetrics.testsPassed++;
                    logMessage('success', `✅ ${testName}: 成功`);
                } else {
                    testMetrics.testsFailed++;
                    logMessage('error', `❌ ${testName}: 失敗`);
                }
            } catch (error) {
                testMetrics.testsFailed++;
                logMessage('error', `❌ ${testName}: エラー - ${error.message}`);
            }
        }
        
        // フィーチャー切り替え
        window.toggleFeature = function(featureName, element) {
            if (!game || !game.phase5Integration) {
                logMessage('warning', 'Phase 5 が初期化されていません');
                return;
            }
            
            const isActive = element.classList.contains('active');
            const newState = !isActive;
            
            const result = game.phase5Integration.toggleFeature(featureName, newState);
            
            if (result) {
                element.classList.toggle('active', newState);
                logMessage('info', `${featureName}: ${newState ? '有効' : '無効'}`);
            } else {
                logMessage('error', `${featureName} の切り替えに失敗`);
            }
        };
        
        // ストレステスト
        window.stressTestAudio = async function() {
            logMessage('info', '音響ストレステスト開始...');
            
            const startTime = performance.now();
            
            // 大量の同時音響再生
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    if (game && game.phase5Integration) {
                        game.phase5Integration.playPickupSound('health');
                    }
                }, i * 10);
            }
            
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                logMessage('success', `ストレステスト完了: ${duration.toFixed(2)}ms`);
            }, 1000);
        };
        
        // メモリ圧迫テスト
        window.memoryPressureTest = function() {
            logMessage('info', 'メモリ圧迫テスト開始...');
            
            // 大量のオブジェクト作成
            const bigArray = [];
            for (let i = 0; i < 100000; i++) {
                bigArray.push(new Array(1000).fill(Math.random()));
            }
            
            logMessage('info', `配列サイズ: ${bigArray.length} 要素`);
            
            // メモリ使用量確認
            if (performance.memory) {
                const usage = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                logMessage('info', `メモリ使用量: ${usage}MB`);
            }
            
            setTimeout(() => {
                // クリーンアップ
                bigArray.length = 0;
                if (window.gc) window.gc();
                logMessage('success', 'メモリ圧迫テスト完了（クリーンアップ済み）');
            }, 2000);
        };
        
        // エッジケース模擬
        window.simulateNetworkFailure = function() {
            logMessage('warning', 'ネットワーク切断を模擬...');
            
            // ネットワークイベントを手動発火
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                logMessage('info', 'ネットワーク再接続を模擬');
            }, 3000);
        };
        
        window.simulateTabVisibility = function() {
            logMessage('info', 'タブ切り替えを模擬...');
            
            // visibilitychange イベントを手動発火
            Object.defineProperty(document, 'hidden', { value: true, writable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            
            setTimeout(() => {
                Object.defineProperty(document, 'hidden', { value: false, writable: true });
                document.dispatchEvent(new Event('visibilitychange'));
                logMessage('info', 'タブ表示復帰を模擬');
            }, 2000);
        };
        
        // レポート生成
        window.generateTestReport = function() {
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 が初期化されていません');
                return;
            }
            
            const integrationReport = game.phase5Integration.getIntegrationReport();
            
            logMessage('info', '=== Phase 5 統合レポート ===');
            logMessage('info', `統合システム: ${integrationReport.phase5Status?.integratedSystems?.join(', ') || 'なし'}`);
            logMessage('info', `稼働時間: ${integrationReport.phase5Status?.uptime || '不明'}`);
            logMessage('info', `音響呼び出し数: ${integrationReport.metrics?.audioCallsCount || 0}`);
            logMessage('info', `エラー率: ${integrationReport.metrics?.errorRate || '0%'}`);
            logMessage('info', `テスト実行数: ${testMetrics.testsRun} (成功: ${testMetrics.testsPassed}, 失敗: ${testMetrics.testsFailed})`);
        };
        
        // ゲームセッション模擬
        window.simulateGameSession = async function() {
            logMessage('info', 'ゲームセッション模擬開始...');
            
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 が初期化されていません');
                return;
            }
            
            // 模擬ゲームプレイシーケンス
            const actions = [
                { action: 'pickup', delay: 500 },
                { action: 'levelup', delay: 1000 },
                { action: 'combo', delay: 300 },
                { action: 'pickup', delay: 200 },
                { action: 'combo', delay: 400 },
                { action: 'levelup', delay: 800 }
            ];
            
            for (const { action, delay } of actions) {
                await new Promise(resolve => setTimeout(resolve, delay));
                
                switch (action) {
                    case 'pickup':
                        game.phase5Integration.playPickupSound('health');
                        logMessage('info', '🎵 アイテム取得音再生');
                        break;
                    case 'levelup':
                        game.phase5Integration.playLevelUpSound(false);
                        logMessage('info', '🎵 レベルアップ音再生');
                        break;
                    case 'combo':
                        game.phase5Integration.handleComboSound(0, Math.floor(Math.random() * 50) + 1);
                        logMessage('info', '🎵 コンボ音再生');
                        break;
                }
            }
            
            logMessage('success', 'ゲームセッション模擬完了');
        };
        
        // UI更新
        function updateStatus(type, message) {
            const statusElement = document.getElementById('phase5-status');
            const indicator = statusElement.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${type}`;
            statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${message}`;
        }
        
        function logMessage(type, message) {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateMetricsDisplay() {
            const metricsDisplay = document.getElementById('metrics-display');
            
            metricsDisplay.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsRun}</div>
                    <div class="metric-label">実行テスト数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsPassed}</div>
                    <div class="metric-label">成功テスト数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsFailed}</div>
                    <div class="metric-label">失敗テスト数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.averageFrameTime.toFixed(1)}ms</div>
                    <div class="metric-label">平均フレーム時間</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(testMetrics.memoryUsage * 100).toFixed(1)}%</div>
                    <div class="metric-label">メモリ使用率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.audioLatency.toFixed(1)}ms</div>
                    <div class="metric-label">音響レイテンシ</div>
                </div>
            `;
        }
        
        // 初期メトリクス表示
        updateMetricsDisplay();
        
        // 定期的なメトリクス更新
        setInterval(() => {
            if (game && game.phase5Integration) {
                updateMetricsDisplay();
            }
        }, 2000);
    </script>
</body>
</html>