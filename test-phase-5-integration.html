<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 5 Integration - åŒ…æ‹¬çš„å®Ÿã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ</title>
    
    <!-- Tone.js CDN (å¿…é ˆä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª) -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-panel h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-success { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196F3; }
        
        .test-results {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success { background: rgba(76, 175, 80, 0.2); }
        .log-warning { background: rgba(255, 152, 0, 0.2); }
        .log-error { background: rgba(244, 67, 54, 0.2); }
        .log-info { background: rgba(33, 150, 243, 0.2); }
        
        .metrics-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .metric-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #666;
            border-radius: 25px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        
        .toggle-switch.active .toggle-knob {
            left: 27px;
        }
        
        .game-canvas {
            display: none; /* ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã¯éè¡¨ç¤º */
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸš€ Phase 5 Integration Test</h1>
            <p>éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ  Phase 5 å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ</p>
            <div id="phase5-status">
                <span class="status-indicator status-info"></span>
                åˆæœŸåŒ–ä¸­...
            </div>
        </div>
        
        <div class="test-controls">
            <!-- åŸºæœ¬åˆ¶å¾¡ -->
            <div class="control-panel">
                <h3>ğŸ® åŸºæœ¬åˆ¶å¾¡</h3>
                <button onclick="initializePhase5()">Phase 5 åˆæœŸåŒ–</button>
                <button onclick="startComprehensiveTest()">åŒ…æ‹¬ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
                <button onclick="generateTestReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                <button onclick="simulateGameSession()">ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨¡æ“¬</button>
            </div>
            
            <!-- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ¶å¾¡ -->
            <div class="control-panel">
                <h3>ğŸ¯ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ¶å¾¡</h3>
                <div class="feature-toggle">
                    <span>ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³</span>
                    <div class="toggle-switch" onclick="toggleFeature('pickupSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³</span>
                    <div class="toggle-switch" onclick="toggleFeature('levelUpSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>ã‚³ãƒ³ãƒœéŸ³éŸ¿</span>
                    <div class="toggle-switch" onclick="toggleFeature('comboSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="feature-toggle">
                    <span>ç’°å¢ƒéŸ³</span>
                    <div class="toggle-switch" onclick="toggleFeature('environmentSounds', this)">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ -->
            <div class="control-panel">
                <h3>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h3>
                <button onclick="stressTestAudio()">éŸ³éŸ¿ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="memoryPressureTest()">ãƒ¡ãƒ¢ãƒªåœ§è¿«ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="concurrencyTest()">åŒæ™‚å†ç”Ÿãƒ†ã‚¹ãƒˆ</button>
                <button onclick="performanceOptimizationTest()">æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ</button>
            </div>
            
            <!-- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ -->
            <div class="control-panel">
                <h3>ğŸ›¡ï¸ ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ</h3>
                <button onclick="simulateNetworkFailure()">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­æ¨¡æ“¬</button>
                <button onclick="simulateMemoryPressure()">ãƒ¡ãƒ¢ãƒªä¸è¶³æ¨¡æ“¬</button>
                <button onclick="simulateTabVisibility()">ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ¨¡æ“¬</button>
                <button onclick="simulateAudioContextSuspend()">AudioContextåœæ­¢æ¨¡æ“¬</button>
            </div>
        </div>
        
        <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º -->
        <div class="metrics-display" id="metrics-display">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆçµæœ -->
        <div class="test-results">
            <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div class="test-log" id="test-log">
                <div class="log-entry log-info">Phase 5 Integration Test ç’°å¢ƒæº–å‚™å®Œäº†</div>
            </div>
        </div>
    </div>
    
    <!-- ã‚²ãƒ¼ãƒ ç”¨UIè¦ç´ ï¼ˆéè¡¨ç¤ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰ -->
    <div style="display: none;">
        <!-- å¿…é ˆãƒœã‚¿ãƒ³è¦ç´  -->
        <button id="start-game-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button id="instructions-btn">æ“ä½œæ–¹æ³•</button>
        <button id="back-to-menu-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button id="resume-btn">å†é–‹</button>
        <button id="restart-btn">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="quit-btn">çµ‚äº†</button>
        <button id="play-again-btn">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        <button id="main-menu-btn">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button id="settings-btn">è¨­å®š</button>
        
        <!-- å¿…é ˆUIè¦ç´  -->
        <div id="loading-screen"></div>
        <div id="main-menu"></div>
        <div id="character-select"></div>
        <div id="game-screen"></div>
        <div id="pause-menu"></div>
        <div id="game-over-screen"></div>
        <div id="mario-mini-game"></div>
        <div id="settings-menu"></div>
        <div id="instructions-menu"></div>
        
        <!-- éŸ³é‡èª¿æ•´ -->
        <input type="range" id="master-volume" min="0" max="100" value="80">
        <input type="range" id="bgm-volume" min="0" max="100" value="30">
        <input type="range" id="sfx-volume" min="0" max="100" value="70">
        
        <!-- ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º -->
        <div id="game-info">
            <div id="stats-wave">Wave: 1</div>
            <div id="stats-score">Score: 0</div>
            <div id="stats-kills">Kills: 0</div>
            <div id="stats-time">Time: 00:00</div>
            <div id="stats-health">Health: 100</div>
        </div>
        
        <!-- ã‚¹ã‚­ãƒ«é–¢é€£ -->
        <div id="skill-selection"></div>
        <div id="skills-display"></div>
        
        <!-- ä¸­é–“ã‚¨ãƒªã‚¢ï¼ˆUISystemç”¨ï¼‰ -->
        <div class="middle-area">
            <div class="stats-container"></div>
            <div class="skills-container"></div>
        </div>
    </div>
    
    <!-- ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <canvas id="game-canvas" class="game-canvas" width="1280" height="720"></canvas>
    
    <script type="module">
        import { ZombieSurvival } from './public/game.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let game = null;
        let testMetrics = {
            testsRun: 0,
            testsPassed: 0,
            testsFailed: 0,
            averageFrameTime: 0,
            memoryUsage: 0,
            audioLatency: 0
        };
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        async function initializeGame() {
            try {
                game = new ZombieSurvival();
                await game.init();
                updateStatus('success', 'ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
                return true;
            } catch (error) {
                updateStatus('error', `ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                return false;
            }
        }
        
        // Phase 5 åˆæœŸåŒ–
        window.initializePhase5 = async function() {
            logMessage('info', 'Phase 5 åˆæœŸåŒ–é–‹å§‹...');
            
            if (!game) {
                const gameReady = await initializeGame();
                if (!gameReady) return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã®éŸ³éŸ¿åˆæœŸåŒ–
            if (game.audioSystem === null) {
                await game.initializeAudioSystem();
            }
            
            // Phase 5 Integration ã®ç¢ºèª
            if (game.phase5Integration) {
                updateStatus('success', 'Phase 5 çµ±åˆã‚·ã‚¹ãƒ†ãƒ æœ‰åŠ¹');
                logMessage('success', 'Phase 5 Integration æ¤œå‡ºå®Œäº†');
                updateMetricsDisplay();
            } else {
                updateStatus('warning', 'Phase 5 çµ±åˆã‚·ã‚¹ãƒ†ãƒ æœªæ¤œå‡º');
                logMessage('warning', 'Phase 5 Integration ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        };
        
        // åŒ…æ‹¬ãƒ†ã‚¹ãƒˆé–‹å§‹
        window.startComprehensiveTest = async function() {
            logMessage('info', '=== åŒ…æ‹¬ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            testMetrics.testsRun = 0;
            testMetrics.testsPassed = 0;
            testMetrics.testsFailed = 0;
            
            // ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Ÿè¡Œ
            await runTestSequence([
                () => testBasicIntegration(),
                () => testAudioFeatures(),
                () => testPerformanceOptimization(),
                () => testEdgeCases(),
                () => testSystemStability()
            ]);
            
            logMessage('info', `=== ãƒ†ã‚¹ãƒˆå®Œäº† (${testMetrics.testsPassed}/${testMetrics.testsRun} æˆåŠŸ) ===`);
            updateMetricsDisplay();
        };
        
        // ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Ÿè¡Œ
        async function runTestSequence(tests) {
            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ç§’å¾…æ©Ÿ
                } catch (error) {
                    logMessage('error', `ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }
        
        // åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆ
        async function testBasicIntegration() {
            logMessage('info', '--- åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆ ---');
            
            // Phase 5 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå­˜åœ¨ç¢ºèª
            runTest('Phase5IntegrationControllerå­˜åœ¨ç¢ºèª', () => {
                return !!game.phase5Integration;
            });
            
            // SafeIntegrationLayerå­˜åœ¨ç¢ºèª
            runTest('SafeIntegrationLayerå­˜åœ¨ç¢ºèª', () => {
                return !!game.phase5Integration.safeIntegrationLayer;
            });
            
            // AudioFacadeå­˜åœ¨ç¢ºèª
            runTest('AudioFacadeå­˜åœ¨ç¢ºèª', () => {
                return !!game.phase5Integration.audioFacade;
            });
            
            // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆå–å¾—ãƒ†ã‚¹ãƒˆ
            runTest('çµ±åˆãƒ¬ãƒãƒ¼ãƒˆå–å¾—', () => {
                const report = game.phase5Integration.getIntegrationReport();
                return report && report.phase5Status;
            });
        }
        
        // éŸ³éŸ¿ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ
        async function testAudioFeatures() {
            logMessage('info', '--- éŸ³éŸ¿ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ ---');
            
            // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³ãƒ†ã‚¹ãƒˆ
            runTest('ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³å†ç”Ÿ', () => {
                game.phase5Integration.playPickupSound('health');
                return true;
            });
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³ãƒ†ã‚¹ãƒˆ
            runTest('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³å†ç”Ÿ', () => {
                game.phase5Integration.playLevelUpSound(false);
                return true;
            });
            
            // ã‚³ãƒ³ãƒœéŸ³ãƒ†ã‚¹ãƒˆ
            runTest('ã‚³ãƒ³ãƒœéŸ³å†ç”Ÿ', () => {
                game.phase5Integration.handleComboSound(0, 10);
                return true;
            });
            
            // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
            runTest('ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ‡ã‚Šæ›¿ãˆ', () => {
                const result1 = game.phase5Integration.toggleFeature('pickupSounds', true);
                const result2 = game.phase5Integration.toggleFeature('pickupSounds', false);
                return result1 && result2;
            });
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ
        async function testPerformanceOptimization() {
            logMessage('info', '--- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ ---');
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆ
            runTest('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†', () => {
                // æ¨¡æ“¬çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
                const startTime = performance.now();
                
                // è¤‡æ•°ã®éŸ³éŸ¿å‡¦ç†ã‚’åŒæ™‚å®Ÿè¡Œ
                for (let i = 0; i < 10; i++) {
                    game.phase5Integration.playPickupSound('experience');
                }
                
                const endTime = performance.now();
                testMetrics.averageFrameTime = endTime - startTime;
                
                return testMetrics.averageFrameTime < 50; // 50msä»¥ä¸‹ãªã‚‰æˆåŠŸ
            });
            
            // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ
            runTest('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯', () => {
                if (performance.memory) {
                    const usage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
                    testMetrics.memoryUsage = usage;
                    return usage < 0.8; // 80%ä»¥ä¸‹ãªã‚‰æˆåŠŸ
                }
                return true; // ãƒ¡ãƒ¢ãƒªAPIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯æˆåŠŸã¨ã™ã‚‹
            });
        }
        
        // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
        async function testEdgeCases() {
            logMessage('info', '--- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ ---');
            
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
            runTest('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', () => {
                try {
                    game.phase5Integration.safeIntegrationLayer.safeAudioCall('nonExistentMethod');
                    return true; // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å®‰å…¨ã«å‡¦ç†ã•ã‚Œã‚‹
                } catch (error) {
                    return false; // ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å¤±æ•—
                }
            });
            
            // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            runTest('ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½', () => {
                const beforeState = game.audioSystem;
                
                // æ„å›³çš„ã«ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼
                for (let i = 0; i < 10; i++) {
                    game.phase5Integration.safeIntegrationLayer.handleAudioError(
                        new Error('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼'), 'testMethod', []
                    );
                }
                
                return !!beforeState; // ã‚·ã‚¹ãƒ†ãƒ ãŒç”Ÿå­˜ã—ã¦ã„ã‚Œã°æˆåŠŸ
            });
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ãƒ†ã‚¹ãƒˆ
        async function testSystemStability() {
            logMessage('info', '--- ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ãƒ†ã‚¹ãƒˆ ---');
            
            // é•·æ™‚é–“å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
            runTest('é€£ç¶šå®Ÿè¡Œå®‰å®šæ€§', async () => {
                for (let i = 0; i < 100; i++) {
                    game.phase5Integration.update(16.67); // 60fpsç›¸å½“
                    
                    if (i % 20 === 0) {
                        // 20å›ã”ã¨ã«éŸ³éŸ¿å†ç”Ÿ
                        game.phase5Integration.playPickupSound('speed');
                    }
                    
                    // é©åº¦ãªå¾…æ©Ÿ
                    if (i % 50 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                return true;
            });
            
            // ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯ç¢ºèª
            runTest('ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯ç¢ºèª', () => {
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                
                // å¤§é‡ã®éŸ³éŸ¿å‡¦ç†ã‚’å®Ÿè¡Œ
                for (let i = 0; i < 1000; i++) {
                    game.phase5Integration.playPickupSound('experience');
                }
                
                // å¼·åˆ¶ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
                if (window.gc) {
                    window.gc();
                }
                
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const memoryIncrease = finalMemory - initialMemory;
                
                // ãƒ¡ãƒ¢ãƒªå¢—åŠ é‡ãŒ10MBä»¥ä¸‹ãªã‚‰æˆåŠŸ
                return memoryIncrease < 10 * 1024 * 1024;
            });
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ˜ãƒ«ãƒ‘ãƒ¼
        function runTest(testName, testFunction) {
            testMetrics.testsRun++;
            
            try {
                const result = testFunction();
                
                if (result === true || (result && result.then)) {
                    testMetrics.testsPassed++;
                    logMessage('success', `âœ… ${testName}: æˆåŠŸ`);
                } else {
                    testMetrics.testsFailed++;
                    logMessage('error', `âŒ ${testName}: å¤±æ•—`);
                }
            } catch (error) {
                testMetrics.testsFailed++;
                logMessage('error', `âŒ ${testName}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        window.toggleFeature = function(featureName, element) {
            if (!game || !game.phase5Integration) {
                logMessage('warning', 'Phase 5 ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const isActive = element.classList.contains('active');
            const newState = !isActive;
            
            const result = game.phase5Integration.toggleFeature(featureName, newState);
            
            if (result) {
                element.classList.toggle('active', newState);
                logMessage('info', `${featureName}: ${newState ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
            } else {
                logMessage('error', `${featureName} ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—`);
            }
        };
        
        // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
        window.stressTestAudio = async function() {
            logMessage('info', 'éŸ³éŸ¿ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            const startTime = performance.now();
            
            // å¤§é‡ã®åŒæ™‚éŸ³éŸ¿å†ç”Ÿ
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    if (game && game.phase5Integration) {
                        game.phase5Integration.playPickupSound('health');
                    }
                }, i * 10);
            }
            
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                logMessage('success', `ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†: ${duration.toFixed(2)}ms`);
            }, 1000);
        };
        
        // ãƒ¡ãƒ¢ãƒªåœ§è¿«ãƒ†ã‚¹ãƒˆ
        window.memoryPressureTest = function() {
            logMessage('info', 'ãƒ¡ãƒ¢ãƒªåœ§è¿«ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            // å¤§é‡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
            const bigArray = [];
            for (let i = 0; i < 100000; i++) {
                bigArray.push(new Array(1000).fill(Math.random()));
            }
            
            logMessage('info', `é…åˆ—ã‚µã‚¤ã‚º: ${bigArray.length} è¦ç´ `);
            
            // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
            if (performance.memory) {
                const usage = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                logMessage('info', `ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ${usage}MB`);
            }
            
            setTimeout(() => {
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                bigArray.length = 0;
                if (window.gc) window.gc();
                logMessage('success', 'ãƒ¡ãƒ¢ãƒªåœ§è¿«ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¸ˆã¿ï¼‰');
            }, 2000);
        };
        
        // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ¨¡æ“¬
        window.simulateNetworkFailure = function() {
            logMessage('warning', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­ã‚’æ¨¡æ“¬...');
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ç™ºç«
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                logMessage('info', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†æ¥ç¶šã‚’æ¨¡æ“¬');
            }, 3000);
        };
        
        window.simulateTabVisibility = function() {
            logMessage('info', 'ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’æ¨¡æ“¬...');
            
            // visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ç™ºç«
            Object.defineProperty(document, 'hidden', { value: true, writable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            
            setTimeout(() => {
                Object.defineProperty(document, 'hidden', { value: false, writable: true });
                document.dispatchEvent(new Event('visibilitychange'));
                logMessage('info', 'ã‚¿ãƒ–è¡¨ç¤ºå¾©å¸°ã‚’æ¨¡æ“¬');
            }, 2000);
        };
        
        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        window.generateTestReport = function() {
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const integrationReport = game.phase5Integration.getIntegrationReport();
            
            logMessage('info', '=== Phase 5 çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ ===');
            logMessage('info', `çµ±åˆã‚·ã‚¹ãƒ†ãƒ : ${integrationReport.phase5Status?.integratedSystems?.join(', ') || 'ãªã—'}`);
            logMessage('info', `ç¨¼åƒæ™‚é–“: ${integrationReport.phase5Status?.uptime || 'ä¸æ˜'}`);
            logMessage('info', `éŸ³éŸ¿å‘¼ã³å‡ºã—æ•°: ${integrationReport.metrics?.audioCallsCount || 0}`);
            logMessage('info', `ã‚¨ãƒ©ãƒ¼ç‡: ${integrationReport.metrics?.errorRate || '0%'}`);
            logMessage('info', `ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ•°: ${testMetrics.testsRun} (æˆåŠŸ: ${testMetrics.testsPassed}, å¤±æ•—: ${testMetrics.testsFailed})`);
        };
        
        // ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨¡æ“¬
        window.simulateGameSession = async function() {
            logMessage('info', 'ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨¡æ“¬é–‹å§‹...');
            
            if (!game || !game.phase5Integration) {
                logMessage('error', 'Phase 5 ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // æ¨¡æ“¬ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
            const actions = [
                { action: 'pickup', delay: 500 },
                { action: 'levelup', delay: 1000 },
                { action: 'combo', delay: 300 },
                { action: 'pickup', delay: 200 },
                { action: 'combo', delay: 400 },
                { action: 'levelup', delay: 800 }
            ];
            
            for (const { action, delay } of actions) {
                await new Promise(resolve => setTimeout(resolve, delay));
                
                switch (action) {
                    case 'pickup':
                        game.phase5Integration.playPickupSound('health');
                        logMessage('info', 'ğŸµ ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³å†ç”Ÿ');
                        break;
                    case 'levelup':
                        game.phase5Integration.playLevelUpSound(false);
                        logMessage('info', 'ğŸµ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³å†ç”Ÿ');
                        break;
                    case 'combo':
                        game.phase5Integration.handleComboSound(0, Math.floor(Math.random() * 50) + 1);
                        logMessage('info', 'ğŸµ ã‚³ãƒ³ãƒœéŸ³å†ç”Ÿ');
                        break;
                }
            }
            
            logMessage('success', 'ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨¡æ“¬å®Œäº†');
        };
        
        // UIæ›´æ–°
        function updateStatus(type, message) {
            const statusElement = document.getElementById('phase5-status');
            const indicator = statusElement.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${type}`;
            statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${message}`;
        }
        
        function logMessage(type, message) {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateMetricsDisplay() {
            const metricsDisplay = document.getElementById('metrics-display');
            
            metricsDisplay.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsRun}</div>
                    <div class="metric-label">å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsPassed}</div>
                    <div class="metric-label">æˆåŠŸãƒ†ã‚¹ãƒˆæ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.testsFailed}</div>
                    <div class="metric-label">å¤±æ•—ãƒ†ã‚¹ãƒˆæ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.averageFrameTime.toFixed(1)}ms</div>
                    <div class="metric-label">å¹³å‡ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚é–“</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${(testMetrics.memoryUsage * 100).toFixed(1)}%</div>
                    <div class="metric-label">ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${testMetrics.audioLatency.toFixed(1)}ms</div>
                    <div class="metric-label">éŸ³éŸ¿ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·</div>
                </div>
            `;
        }
        
        // åˆæœŸãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
        updateMetricsDisplay();
        
        // å®šæœŸçš„ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        setInterval(() => {
            if (game && game.phase5Integration) {
                updateMetricsDisplay();
            }
        }, 2000);
    </script>
</body>
</html>