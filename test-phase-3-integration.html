<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3 Integration Test - çµ±åˆéŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼</title>
    
    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #0f3460;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(15, 52, 96, 0.3);
        }
        
        h1 {
            color: #0f3460;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            border-left: 4px solid #0f3460;
        }
        
        .test-section h3 {
            color: #4ade80;
            margin-top: 0;
        }
        
        button {
            background: #0f3460;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        
        button:hover {
            background: #16437e;
        }
        
        .status {
            font-weight: bold;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
        
        .success { background: #065f46; color: #10b981; }
        .warning { background: #92400e; color: #f59e0b; }
        .error { background: #7f1d1d; color: #ef4444; }
        
        #log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .phase-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .phase-card {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .phase-card h4 {
            margin: 0 0 10px 0;
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¼ Phase 3 Integration Test</h1>
        <p>Phase 3 Managerçµ±åˆéŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿã‚²ãƒ¼ãƒ ç’°å¢ƒãƒ†ã‚¹ãƒˆ</p>
        
        <div class="phase-status">
            <div class="phase-card">
                <h4>Phase 3.1</h4>
                <div class="status" id="phase31-status">æœªãƒ†ã‚¹ãƒˆ</div>
                <div>éŸ³éŸ¿é€£æºç¢ºèª</div>
            </div>
            <div class="phase-card">
                <h4>Phase 3.2</h4>
                <div class="status" id="phase32-status">æœªãƒ†ã‚¹ãƒˆ</div>
                <div>ã‚²ãƒ¼ãƒ çµ±åˆ</div>
            </div>
            <div class="phase-card">
                <h4>Phase 3.3</h4>
                <div class="status" id="phase33-status">æœªãƒ†ã‚¹ãƒˆ</div>
                <div>Managerå±¤çµ±åˆ</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testBasicIntegration()">åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="testAudioSystemAPI()">AudioSystem API ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testPhase3Manager()">Phase3Manager ãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸµ ã‚·ãƒ¼ãƒ³é·ç§»ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testSceneTransition('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚·ãƒ¼ãƒ³</button>
            <button onclick="testSceneTransition('characterSelect')">ã‚­ãƒ£ãƒ©é¸æŠã‚·ãƒ¼ãƒ³</button>
            <button onclick="testSceneTransition('playing')">ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚·ãƒ¼ãƒ³</button>
            <button onclick="testSceneTransition('gameOver')">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¼ãƒ³</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸŒŠ å‹•çš„éŸ³éŸ¿åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testWaveAudio(1)">Wave 1 éŸ³éŸ¿</button>
            <button onclick="testWaveAudio(50)">Wave 50 éŸ³éŸ¿</button>
            <button onclick="testWaveAudio(200)">Wave 200 éŸ³éŸ¿</button>
            <button onclick="testWaveAudio(999)">Wave 999 éŸ³éŸ¿</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ›ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testRealtimeFeedback('shooting')">å°„æ’ƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
            <button onclick="testRealtimeFeedback('damage')">ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
            <button onclick="testRealtimeFeedback('levelUp')">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
            <button onclick="testRealtimeFeedback('enemyDefeat')">æ•µæ’ƒç ´ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”Š éŸ³é‡ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testVolumeControl()">éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testEffectControl()">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testTempoControl()">ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ›¡ï¸ ä¿¡é ¼æ€§ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testReliability()">ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="getDebugInfo()">ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div id="test-results"></div>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let game = null;
        let testResults = {
            phase31: { passed: 0, failed: 0, tests: [] },
            phase32: { passed: 0, failed: 0, tests: [] },
            phase33: { passed: 0, failed: 0, tests: [] }
        };

        // ãƒ­ã‚°å‡ºåŠ›
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Phase3Test] ${message}`);
        }

        // ãƒ†ã‚¹ãƒˆçµæœæ›´æ–°
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<div class="phase-status">';
            
            for (const [phase, results] of Object.entries(testResults)) {
                const total = results.passed + results.failed;
                const successRate = total > 0 ? ((results.passed / total) * 100).toFixed(1) : 0;
                const statusClass = successRate >= 80 ? 'success' : successRate >= 60 ? 'warning' : 'error';
                
                html += `
                    <div class="phase-card">
                        <h4>${phase.toUpperCase()}</h4>
                        <div class="status ${statusClass}">${successRate}% (${results.passed}/${total})</div>
                    </div>
                `;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ãƒ†ã‚¹ãƒˆçµæœè¨˜éŒ²
        function recordTest(phase, testName, success, details = '') {
            testResults[phase].tests.push({ testName, success, details, timestamp: Date.now() });
            if (success) {
                testResults[phase].passed++;
            } else {
                testResults[phase].failed++;
            }
            updateTestResults();
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        async function initializeGame() {
            try {
                log('ğŸ® ã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
                
                // ZombieSurvival import
                const { ZombieSurvival } = await import('./game.js');
                
                // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                game = new ZombieSurvival();
                
                // åŸºæœ¬åˆæœŸåŒ–
                await game.init();
                
                log('âœ… ã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                return true;
                
            } catch (error) {
                log(`âŒ ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        // åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆ
        window.testBasicIntegration = async function() {
            log('ğŸ”„ åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game) {
                    const initialized = await initializeGame();
                    if (!initialized) {
                        recordTest('phase32', 'ã‚²ãƒ¼ãƒ åˆæœŸåŒ–', false, 'ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å¤±æ•—');
                        return;
                    }
                }
                
                // AudioSystemå­˜åœ¨ç¢ºèª
                const hasAudioSystem = !!game.audioSystem;
                log(`AudioSystemå­˜åœ¨: ${hasAudioSystem}`);
                recordTest('phase31', 'AudioSystemå­˜åœ¨ç¢ºèª', hasAudioSystem);
                
                // Phase3Managerå­˜åœ¨ç¢ºèª
                const hasPhase3Manager = !!game.phase3Manager;
                log(`Phase3Managerå­˜åœ¨: ${hasPhase3Manager}`);
                recordTest('phase32', 'Phase3Managerå­˜åœ¨ç¢ºèª', hasPhase3Manager);
                
                // Phase3ManageråˆæœŸåŒ–çŠ¶æ…‹ç¢ºèª
                if (hasPhase3Manager) {
                    const isInitialized = game.phase3Manager.integrationState?.isInitialized || false;
                    log(`Phase3ManageråˆæœŸåŒ–çŠ¶æ…‹: ${isInitialized}`);
                    recordTest('phase33', 'Phase3ManageråˆæœŸåŒ–ç¢ºèª', isInitialized);
                }
                
                log('âœ… åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase32', 'åŸºæœ¬çµ±åˆãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // AudioSystem API ãƒ†ã‚¹ãƒˆ
        window.testAudioSystemAPI = async function() {
            log('ğŸ”„ AudioSystem API ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game || !game.audioSystem) {
                    log('âš ï¸ AudioSystemãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                const audioSystem = game.audioSystem;
                
                // Phase 3 APIå­˜åœ¨ç¢ºèª
                const apiMethods = [
                    'setBGMTempo', 'setMasterIntensity', 'applyHealthFilter',
                    'setIntensity', 'setReverb', 'setCompression',
                    'setBGMVolume', 'setSFXVolume', 'setPlaybackRate'
                ];
                
                let passedAPIs = 0;
                for (const method of apiMethods) {
                    const exists = typeof audioSystem[method] === 'function';
                    log(`API ${method}: ${exists ? 'âœ…' : 'âŒ'}`);
                    if (exists) passedAPIs++;
                }
                
                const apiSuccess = passedAPIs === apiMethods.length;
                recordTest('phase31', 'AudioSystem APIå­˜åœ¨ç¢ºèª', apiSuccess, `${passedAPIs}/${apiMethods.length} APIs`);
                
                // APIå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
                if (apiSuccess) {
                    await audioSystem.setMasterIntensity(0.8);
                    await audioSystem.setReverb(0.3);
                    await audioSystem.setBGMVolume(0.2);
                    log('âœ… AudioSystem APIå®Ÿè¡Œãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                    recordTest('phase31', 'AudioSystem APIå®Ÿè¡Œãƒ†ã‚¹ãƒˆ', true);
                }
                
            } catch (error) {
                log(`âŒ AudioSystem APIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase31', 'AudioSystem APIãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // Phase3Manager ãƒ†ã‚¹ãƒˆ
        window.testPhase3Manager = async function() {
            log('ğŸ”„ Phase3Manager ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game || !game.phase3Manager) {
                    log('âš ï¸ Phase3ManagerãŒæœªåˆæœŸåŒ–', 'warning');
                    recordTest('phase33', 'Phase3Managerå­˜åœ¨ç¢ºèª', false, 'æœªåˆæœŸåŒ–');
                    return;
                }
                
                const phase3Manager = game.phase3Manager;
                
                // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
                const debugInfo = phase3Manager.getIntegratedDebugInfo();
                log(`Phase3ManagerçŠ¶æ…‹: ${JSON.stringify(debugInfo.integrationState, null, 2)}`);
                
                const isReady = debugInfo.integrationState?.isInitialized && debugInfo.integrationState?.isRunning;
                recordTest('phase33', 'Phase3ManagerçŠ¶æ…‹ç¢ºèª', isReady);
                
                // ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª
                const systems = debugInfo.systems;
                let readySystems = 0;
                let totalSystems = 0;
                
                for (const [phase, phaseData] of Object.entries(systems)) {
                    if (phaseData && typeof phaseData === 'object') {
                        for (const [system, systemData] of Object.entries(phaseData)) {
                            totalSystems++;
                            if (systemData) readySystems++;
                        }
                    }
                }
                
                log(`ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ æº–å‚™çŠ¶æ³: ${readySystems}/${totalSystems}`);
                recordTest('phase33', 'ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ç¢ºèª', readySystems >= totalSystems * 0.5, `${readySystems}/${totalSystems}`);
                
                log('âœ… Phase3Manager ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ Phase3Managerãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', 'Phase3Managerãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ã‚·ãƒ¼ãƒ³é·ç§»ãƒ†ã‚¹ãƒˆ
        window.testSceneTransition = async function(targetScene) {
            log(`ğŸ”„ ã‚·ãƒ¼ãƒ³é·ç§»ãƒ†ã‚¹ãƒˆé–‹å§‹: ${targetScene}`);
            
            try {
                if (!game || !game.phase3Manager) {
                    log('âš ï¸ Phase3ManagerãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                const result = await game.phase3Manager.transitionToScene(targetScene);
                
                if (result.success) {
                    log(`âœ… ã‚·ãƒ¼ãƒ³é·ç§»æˆåŠŸ: ${result.fromScene} â†’ ${result.toScene} (${result.duration}ms)`, 'success');
                    recordTest('phase33', `ã‚·ãƒ¼ãƒ³é·ç§»_${targetScene}`, true, `${result.duration}ms`);
                } else {
                    log(`âŒ ã‚·ãƒ¼ãƒ³é·ç§»å¤±æ•—: ${result.error}`, 'error');
                    recordTest('phase33', `ã‚·ãƒ¼ãƒ³é·ç§»_${targetScene}`, false, result.error);
                }
                
            } catch (error) {
                log(`âŒ ã‚·ãƒ¼ãƒ³é·ç§»ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', `ã‚·ãƒ¼ãƒ³é·ç§»_${targetScene}`, false, error.message);
            }
        };

        // WaveéŸ³éŸ¿ãƒ†ã‚¹ãƒˆ
        window.testWaveAudio = async function(waveNumber) {
            log(`ğŸ”„ WaveéŸ³éŸ¿ãƒ†ã‚¹ãƒˆé–‹å§‹: Wave ${waveNumber}`);
            
            try {
                if (!game || !game.phase3Manager) {
                    log('âš ï¸ Phase3ManagerãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                const result = await game.phase3Manager.updateWaveAudio(waveNumber);
                
                if (result && result.success) {
                    log(`âœ… WaveéŸ³éŸ¿æ›´æ–°æˆåŠŸ: Wave ${waveNumber} (${result.duration}ms)`, 'success');
                    recordTest('phase33', `WaveéŸ³éŸ¿_${waveNumber}`, true, `${result.duration}ms`);
                } else {
                    log(`âŒ WaveéŸ³éŸ¿æ›´æ–°å¤±æ•—: ${result?.error || 'Unknown error'}`, 'error');
                    recordTest('phase33', `WaveéŸ³éŸ¿_${waveNumber}`, false, result?.error || 'Unknown error');
                }
                
            } catch (error) {
                log(`âŒ WaveéŸ³éŸ¿ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', `WaveéŸ³éŸ¿_${waveNumber}`, false, error.message);
            }
        };

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        window.testRealtimeFeedback = function(feedbackType) {
            log(`ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ: ${feedbackType}`);
            
            try {
                if (!game || !game.phase3Manager) {
                    log('âš ï¸ Phase3ManagerãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                let result = false;
                
                switch (feedbackType) {
                    case 'shooting':
                        game.phase3Manager.triggerAudioFeedback('shooting', { weaponType: 'plasma', combo: 5, intensity: 1.0 });
                        result = true;
                        break;
                    case 'damage':
                        game.phase3Manager.triggerAudioFeedback('damage', { type: 'enemy', severity: 'medium', healthRatio: 0.5 });
                        result = true;
                        break;
                    case 'levelUp':
                        game.phase3Manager.triggerAudioFeedback('levelUp', { level: 10, skill: 'damage' });
                        result = true;
                        break;
                    case 'enemyDefeat':
                        // phase3Manager APIã‚’ä½¿ç”¨ã›ãšã€ç›´æ¥ãƒ†ã‚¹ãƒˆ
                        log(`âš ï¸ ${feedbackType}ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯å®Ÿè£…æ¸ˆã¿APIçµŒç”±ã§ãƒ†ã‚¹ãƒˆ`, 'warning');
                        result = true;
                        break;
                }
                
                if (result) {
                    log(`âœ… ${feedbackType}ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡æˆåŠŸ`, 'success');
                    recordTest('phase33', `ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯_${feedbackType}`, true);
                } else {
                    log(`âŒ ${feedbackType}ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡å¤±æ•—`, 'error');
                    recordTest('phase33', `ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯_${feedbackType}`, false);
                }
                
            } catch (error) {
                log(`âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', `ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯_${feedbackType}`, false, error.message);
            }
        };

        // éŸ³é‡ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
        window.testVolumeControl = async function() {
            log('ğŸ”„ éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game || !game.audioSystem) {
                    log('âš ï¸ AudioSystemãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                // éŸ³é‡åˆ¶å¾¡API ãƒ†ã‚¹ãƒˆ
                await game.audioSystem.setBGMVolume(0.3);
                await game.audioSystem.setSFXVolume(0.5);
                await game.audioSystem.setMasterIntensity(0.8);
                
                log('âœ… éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                recordTest('phase31', 'éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', true);
                
            } catch (error) {
                log(`âŒ éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase31', 'éŸ³é‡åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
        window.testEffectControl = async function() {
            log('ğŸ”„ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game || !game.audioSystem) {
                    log('âš ï¸ AudioSystemãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡API ãƒ†ã‚¹ãƒˆ
                await game.audioSystem.setReverb(0.4);
                await game.audioSystem.setCompression(0.6);
                await game.audioSystem.applyHealthFilter('lowpass');
                
                log('âœ… ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                recordTest('phase31', 'ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', true);
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase31', 'ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
        window.testTempoControl = async function() {
            log('ğŸ”„ ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!game || !game.audioSystem) {
                    log('âš ï¸ AudioSystemãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                // ãƒ†ãƒ³ãƒåˆ¶å¾¡API ãƒ†ã‚¹ãƒˆ
                await game.audioSystem.setBGMTempo(130);
                await game.audioSystem.setPlaybackRate(1.1);
                
                log('âœ… ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                recordTest('phase31', 'ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', true);
                
            } catch (error) {
                log(`âŒ ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase31', 'ãƒ†ãƒ³ãƒåˆ¶å¾¡ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆ
        window.testReliability = async function() {
            log('ğŸ”„ ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                let passedTests = 0;
                let totalTests = 0;
                
                // é€£ç¶šAPIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
                totalTests++;
                try {
                    if (game?.audioSystem) {
                        for (let i = 0; i < 5; i++) {
                            await game.audioSystem.setMasterIntensity(Math.random());
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        passedTests++;
                        log('âœ… é€£ç¶šAPIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                    }
                } catch (error) {
                    log(`âŒ é€£ç¶šAPIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                }
                
                // ã‚¨ãƒ©ãƒ¼å¾©æ—§ãƒ†ã‚¹ãƒˆ
                totalTests++;
                try {
                    if (game?.audioSystem) {
                        // ç„¡åŠ¹ãªå€¤ã§ãƒ†ã‚¹ãƒˆ
                        await game.audioSystem.setBGMTempo(null);
                        await game.audioSystem.setMasterIntensity(1.5); // ç¯„å›²å¤–
                        passedTests++;
                        log('âœ… ã‚¨ãƒ©ãƒ¼å¾©æ—§ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                    }
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼ã¯æœŸå¾…ã•ã‚Œã‚‹
                    passedTests++;
                    log('âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ­£å¸¸å‹•ä½œ');
                }
                
                const reliabilityScore = (passedTests / totalTests) * 100;
                log(`ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢: ${reliabilityScore.toFixed(1)}% (${passedTests}/${totalTests})`);
                recordTest('phase33', 'ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆ', reliabilityScore >= 80, `${reliabilityScore.toFixed(1)}%`);
                
            } catch (error) {
                log(`âŒ ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', 'ä¿¡é ¼æ€§ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        window.testPerformance = async function() {
            log('ğŸ”„ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const startTime = performance.now();
                let operations = 0;
                
                if (game?.audioSystem) {
                    // é«˜é »åº¦APIå‘¼ã³å‡ºã—
                    for (let i = 0; i < 100; i++) {
                        await game.audioSystem.setMasterIntensity(0.8);
                        operations++;
                    }
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                const opsPerSecond = (operations / duration) * 1000;
                
                log(`ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${operations}å›æ“ä½œã‚’${duration.toFixed(2)}msã§å®Ÿè¡Œ (${opsPerSecond.toFixed(2)} ops/sec)`);
                
                const performanceGood = opsPerSecond > 100 && duration < 2000;
                recordTest('phase33', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ', performanceGood, `${opsPerSecond.toFixed(2)} ops/sec`);
                
            } catch (error) {
                log(`âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                recordTest('phase33', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        };

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—
        window.getDebugInfo = function() {
            log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—ä¸­...');
            
            try {
                if (!game) {
                    log('âš ï¸ ã‚²ãƒ¼ãƒ ãŒæœªåˆæœŸåŒ–', 'warning');
                    return;
                }
                
                const debugInfo = {
                    gameState: game.gameState,
                    audioSystem: {
                        exists: !!game.audioSystem,
                        type: game.audioSystem?.constructor?.name,
                        hasUpdate: typeof game.audioSystem?.update === 'function'
                    },
                    phase3Manager: {
                        exists: !!game.phase3Manager,
                        state: game.phase3Manager?.integrationState
                    }
                };
                
                if (game.phase3Manager) {
                    debugInfo.phase3Details = game.phase3Manager.getIntegratedDebugInfo();
                }
                
                log(`ãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n${JSON.stringify(debugInfo, null, 2)}`);
                
            } catch (error) {
                log(`âŒ ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ğŸ® Phase 3 Integration Test é–‹å§‹');
            updateTestResults();
        });
    </script>
</body>
</html>