<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Settings API テストページ - 音量管理システム</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            color: #FF5722;
            text-shadow: 0 0 10px rgba(255, 87, 34, 0.5);
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #FF5722;
        }
        .test-button {
            background: linear-gradient(45deg, #FF5722, #FF8A65);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: scale(1.05);
        }
        .volume-control {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .volume-control label {
            min-width: 80px;
            color: #FFC107;
        }
        .volume-control input[type="range"] {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
        }
        .volume-control .volume-value {
            min-width: 50px;
            text-align: right;
            color: #4CAF50;
            font-weight: bold;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196F3; }
        #log {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Settings API テストページ</h1>
        <p style="text-align: center; color: #aaa;">IntegratedAudioManager音量管理API検証システム</p>

        <div class="test-section">
            <h3>📊 システム初期化</h3>
            <button class="test-button" onclick="initializeAudio()">音響システム初期化</button>
            <button class="test-button" onclick="checkAPI()">API確認</button>
            <div id="system-status" class="status info">待機中...</div>
        </div>

        <div class="test-section">
            <h3>🔊 音量取得テスト</h3>
            <button class="test-button" onclick="testGetVolume()">全音量取得</button>
            <button class="test-button" onclick="testGetMaster()">マスター音量取得</button>
            <button class="test-button" onclick="testGetBGM()">BGM音量取得</button>
            <button class="test-button" onclick="testGetSFX()">SFX音量取得</button>
        </div>

        <div class="test-section">
            <h3>🎚️ 音量設定テスト</h3>
            <div class="volume-control">
                <label>Master:</label>
                <input type="range" id="master-slider" min="0" max="100" value="80" onchange="testSetVolume('master', this.value)">
                <span class="volume-value" id="master-value">80%</span>
            </div>
            <div class="volume-control">
                <label>BGM:</label>
                <input type="range" id="bgm-slider" min="0" max="100" value="30" onchange="testSetVolume('bgm', this.value)">
                <span class="volume-value" id="bgm-value">30%</span>
            </div>
            <div class="volume-control">
                <label>SFX:</label>
                <input type="range" id="sfx-slider" min="0" max="100" value="70" onchange="testSetVolume('sfx', this.value)">
                <span class="volume-value" id="sfx-value">70%</span>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 統合テスト</h3>
            <button class="test-button" onclick="runComprehensiveTest()">完全APIテスト実行</button>
            <button class="test-button" onclick="resetVolumes()">デフォルト音量復元</button>
            <button class="test-button" onclick="clearLog()">ログクリア</button>
        </div>

        <div class="test-section">
            <h3>📝 テストログ</h3>
            <div id="log"></div>
        </div>
    </div>

    <script type="module">
        import { IntegratedAudioManager } from './js/systems/integrated-audio-manager.js';

        // ダミーゲームオブジェクト作成
        const mockGame = {
            canvas: document.createElement('canvas'),
            ctx: document.createElement('canvas').getContext('2d')
        };

        let audioManager = null;

        // ログ出力関数
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : '📝';
            logElement.innerHTML += `[${timestamp}] ${icon} ${message}\\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${icon} ${message}`);
        }

        // 音響システム初期化
        window.initializeAudio = async function() {
            try {
                audioManager = new IntegratedAudioManager(mockGame);
                await audioManager.initialize();
                document.getElementById('system-status').innerHTML = 
                    '<span style="color: #4caf50;">✅ 音響システム初期化完了</span>';
                log('IntegratedAudioManager初期化完了', 'success');
                
                // 初期音量を表示に反映
                updateSliders();
            } catch (error) {
                document.getElementById('system-status').innerHTML = 
                    `<span style="color: #f44336;">❌ 初期化失敗: ${error.message}</span>`;
                log(`音響システム初期化エラー: ${error.message}`, 'error');
            }
        };

        // API確認
        window.checkAPI = function() {
            if (!audioManager) {
                log('先に音響システムを初期化してください', 'error');
                return;
            }

            const hasGetVolume = typeof audioManager.getVolume === 'function';
            const hasSetVolume = typeof audioManager.setVolume === 'function';
            
            log(`getVolume API存在: ${hasGetVolume}`, hasGetVolume ? 'success' : 'error');
            log(`setVolume API存在: ${hasSetVolume}`, hasSetVolume ? 'success' : 'error');
            
            if (hasGetVolume && hasSetVolume) {
                log('✅ Settings API完全対応', 'success');
            } else {
                log('❌ Settings API不完全', 'error');
            }
        };

        // 音量取得テスト
        window.testGetVolume = function() {
            if (!audioManager) {
                log('先に音響システムを初期化してください', 'error');
                return;
            }

            try {
                const master = audioManager.getVolume('master');
                const bgm = audioManager.getVolume('bgm');
                const sfx = audioManager.getVolume('sfx');
                
                log(`現在の音量 - Master: ${(master * 100).toFixed(1)}%, BGM: ${(bgm * 100).toFixed(1)}%, SFX: ${(sfx * 100).toFixed(1)}%`, 'success');
            } catch (error) {
                log(`音量取得エラー: ${error.message}`, 'error');
            }
        };

        window.testGetMaster = function() {
            testSingleVolume('master');
        };

        window.testGetBGM = function() {
            testSingleVolume('bgm');
        };

        window.testGetSFX = function() {
            testSingleVolume('sfx');
        };

        function testSingleVolume(type) {
            if (!audioManager) {
                log('先に音響システムを初期化してください', 'error');
                return;
            }

            try {
                const volume = audioManager.getVolume(type);
                log(`${type.toUpperCase()}音量: ${(volume * 100).toFixed(1)}%`, 'success');
            } catch (error) {
                log(`${type}音量取得エラー: ${error.message}`, 'error');
            }
        }

        // 音量設定テスト
        window.testSetVolume = function(type, value) {
            if (!audioManager) {
                log('先に音響システムを初期化してください', 'error');
                return;
            }

            try {
                const volume = value / 100;
                audioManager.setVolume(type, volume);
                document.getElementById(`${type}-value`).textContent = `${value}%`;
                log(`${type.toUpperCase()}音量設定: ${value}%`, 'success');
            } catch (error) {
                log(`${type}音量設定エラー: ${error.message}`, 'error');
            }
        };

        // スライダー更新
        function updateSliders() {
            if (!audioManager) return;

            try {
                const types = ['master', 'bgm', 'sfx'];
                types.forEach(type => {
                    const volume = audioManager.getVolume(type);
                    const percentage = Math.round(volume * 100);
                    document.getElementById(`${type}-slider`).value = percentage;
                    document.getElementById(`${type}-value`).textContent = `${percentage}%`;
                });
                log('スライダー更新完了', 'info');
            } catch (error) {
                log(`スライダー更新エラー: ${error.message}`, 'error');
            }
        }

        // 包括的テスト
        window.runComprehensiveTest = async function() {
            log('🚀 包括的Settings APIテスト開始', 'info');
            
            try {
                if (!audioManager) {
                    await initializeAudio();
                }
                
                checkAPI();
                await new Promise(r => setTimeout(r, 500));
                
                testGetVolume();
                await new Promise(r => setTimeout(r, 500));
                
                // 各音量を段階的にテスト
                const testValues = [50, 25, 75, 80];
                for (const value of testValues) {
                    audioManager.setVolume('master', value / 100);
                    audioManager.setVolume('bgm', value / 100);
                    audioManager.setVolume('sfx', value / 100);
                    log(`全音量を${value}%に設定`, 'info');
                    await new Promise(r => setTimeout(r, 300));
                }
                
                updateSliders();
                log('🎉 包括的Settings APIテスト完了！', 'success');
                
            } catch (error) {
                log(`包括的テスト実行エラー: ${error.message}`, 'error');
            }
        };

        // デフォルト音量復元
        window.resetVolumes = function() {
            if (!audioManager) {
                log('先に音響システムを初期化してください', 'error');
                return;
            }

            try {
                audioManager.setVolume('master', 0.8);
                audioManager.setVolume('bgm', 0.3);
                audioManager.setVolume('sfx', 0.7);
                updateSliders();
                log('デフォルト音量に復元しました', 'success');
            } catch (error) {
                log(`音量復元エラー: ${error.message}`, 'error');
            }
        };

        // ログクリア
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('ログをクリアしました', 'info');
        };

        // 初期メッセージ
        log('🔧 Settings API テストページ準備完了', 'success');
        log('「音響システム初期化」ボタンからテストを開始してください', 'info');
    </script>
</body>
</html>