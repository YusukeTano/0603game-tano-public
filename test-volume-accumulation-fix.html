<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Volume Accumulation Fix - Verification Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            margin-bottom: 30px;
        }
        
        .fix-summary {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .test-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-section.before {
            border-color: rgba(255, 107, 107, 0.5);
        }
        
        .test-section.after {
            border-color: rgba(0, 255, 136, 0.5);
        }
        
        .test-section h2 {
            margin-top: 0;
            text-align: center;
        }
        
        .before h2 {
            color: #ff6b6b;
        }
        
        .after h2 {
            color: #00ff88;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: calc(100% - 16px);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-old {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }
        
        .btn-new {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
        }
        
        .log-display {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #c0c0c0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stats-display {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #a0a0a0;
            border-left: 4px solid #4ecdc4;
        }
        
        .volume-chart {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            min-height: 150px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Volume Accumulation Fix - Verification Test</h1>
        
        <!-- ä¿®æ­£å†…å®¹è¦ç´„ -->
        <div class="fix-summary">
            <h3>âœ… å®Ÿè£…ã•ã‚ŒãŸä¿®æ­£å†…å®¹</h3>
            <p><strong>Phase 1: Volume Baseline Storage System</strong></p>
            <ul>
                <li>ğŸ”§ <strong>Volume Baseline Storage</strong>: å„Synthã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³éŸ³é‡ã‚’ä¿å­˜ãƒ»ç®¡ç†</li>
                <li>ğŸ›¡ï¸ <strong>Volume Limits</strong>: æœ€å°-30dBã€œæœ€å¤§+5dBã€å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³2dBã®åˆ¶é™</li>
                <li>ğŸš« <strong>Accumulation Prevention</strong>: æ¯å›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã“ã¨ã§ç´¯ç©ã‚’å®Œå…¨é˜²æ­¢</li>
                <li>ğŸ“Š <strong>Debugging System</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ»çµ±è¨ˆãƒ»ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰</li>
                <li>ğŸ¯ <strong>ä¿®æ­£ç®‡æ‰€</strong>: 5ç®‡æ‰€ã®`synth.volume.value`ç´¯ç©å•é¡Œã‚’æ ¹çµ¶</li>
            </ul>
        </div>
        
        <!-- æ¯”è¼ƒãƒ†ã‚¹ãƒˆ -->
        <div class="test-grid">
            <!-- ä¿®æ­£å‰ã®æŒ™å‹•ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ -->
            <div class="test-section before">
                <h2>ğŸ”´ ä¿®æ­£å‰ã®æŒ™å‹•ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</h2>
                <p><strong>å•é¡Œ</strong>: æ’ƒã¡ç¶šã‘ã‚‹ã¨éŸ³é‡ãŒç´¯ç©å¢—åŠ </p>
                
                <button class="btn btn-old" onclick="simulateOldBehavior()">ğŸ”´ æ—§ç‰ˆ: ç´¯ç©å¢—åŠ ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-old" onclick="simulateOldContinuous()">ğŸ” æ—§ç‰ˆ: é€£ç¶šå°„æ’ƒ</button>
                
                <div class="stats-display" id="oldStats">
                    <strong>æ—§ç‰ˆã®å•é¡Œ:</strong><br>
                    - synth.volume.value ã‚’ç›´æ¥ä½¿ç”¨<br>
                    - æ—¢ã«èª¿æ•´æ¸ˆã¿ã®å€¤ã«æ›´ã«èª¿æ•´ã‚’è¿½åŠ <br>
                    - éŸ³é‡ãŒæŒ‡æ•°é–¢æ•°çš„ã«å¢—åŠ <br>
                    - æœ€çµ‚çš„ã«éŸ³å£°ãŒæ­ªã‚€
                </div>
                
                <div class="volume-chart" id="oldChart">
                    <strong>éŸ³é‡å¤‰åŒ–ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ—§ç‰ˆï¼‰</strong><br>
                    <small>æ¨ªè»¸: å°„æ’ƒå›æ•° | ç¸¦è»¸: éŸ³é‡(dB)</small>
                </div>
            </div>
            
            <!-- ä¿®æ­£å¾Œã®æŒ™å‹• -->
            <div class="test-section after">
                <h2>ğŸŸ¢ ä¿®æ­£å¾Œã®æŒ™å‹•</h2>
                <p><strong>æ”¹å–„</strong>: éŸ³é‡ãŒä¸€å®šã«ä¿ãŸã‚Œã‚‹</p>
                
                <button class="btn btn-new" onclick="testNewBehavior()">ğŸŸ¢ æ–°ç‰ˆ: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ä¿æŒãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-new" onclick="testNewContinuous()">ğŸ” æ–°ç‰ˆ: é€£ç¶šå°„æ’ƒ</button>
                
                <div class="stats-display" id="newStats">
                    <strong>æ–°ç‰ˆã®æ”¹å–„:</strong><br>
                    - Volume Baseline Storageä½¿ç”¨<br>
                    - æ¯å›ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰è¨ˆç®—<br>
                    - éŸ³é‡ãŒä¸€å®šç¯„å›²å†…ã§ç¶­æŒ<br>
                    - å®‰å…¨åˆ¶é™ã«ã‚ˆã‚‹ä¿è­·
                </div>
                
                <div class="volume-chart" id="newChart">
                    <strong>éŸ³é‡å¤‰åŒ–ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ–°ç‰ˆï¼‰</strong><br>
                    <small>æ¨ªè»¸: å°„æ’ƒå›æ•° | ç¸¦è»¸: éŸ³é‡(dB)</small>
                </div>
            </div>
        </div>
        
        <!-- æ¤œè¨¼ãƒ­ã‚° -->
        <div class="test-section">
            <h3>ğŸ“ æ¤œè¨¼ãƒ­ã‚°</h3>
            <div class="log-display" id="testLog">
                <div>ğŸ”§ Volume Accumulation Fix Verification Ready</div>
                <div>ğŸ‘† ä¸Šã®ãƒœã‚¿ãƒ³ã§ä¿®æ­£å‰å¾Œã®éŸ³é‡å¤‰åŒ–ã‚’æ¯”è¼ƒã—ã¦ãã ã•ã„</div>
            </div>
            <button class="btn" onclick="clearLog()">Clear Log</button>
        </div>
        
        <!-- æŠ€è¡“è©³ç´° -->
        <div class="test-section">
            <h3>ğŸ› ï¸ æŠ€è¡“å®Ÿè£…è©³ç´°</h3>
            <div class="stats-display">
                <strong>ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹:</strong><br>
                <code>const baseVolume = synth.volume.value; // âŒ èª¿æ•´æ¸ˆã¿å€¤</code><br>
                <code>const adjusted = baseVolume + adjustment; // âŒ ç´¯ç©</code><br><br>
                
                <strong>ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ä¾‹:</strong><br>
                <code>const synthId = this.getSynthId(synth, weaponType);</code><br>
                <code>const baseline = this.getOrStoreVolumeBaseline(synthId, synth);</code><br>
                <code>const adjusted = this.applySafeVolumeAdjustment(baseline, adjustment);</code><br><br>
                
                <strong>ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰:</strong><br>
                <code>AdvancedAudioDebug.getVolumeStats()</code><br>
                <code>AdvancedAudioDebug.testVolumeAccumulation(10)</code><br>
                <code>AdvancedAudioDebug.resetVolumeBaselines()</code>
            </div>
        </div>
    </div>

    <!-- Mock Test System -->
    <script>
        let audioContext = null;
        let shotCountOld = 0;
        let shotCountNew = 0;
        let oldVolumeHistory = [];
        let newVolumeHistory = [];
        
        // åˆæœŸåŒ–
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                log('ğŸµ Mock test audio system initialized');
            }
        }
        
        // æ—§ç‰ˆã®ç´¯ç©å¢—åŠ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        function simulateOldBehavior() {
            initAudio();
            shotCountOld++;
            
            // æ—§ç‰ˆãƒ­ã‚¸ãƒƒã‚¯: å‰å›ã®éŸ³é‡ã«èª¿æ•´ã‚’ç´¯ç©
            let currentVolume = oldVolumeHistory.length > 0 ? oldVolumeHistory[oldVolumeHistory.length - 1] : -10;
            let adjustment = 3; // æ¯å›3dBå¢—åŠ 
            let newVolume = currentVolume + adjustment; // âŒ ç´¯ç©å¢—åŠ 
            
            oldVolumeHistory.push(newVolume);
            
            // å®Ÿéš›ã«éŸ³ã‚’é³´ã‚‰ã—ã¦ç´¯ç©ã‚’ä½“æ„Ÿ
            playMockSound(newVolume, 'old');
            
            log(`ğŸ”´ OLD Shot ${shotCountOld}: ${currentVolume.toFixed(1)}dB + ${adjustment}dB = ${newVolume.toFixed(1)}dB (ç´¯ç©å¢—åŠ )`);
            
            updateOldStats();
            updateOldChart();
        }
        
        // æ–°ç‰ˆã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ä¿æŒã‚’ãƒ†ã‚¹ãƒˆ
        function testNewBehavior() {
            initAudio();
            shotCountNew++;
            
            // æ–°ç‰ˆãƒ­ã‚¸ãƒƒã‚¯: å¸¸ã«ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰è¨ˆç®—
            const baselineVolume = -10; // å›ºå®šãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
            const adjustment = 3; // åŒã˜èª¿æ•´å€¤
            const safetyLimit = 5; // å®‰å…¨ä¸Šé™
            let newVolume = Math.min(baselineVolume + adjustment, safetyLimit); // âœ… ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰è¨ˆç®—
            
            newVolumeHistory.push(newVolume);
            
            // å®Ÿéš›ã«éŸ³ã‚’é³´ã‚‰ã—ã¦å®‰å®šæ€§ã‚’ä½“æ„Ÿ
            playMockSound(newVolume, 'new');
            
            log(`ğŸŸ¢ NEW Shot ${shotCountNew}: baseline=${baselineVolume}dB + ${adjustment}dB = ${newVolume.toFixed(1)}dB (ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ä¿æŒ)`);
            
            updateNewStats();
            updateNewChart();
        }
        
        // é€£ç¶šå°„æ’ƒãƒ†ã‚¹ãƒˆ
        function simulateOldContinuous() {
            log('ğŸ” OLD: Starting continuous shooting test (10 shots)...');
            let count = 0;
            const interval = setInterval(() => {
                if (count >= 10) {
                    clearInterval(interval);
                    log('ğŸ”´ OLD: Continuous test completed - Notice exponential volume increase');
                    return;
                }
                simulateOldBehavior();
                count++;
            }, 300);
        }
        
        function testNewContinuous() {
            log('ğŸ” NEW: Starting continuous shooting test (10 shots)...');
            let count = 0;
            const interval = setInterval(() => {
                if (count >= 10) {
                    clearInterval(interval);
                    log('ğŸŸ¢ NEW: Continuous test completed - Volume remained stable');
                    return;
                }
                testNewBehavior();
                count++;
            }, 300);
        }
        
        // MockéŸ³éŸ¿å†ç”Ÿ
        function playMockSound(volume, version) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sawtooth';
                
                // dBã‹ã‚‰ç·šå½¢éŸ³é‡ã«å¤‰æ›
                const linearVolume = Math.pow(10, volume / 20) * 0.1;
                const clampedVolume = Math.max(0.001, Math.min(1, linearVolume));
                
                gainNode.gain.setValueAtTime(clampedVolume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.08);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.08);
                
            } catch (error) {
                console.warn('Mock sound playback failed:', error);
            }
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateOldStats() {
            const lastVolume = oldVolumeHistory[oldVolumeHistory.length - 1];
            const maxVolume = Math.max(...oldVolumeHistory);
            const increase = oldVolumeHistory.length > 1 ? lastVolume - oldVolumeHistory[0] : 0;
            
            document.getElementById('oldStats').innerHTML = `
                <strong>æ—§ç‰ˆã®å•é¡Œ:</strong><br>
                - ç¾åœ¨éŸ³é‡: ${lastVolume.toFixed(1)}dB<br>
                - æœ€å¤§éŸ³é‡: ${maxVolume.toFixed(1)}dB<br>
                - ç·å¢—åŠ : +${increase.toFixed(1)}dB<br>
                - å°„æ’ƒå›æ•°: ${shotCountOld}å›<br>
                <span style="color: #ff6b6b">âŒ ç´¯ç©ã«ã‚ˆã‚ŠéŸ³é‡ãŒåˆ¶å¾¡ä¸èƒ½</span>
            `;
        }
        
        function updateNewStats() {
            const lastVolume = newVolumeHistory[newVolumeHistory.length - 1];
            const avgVolume = newVolumeHistory.reduce((sum, vol) => sum + vol, 0) / newVolumeHistory.length;
            const variance = Math.max(...newVolumeHistory) - Math.min(...newVolumeHistory);
            
            document.getElementById('newStats').innerHTML = `
                <strong>æ–°ç‰ˆã®æ”¹å–„:</strong><br>
                - ç¾åœ¨éŸ³é‡: ${lastVolume.toFixed(1)}dB<br>
                - å¹³å‡éŸ³é‡: ${avgVolume.toFixed(1)}dB<br>
                - éŸ³é‡å¤‰å‹•: Â±${variance.toFixed(1)}dB<br>
                - å°„æ’ƒå›æ•°: ${shotCountNew}å›<br>
                <span style="color: #00ff88">âœ… ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚ŠéŸ³é‡ãŒå®‰å®š</span>
            `;
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateOldChart() {
            const chart = document.getElementById('oldChart');
            let chartData = '<strong>éŸ³é‡å¤‰åŒ–ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ—§ç‰ˆï¼‰</strong><br>';
            chartData += '<small>æ¨ªè»¸: å°„æ’ƒå›æ•° | ç¸¦è»¸: éŸ³é‡(dB)</small><br>';
            
            oldVolumeHistory.forEach((volume, index) => {
                const barHeight = Math.max(1, Math.min(20, (volume + 30) / 4)); // -30dBã€œ+50dBã‚’1-20ã®ç¯„å›²ã«æ­£è¦åŒ–
                const color = volume > 10 ? '#ff6b6b' : volume > 0 ? '#ff9800' : '#4CAF50';
                chartData += `<div style="display: inline-block; width: 20px; height: ${barHeight}px; background: ${color}; margin: 1px; vertical-align: bottom;"></div>`;
            });
            
            chart.innerHTML = chartData;
        }
        
        function updateNewChart() {
            const chart = document.getElementById('newChart');
            let chartData = '<strong>éŸ³é‡å¤‰åŒ–ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ–°ç‰ˆï¼‰</strong><br>';
            chartData += '<small>æ¨ªè»¸: å°„æ’ƒå›æ•° | ç¸¦è»¸: éŸ³é‡(dB)</small><br>';
            
            newVolumeHistory.forEach((volume, index) => {
                const barHeight = Math.max(1, Math.min(20, (volume + 30) / 4)); // -30dBã€œ+50dBã‚’1-20ã®ç¯„å›²ã«æ­£è¦åŒ–
                const color = '#00ff88'; // å®‰å®šã—ãŸç·‘è‰²
                chartData += `<div style="display: inline-block; width: 20px; height: ${barHeight}px; background: ${color}; margin: 1px; vertical-align: bottom;"></div>`;
            });
            
            chart.innerHTML = chartData;
        }
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message) {
            const logEl = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div>ğŸ“ Log cleared</div>';
            shotCountOld = 0;
            shotCountNew = 0;
            oldVolumeHistory = [];
            newVolumeHistory = [];
            updateOldChart();
            updateNewChart();
        }
        
        // åˆæœŸåŒ–
        log('ğŸ”§ Volume Accumulation Fix Verification Ready');
        log('ğŸ“Š Compare OLD (cumulative increase) vs NEW (baseline stability)');
        log('ğŸ¯ Listen carefully to the volume difference between versions');
    </script>
</body>
</html>