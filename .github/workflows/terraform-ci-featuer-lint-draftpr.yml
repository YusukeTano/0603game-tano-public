name: Feature Lint & Auto Draft PR

on:
  push:
    branches: ['feature/**']
    paths:
      - 'infra/**'
      - '.tflint.hcl'
      - '.terraform-version'
      - '.github/workflows/terraform-ci-feature-lint-draftpr.yml'

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  TFLINT_VERSION: v0.53.0

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-draft-pr:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # Terraformãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-tfplugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: ${{ runner.os }}-tfplugins-
      
      # TFLintãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl', '**/.tflint.hcl') }}
          restore-keys: ${{ runner.os }}-tflint-
      
      # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
      - name: Create plugin cache dir
        run: mkdir -p ~/.terraform.d/plugin-cache
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2
      
      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}
      
      # Terraform fmt ãƒã‚§ãƒƒã‚¯
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive infra/
        continue-on-error: true
      
      # Terraform validateï¼ˆlockfileèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
      - name: Terraform Validate
        id: validate
        run: |
          for env in dev stg prd; do
            dir="infra/static-website/environments/$env"
            if [ -d "$dir" ]; then
              echo "::group::Validating $dir"
              pushd "$dir" > /dev/null
              terraform init -backend=false -input=false -lockfile=readonly
              terraform validate -no-color
              popd > /dev/null
              echo "::endgroup::"
            fi
          done
        continue-on-error: true
      
      # TFLintå®Ÿè¡Œ
      - name: TFLint
        id: tflint
        working-directory: infra
        run: |
          tflint --init
          tflint --recursive
        continue-on-error: true
      
      # ãƒã‚§ãƒƒã‚¯çµæœã®ã‚µãƒãƒªä½œæˆ
      - name: Create Check Summary
        id: summary
        run: |
          SUMMARY="### ğŸ” Terraform Check Results\n\n"
          SUMMARY="${SUMMARY}| Check | Status |\n"
          SUMMARY="${SUMMARY}|-------|--------|\n"
          
          if [ "${{ steps.fmt.outcome }}" == "success" ]; then
            SUMMARY="${SUMMARY}| Format | âœ… Pass |\n"
          else
            SUMMARY="${SUMMARY}| Format | âŒ Fail |\n"
          fi
          
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            SUMMARY="${SUMMARY}| Validate | âœ… Pass |\n"
          else
            SUMMARY="${SUMMARY}| Validate | âš ï¸ Warning |\n"
          fi
          
          if [ "${{ steps.tflint.outcome }}" == "success" ]; then
            SUMMARY="${SUMMARY}| TFLint | âœ… Pass |\n"
          else
            SUMMARY="${SUMMARY}| TFLint | âš ï¸ Warning |\n"
          fi
          
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
      - name: Check for existing PR
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });
            
            if (prs.length > 0) {
              console.log(`Found existing PR #${prs[0].number}`);
              return prs[0].number;
            }
            return '';
          result-encoding: string
      
      # æ—¢å­˜PRã‚’Draftã«æˆ»ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ãƒãƒ¼ãƒ åˆ¤æ–­ï¼‰
      - name: Ensure PR is Draft
        if: steps.check-pr.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-pr.outputs.result }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            if (!pr.draft) {
              // Draftã«æˆ»ã™ã‹ã‚³ãƒ¡ãƒ³ãƒˆã§è­¦å‘Šã™ã‚‹ã‹é¸æŠ
              // Option 1: Draftã«æˆ»ã™
              /*
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                draft: true
              });
              console.log(`Reverted PR #${prNumber} to draft`);
              */
              
              // Option 2: è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆã®ã¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **æ³¨æ„**: ã“ã®PRã¯ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™ãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nTerraformã®ãƒã‚§ãƒƒã‚¯çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
            }
        continue-on-error: true
      
      # ãƒ©ãƒ™ãƒ«ç¢ºä¿
      - name: Ensure Labels Exist
        if: steps.check-pr.outputs.result == ''
        uses: actions/github-script@v7
        with:
          script: |
            async function ensureLabel(name, color = "ededed", description = "") {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: name
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: name,
                    color: color,
                    description: description
                  });
                  console.log(`Created label '${name}'`);
                }
              }
            }
            
            await ensureLabel('terraform', '7B3F00', 'Terraform related changes');
            await ensureLabel('draft', 'FEF2C0', 'Draft PR - work in progress');
      
      # æ–°è¦PRã®ä½œæˆï¼ˆæ—¢å­˜PRãŒãªã„å ´åˆã®ã¿ï¼‰
      - name: Create Draft PR
        if: steps.check-pr.outputs.result == ''
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const featureName = branch.replace('feature/', '').replace(/-/g, ' ');
            
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `feat: ${featureName}`,
                head: branch,
                base: 'main',
                body: `## ğŸ“ æ¦‚è¦
            
            ### ç›®çš„
            <!-- ã“ã®å¤‰æ›´ãŒå¿…è¦ãªç†ç”±ã‚’è¨˜è¼‰ -->
            
            ### å¤‰æ›´å†…å®¹
            <!-- ä½•ã‚’å¤‰æ›´ã—ãŸã‹ã‚’è¨˜è¼‰ -->
            
            ### å¯¾è±¡ç’°å¢ƒ
            - [ ] dev
            - [ ] stg
            - [ ] prd
            
            ### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            - [ ] terraform fmt å®Ÿè¡Œæ¸ˆã¿
            - [ ] terraform validate æˆåŠŸ
            - [ ] terraform plan ç¢ºèªæ¸ˆã¿
            - [ ] å¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°æ¸ˆã¿
            
            ### ãƒ†ã‚¹ãƒˆçµæœ
            <!-- terraform planã®çµæœã‚„ãƒ†ã‚¹ãƒˆå†…å®¹ã‚’è¨˜è¼‰ -->
            
            ### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
            <!-- å•é¡Œç™ºç”Ÿæ™‚ã®å¯¾å‡¦æ³•ã‚’è¨˜è¼‰ -->
            
            ---
            ${{ steps.summary.outputs.summary }}
            
            ---
            âš ï¸ **ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ‰ãƒ©ãƒ•ãƒˆã§ã™ã€‚å†…å®¹ã‚’ç¢ºèªãƒ»æ›´æ–°ã—ã¦ãã ã•ã„ã€‚**`,
                draft: true
              });
              
              // ãƒ©ãƒ™ãƒ«è¿½åŠ ï¼ˆæ—¢ã«å­˜åœ¨ç¢ºèªæ¸ˆã¿ï¼‰
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['terraform', 'draft']
              });
              
              // ä½œæˆè€…ã‚’ã‚¢ã‚µã‚¤ãƒ³
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                assignees: [context.actor]
              });
              
              console.log(`âœ… Created Draft PR #${pr.number}`);
              return pr.number;
              
            } catch (error) {
              console.error('Failed to create PR:', error);
              throw error;
            }
          result-encoding: string
      
      # æ—¢å­˜PRã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆæ—¢å­˜PRãŒã‚ã‚‹å ´åˆï¼‰
      - name: Comment on existing PR
        if: steps.check-pr.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-pr.outputs.result }}');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `### ğŸ”„ æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ
            
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Author:** @${context.actor}
            **Branch:** \`${context.ref.replace('refs/heads/', '')}\`
            
            ${{ steps.summary.outputs.summary }}
            
            **è©³ç´°:** [Actions Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
            
            console.log(`âœ… Added comment to PR #${prNumber}`);
      
      # ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã®è¿½åŠ ï¼ˆActions UIã§è¦‹ã‚„ã™ãï¼‰
      - name: Add Job Summary
        if: always()
        run: |
          echo "## ğŸ“Š Terraform CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.summary.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-pr.outputs.result }}" != "" ]; then
            echo "### ğŸ“Œ Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- PR: #${{ steps.check-pr.outputs.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Existing PR updated with comment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.create-pr.outputs.result }}" != "" ]; then
            echo "### ğŸ“Œ Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- PR: #${{ steps.create-pr.outputs.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Status: New Draft PR created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the check results above" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any formatting or validation issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`terraform plan\` locally to verify changes" >> $GITHUB_STEP_SUMMARY
          echo "4. Update PR description with details" >> $GITHUB_STEP_SUMMARY
          echo "5. Mark PR as ready for review when complete" >> $GITHUB_STEP_SUMMARY