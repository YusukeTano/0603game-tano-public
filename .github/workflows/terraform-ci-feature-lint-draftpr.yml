name: Infra Feature Push (Lint + Plan dev via Hub)

on:
  push:
    branches: ['feature/**']
    paths:
      - 'infra/**'
      - '.tflint.hcl'
      - '.terraform-version'
      - '.github/workflows/terraform-ci-feature-lint-draftpr.yml'

# æ—¢å®šã¯æœ€å°æ¨©é™ã€‚Planç³»ã®ã‚¸ãƒ§ãƒ–ã§ id-token ç­‰ã‚’è¿½åŠ 
permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
  TFLINT_PLUGIN_DIR: /home/runner/.tflint.d/plugins
  TFLINT_VERSION: v0.53.0
  AWS_REGION: ap-northeast-1
  HUB_ACCOUNT_ID: "318574063927"    # â† ãƒãƒ–ï¼ˆè¸ã¿å°ï¼‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID
  WORKDIR_DEV: "infra/static-website/environments/dev"

concurrency:
  group: lint-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---- Lint/Validate/TFLint + æ—¢å­˜PRã¸ãƒã‚§ãƒƒã‚¯çµæœã‚³ãƒ¡ãƒ³ãƒˆ ----
  lint-summary:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      lint_ok: ${{ steps.gate.outputs.lint_ok }}
      pr_number: ${{ steps.check-pr.outputs.number }}
      fmt: ${{ steps.collect.outputs.fmt }}
      validate: ${{ steps.collect.outputs.validate }}
      tflint: ${{ steps.collect.outputs.tflint }}

    steps:
      - uses: actions/checkout@v4

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ${{env.TF_PLUGIN_CACHE_DIR}}
          key: ${{ runner.os }}-tfplugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: ${{ runner.os }}-tfplugins-

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ${{ env.TFLINT_PLUGIN_DIR }}
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl', '**/.tflint.hcl') }}
          restore-keys: ${{ runner.os }}-tflint-

      - name: Create plugin cache dir
        run: |
          mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}
          mkdir -p ${{ env.TFLINT_PLUGIN_DIR }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ env.WORKDIR_DEV }}
        run: terraform fmt -check -recursive 
        continue-on-error: true

      - name: Terraform Validate (backend=false)
        id: validate
        run: |
          dir="${{ env.WORKDIR_DEV }}"
          if [ -d "$dir" ]; then
            echo "::group::Validating $dir"
            pushd "$dir" > /dev/null
            terraform init -backend=false -input=false -lockfile=readonly
            terraform validate -no-color
            popd > /dev/null
            echo "::endgroup::"
          fi
        continue-on-error: true

      - name: TFLint
        id: tflint
        working-directory: ${{ env.WORKDIR_DEV }}
        run: |
          tflint --init
          tflint --recursive
        continue-on-error: true

      # ğŸ‘‡ fmt/validate/tflint ã® outcome ã‚’å¾Œç¶šã‚¸ãƒ§ãƒ–ã¸æ¸¡ã™
      - name: Collect step outcomes
        id: collect
        run: |
          echo "fmt=${{ steps.fmt.outcome }}"       >> "$GITHUB_OUTPUT"
          echo "validate=${{ steps.validate.outcome }}" >> "$GITHUB_OUTPUT"
          echo "tflint=${{ steps.tflint.outcome }}" >> "$GITHUB_OUTPUT"

      # ğŸ‘‡ 3ã¤å…¨éƒ¨ success ã®ã¨ãã ã‘ plan ã‚’è¨±å¯ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’å‡ºåŠ›
      - name: Decide plan gate
        id: gate
        run: |
          ok=true
          [ "${{ steps.fmt.outcome }}" = "success" ] || ok=false
          [ "${{ steps.validate.outcome }}" = "success" ] || ok=false
          [ "${{ steps.tflint.outcome }}" = "success" ] || ok=false
          echo "lint_ok=$ok" >> "$GITHUB_OUTPUT"

      # æ—¢å­˜ã®PRã‚’æ¤œå‡ºï¼ˆä½œæˆã¯ã—ãªã„ï¼‰
      - name: Check for existing PR
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });
            core.setOutput('number', prs.length ? prs[0].number.toString() : '');

      # PRãŒãƒ‰ãƒ©ãƒ•ãƒˆã§ãªã„ãªã‚‰è­¦å‘Šã ã‘ï¼ˆä»»æ„ï¼‰
      - name: Warn if PR is not Draft
        if: steps.check-pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-pr.outputs.number }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            if (!pr.draft) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **æ³¨æ„**: ã“ã®PRã¯ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™ãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nTerraformã®ãƒã‚§ãƒƒã‚¯çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
            }
        continue-on-error: true

      # æ—¢å­˜PRã¸ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Create Check Summary text
        id: summary
        run: |
          {
            echo "### ğŸ” Terraform Check Results"
            echo
            echo "| Check | Status |"
            echo "|-------|--------|"

            if [ "${{ steps.fmt.outcome }}" = "success" ]; then
              echo "| Format   | âœ… Pass |"
            else
              echo "| Format   | âŒ Fail |"
            fi

            if [ "${{ steps.validate.outcome }}" = "success" ]; then
              echo "| Validate | âœ… Pass |"
            else
              echo "| Validate | âš ï¸ Warning |"
            fi

            if [ "${{ steps.tflint.outcome }}" = "success" ]; then
              echo "| TFLint   | âœ… Pass |"
            else
              echo "| TFLint   | âš ï¸ Warning |"
            fi
          } > summary.md

          {
            echo "summary<<EOF"
            cat summary.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"


      - name: Comment on existing PR
        if: steps.check-pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check-pr.outputs.number }}');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `### ğŸ”„ æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ

            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Author:** @${context.actor}
            **Branch:** \`${context.ref.replace('refs/heads/', '')}\`

            ${{ steps.summary.outputs.summary }}

            **è©³ç´°:** [Actions Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

      - name: Add Job Summary
        if: always()
        run: |
          echo "## ğŸ“Š Terraform CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.summary.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-pr.outputs.number }}" != "" ]; then
            echo "### ğŸ“Œ Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- PR: #${{ steps.check-pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Existing PR updated with comment" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“Œ Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- Status: No open PR. (Creation disabled)" >> $GITHUB_STEP_SUMMARY
          fi

  # ---- dev ã ã‘ Terraform Planï¼ˆHubâ†’dev ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ï¼‰ã€‚lintæˆåŠŸæ™‚ã®ã¿ ----
  plan-dev:
    needs: [lint-summary]
    if: ${{ needs.lint-summary.outputs.lint_ok == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      # âœ… Terraform ã‚’ 1.9.2 ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      # âœ… jq ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã¯ä»»æ„ï¼‰
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          echo "Using jq: $(jq --version)"

      # ï¼ˆä»»æ„ãƒ»å®‰å®šåŒ–ï¼‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…ˆã«ä½œæˆ
      - name: Create plugin cache dir
        run: mkdir -p "${{ env.TF_PLUGIN_CACHE_DIR }}"

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-tfplugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: ${{ runner.os }}-tfplugins-

      # 1) ã¾ãšãƒãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« OIDC ã§ Assume
      - name: Assume Hub (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.HUB_ACCOUNT_ID }}:role/GitHubActionsHubRole
          role-session-name: gha-hub-${{ github.run_id }}-${{ github.actor }}
          aws-region: ${{ env.AWS_REGION }}

      # initï¼ˆæ—¢å®šï¼‰
      - name: Terraform Init (backend in DEV)
        working-directory: ${{ env.WORKDIR_DEV }}
        run: terraform init -input=false -lockfile=readonly -upgrade=false

      - name: Terraform Plan (dev)
        id: tfplan
        working-directory: ${{ env.WORKDIR_DEV }}
        run: |
          set -eo pipefail
          terraform plan -no-color -input=false -lock-timeout=60s -out=tf.plan | tee plan.txt
          terraform show -json tf.plan > tfplan.json

          creates=$(jq '[.resource_changes[]? | select(.change.actions | index("create"))] | length' tfplan.json)
          replaces=$(jq '[.resource_changes[]? | select(.change.actions | index("replace"))] | length' tfplan.json)
          updates=$(jq '[.resource_changes[]? | select(.change.actions | index("update"))] | length' tfplan.json)
          deletes=$(jq '[.resource_changes[]? | select(.change.actions | index("delete"))] | length' tfplan.json)

          creates=$((creates + replaces))
          deletes=$((deletes + replaces))

          echo "creates=$creates" >> $GITHUB_OUTPUT
          echo "updates=$updates" >> $GITHUB_OUTPUT
          echo "deletes=$deletes" >> $GITHUB_OUTPUT

      - name: Build plan comment (dev)
        id: body
        working-directory: ${{ env.WORKDIR_DEV }}
        run: |
          {
            echo "### Terraform Plan \`dev\`  (+${{ steps.tfplan.outputs.creates }} / ~${{ steps.tfplan.outputs.updates }} / -${{ steps.tfplan.outputs.deletes }})"
            echo
            echo "**Base:** \`main\`  | **Ref:** \`${GITHUB_SHA::7}\`  | **Dir:** \`${{ env.WORKDIR_DEV }}\`"
            echo
            echo "<details><summary>Show full plan</summary>"
            echo
            echo '```'
            cat plan.txt
            echo '```'
            echo
            echo "</details>"
          } > body.md

      - name: Find existing PR (for comment)
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'main',
              state: 'open'
            });
            core.setOutput('number', prs.length ? prs[0].number.toString() : '');

      - name: Comment plan to PR (dev)
        if: steps.find-pr.outputs.number != ''
        run: gh pr comment ${{ steps.find-pr.outputs.number }} --body-file "${{ env.WORKDIR_DEV }}/body.md"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Attach plan snippet to Job Summary (dev)
        run: |
          echo "## ğŸ§® Plan dev (+${{ steps.tfplan.outputs.creates }} / ~${{ steps.tfplan.outputs.updates }} / -${{ steps.tfplan.outputs.deletes }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Show full plan</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sed -n '1,400p' "${{ env.WORKDIR_DEV }}/plan.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # ---- Lintå¤±æ•—æ™‚ï¼šPlanã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸç†ç”±ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRãŒã‚ã‚‹å ´åˆï¼‰----
  comment-why-skip:
    needs: [lint-summary]
    if: ${{ needs.lint-summary.outputs.lint_ok != 'true' && needs.lint-summary.outputs.pr_number != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Explain why plan was skipped
        run: |
          gh pr comment ${{ needs.lint-summary.outputs.pr_number }} --body "$(cat <<'MD'
          ### â­ï¸ Plan skipped
          Lint/Validate/TFLint ã®ã„ãšã‚Œã‹ãŒå¤±æ•—ã—ãŸãŸã‚ã€ã“ã® push ã§ã¯ **Terraform plan ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã›ã‚“**ã€‚

          - Format:  ${{ needs.lint-summary.outputs.fmt }}
          - Validate: ${{ needs.lint-summary.outputs.validate }}
          - TFLint:   ${{ needs.lint-summary.outputs.tflint }}

          å¤±æ•—ç®‡æ‰€ã‚’ä¿®æ­£å¾Œã€å† push ã—ã¦ãã ã•ã„ã€‚
          MD
          )"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
