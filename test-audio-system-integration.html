<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioSystem Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #2a2a2a;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #333;
        }
        .success { background-color: #2d5a2d; }
        .error { background-color: #5a2d2d; }
        .warning { background-color: #5a5a2d; }
        .log {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            display: inline-block;
            width: 120px;
        }
        input[type="range"] {
            width: 200px;
        }
        .value-display {
            display: inline-block;
            width: 60px;
            color: #ffa500;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸµ AudioSystem ã‚²ãƒ¼ãƒ çŠ¶æ…‹é€£æºãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–çŠ¶æ…‹</h2>
        <div id="init-status" class="status">åˆæœŸåŒ–ä¸­...</div>
        <button onclick="initializeTest()">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
        <div class="log" id="init-log"></div>
    </div>

    <div class="test-section">
        <h2>2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        <div class="slider-container">
            <label>ã‚³ãƒ³ãƒœæ•°:</label>
            <input type="range" id="combo-slider" min="0" max="50" value="0" oninput="updateCombo(this.value)">
            <span class="value-display" id="combo-value">0</span>
        </div>
        <div class="slider-container">
            <label>æ”»æ’ƒã‚¹ã‚­ãƒ«Lv:</label>
            <input type="range" id="damage-slider" min="0" max="20" value="0" oninput="updateDamageSkill(this.value)">
            <span class="value-display" id="damage-value">0</span>
        </div>
        <div class="slider-container">
            <label>é€£å°„ã‚¹ã‚­ãƒ«Lv:</label>
            <input type="range" id="firerate-slider" min="0" max="20" value="0" oninput="updateFireRateSkill(this.value)">
            <span class="value-display" id="firerate-value">0</span>
        </div>
        <div id="game-state-status" class="status">ã‚³ãƒ³ãƒœ: 0, æ”»æ’ƒLv: 0, é€£å°„Lv: 0</div>
    </div>

    <div class="test-section">
        <h2>3. æ­¦å™¨åˆ¥å°„æ’ƒéŸ³ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-controls">
            <button onclick="testShootSound('plasma')">Plasma</button>
            <button onclick="testShootSound('nuke')">Nuke</button>
            <button onclick="testShootSound('superHoming')">Super Homing</button>
            <button onclick="testShootSound('superShotgun')">Super Shotgun</button>
        </div>
        <div id="shoot-status" class="status">å°„æ’ƒéŸ³ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­</div>
        <div class="log" id="shoot-log"></div>
    </div>

    <div class="test-section">
        <h2>4. ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ®µéšãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-controls">
            <button onclick="testComboLevel(0)">ã‚³ãƒ³ãƒœ 0</button>
            <button onclick="testComboLevel(6)">ã‚³ãƒ³ãƒœ 6</button>
            <button onclick="testComboLevel(16)">ã‚³ãƒ³ãƒœ 16</button>
            <button onclick="testComboLevel(26)">ã‚³ãƒ³ãƒœ 26</button>
            <button onclick="testComboLevel(35)">ã‚³ãƒ³ãƒœ 35</button>
        </div>
        <div id="combo-effect-status" class="status">ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­</div>
        <div class="log" id="combo-effect-log"></div>
    </div>

    <div class="test-section">
        <h2>5. é€£ç¶šå°„æ’ƒãƒ†ã‚¹ãƒˆï¼ˆã‚²ãƒ¼ãƒ çŠ¶æ…‹é€£æºç¢ºèªï¼‰</h2>
        <div class="test-controls">
            <button onclick="startRapidFire()">é€£ç¶šå°„æ’ƒé–‹å§‹</button>
            <button onclick="stopRapidFire()">åœæ­¢</button>
        </div>
        <div id="rapid-fire-status" class="status">é€£ç¶šå°„æ’ƒãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­</div>
        <div class="log" id="rapid-fire-log"></div>
    </div>

    <script type="module">
        // ãƒ¢ãƒƒã‚¯ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let mockGame = null;
        let mockAudioSystem = null;
        let rapidFireInterval = null;
        let testResults = {
            initialization: false,
            gameStateAccess: false,
            shootSounds: false,
            comboEffects: false,
            continuousShoot: false
        };

        // ãƒ­ã‚°å‡ºåŠ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function logToElement(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
                element.scrollTop = element.scrollHeight;
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼  
        function updateStatus(elementId, message, type = 'status') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        }

        // ãƒ¢ãƒƒã‚¯ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        function createMockGame() {
            return {
                combo: {
                    count: 0,
                    maxCombo: 0
                },
                player: {
                    skillLevels: {
                        damage: 0,
                        fireRate: 0,
                        bulletSize: 0,
                        piercing: 0,
                        multiShot: 0,
                        bounce: 0,
                        homing: 0,
                        range: 0,
                        itemAttraction: 0,
                        luck: 0
                    }
                }
            };
        }

        // AudioSystemãƒ¢ãƒƒã‚¯
        class MockAudioSystem {
            constructor(game) {
                this.game = game;
                this.isInitialized = false;
                this.shootSoundConfig = {
                    weapons: {
                        plasma: { baseFreq: 800, filterRange: [800, 2000], pitchVariation: 0.2, duration: 0.08, character: 'sharp' },
                        nuke: { baseFreq: 300, filterRange: [200, 800], pitchVariation: 0.1, duration: 0.25, character: 'heavy' },
                        superHoming: { baseFreq: 600, filterRange: [500, 1500], pitchVariation: 0.15, duration: 0.12, character: 'electronic' },
                        superShotgun: { baseFreq: 400, filterRange: [300, 2000], pitchVariation: 0.08, duration: 0.08, character: 'explosive' }
                    },
                    comboEffects: {
                        0: { intensity: 1.0, reverb: 0.0, filter: 1.0 },
                        6: { intensity: 1.1, reverb: 0.1, filter: 1.2 },
                        16: { intensity: 1.3, reverb: 0.2, filter: 1.5 },
                        26: { intensity: 1.5, reverb: 0.3, filter: 2.0 }
                    }
                };
            }

            async initialize() {
                try {
                    this.isInitialized = true;
                    return { success: true, message: 'Mock AudioSystem initialized successfully' };
                } catch (error) {
                    return { success: false, message: 'Initialization failed: ' + error.message };
                }
            }

            playShootSound(weaponType = 'plasma') {
                if (!this.isInitialized) {
                    return { success: false, message: 'AudioSystem not initialized' };
                }

                try {
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹å–å¾—ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const comboCount = this.game?.combo?.count || 0;
                    const skillLevel = this.game?.player?.skillLevels?.damage || 0;
                    
                    // å°„æ’ƒéŸ³è¨­å®šå–å¾—
                    const config = this.shootSoundConfig.weapons[weaponType];
                    const comboEffect = this.getComboEffect(comboCount);
                    
                    // å®Ÿéš›ã®éŸ³å†ç”Ÿã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const result = {
                        success: true,
                        weaponType,
                        comboCount,
                        skillLevel,
                        config,
                        comboEffect,
                        message: `${weaponType} shot played (Combo: ${comboCount}, Skill: ${skillLevel})`
                    };

                    if (comboCount > 0 && comboCount % 5 === 0) {
                        result.message += ' [Enhanced by combo!]';
                    }

                    return result;
                } catch (error) {
                    return { success: false, message: 'Shoot sound failed: ' + error.message };
                }
            }

            getComboEffect(comboCount) {
                const effects = this.shootSoundConfig.comboEffects;
                let currentEffect = effects[0];
                
                for (const [threshold, effect] of Object.entries(effects)) {
                    if (comboCount >= parseInt(threshold)) {
                        currentEffect = effect;
                    }
                }
                
                return currentEffect;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.initializeTest = async function() {
            logToElement('init-log', 'Creating mock game object...');
            
            mockGame = createMockGame();
            mockAudioSystem = new MockAudioSystem(mockGame);
            
            logToElement('init-log', 'Initializing AudioSystem...');
            const result = await mockAudioSystem.initialize();
            
            if (result.success) {
                updateStatus('init-status', 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                logToElement('init-log', 'SUCCESS: ' + result.message);
                testResults.initialization = true;
                
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                testGameStateAccess();
            } else {
                updateStatus('init-status', 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—', 'error');
                logToElement('init-log', 'ERROR: ' + result.message);
            }
        };

        function testGameStateAccess() {
            try {
                // ã‚³ãƒ³ãƒœæ•°ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                const comboAccess = mockGame?.combo?.count !== undefined;
                // ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ  
                const skillAccess = mockGame?.player?.skillLevels?.damage !== undefined;
                
                if (comboAccess && skillAccess) {
                    testResults.gameStateAccess = true;
                    logToElement('init-log', 'SUCCESS: Game state access verified');
                } else {
                    logToElement('init-log', 'ERROR: Game state access failed');
                }
            } catch (error) {
                logToElement('init-log', 'ERROR: Game state access test failed: ' + error.message);
            }
        }

        window.updateCombo = function(value) {
            if (mockGame) {
                mockGame.combo.count = parseInt(value);
                document.getElementById('combo-value').textContent = value;
                updateGameStateDisplay();
            }
        };

        window.updateDamageSkill = function(value) {
            if (mockGame) {
                mockGame.player.skillLevels.damage = parseInt(value);
                document.getElementById('damage-value').textContent = value;
                updateGameStateDisplay();
            }
        };

        window.updateFireRateSkill = function(value) {
            if (mockGame) {
                mockGame.player.skillLevels.fireRate = parseInt(value);
                document.getElementById('firerate-value').textContent = value;
                updateGameStateDisplay();
            }
        };

        function updateGameStateDisplay() {
            if (mockGame) {
                const status = `ã‚³ãƒ³ãƒœ: ${mockGame.combo.count}, æ”»æ’ƒLv: ${mockGame.player.skillLevels.damage}, é€£å°„Lv: ${mockGame.player.skillLevels.fireRate}`;
                updateStatus('game-state-status', status, 'success');
            }
        }

        window.testShootSound = function(weaponType) {
            if (!mockAudioSystem) {
                updateStatus('shoot-status', 'AudioSystemæœªåˆæœŸåŒ–', 'error');
                return;
            }

            const result = mockAudioSystem.playShootSound(weaponType);
            
            if (result.success) {
                updateStatus('shoot-status', result.message, 'success');
                logToElement('shoot-log', `${result.weaponType}: Combo=${result.comboCount}, Skill=${result.skillLevel}, Intensity=${result.comboEffect.intensity}`);
                testResults.shootSounds = true;
            } else {
                updateStatus('shoot-status', result.message, 'error');
                logToElement('shoot-log', 'ERROR: ' + result.message);
            }
        };

        window.testComboLevel = function(comboLevel) {
            if (!mockGame) {
                updateStatus('combo-effect-status', 'GameæœªåˆæœŸåŒ–', 'error');
                return;
            }

            mockGame.combo.count = comboLevel;
            document.getElementById('combo-slider').value = comboLevel;
            document.getElementById('combo-value').textContent = comboLevel;
            updateGameStateDisplay();

            const result = mockAudioSystem.playShootSound('plasma');
            if (result.success) {
                updateStatus('combo-effect-status', `ã‚³ãƒ³ãƒœ${comboLevel}ã§ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç¢ºèªå®Œäº†`, 'success');
                logToElement('combo-effect-log', `Combo ${comboLevel}: Intensity=${result.comboEffect.intensity}, Reverb=${result.comboEffect.reverb}, Filter=${result.comboEffect.filter}`);
                testResults.comboEffects = true;
            } else {
                updateStatus('combo-effect-status', 'ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—', 'error');
                logToElement('combo-effect-log', 'ERROR: ' + result.message);
            }
        };

        window.startRapidFire = function() {
            if (!mockAudioSystem) {
                updateStatus('rapid-fire-status', 'AudioSystemæœªåˆæœŸåŒ–', 'error');
                return;
            }

            let shotCount = 0;
            const weapons = ['plasma', 'nuke', 'superHoming', 'superShotgun'];
            
            updateStatus('rapid-fire-status', 'é€£ç¶šå°„æ’ƒä¸­...', 'warning');
            logToElement('rapid-fire-log', 'Starting rapid fire test...');

            rapidFireInterval = setInterval(() => {
                const weaponType = weapons[shotCount % weapons.length];
                
                // ã‚³ãƒ³ãƒœã‚’å¾ã€…ã«å¢—åŠ 
                mockGame.combo.count = Math.floor(shotCount / 2);
                document.getElementById('combo-slider').value = mockGame.combo.count;
                document.getElementById('combo-value').textContent = mockGame.combo.count;
                updateGameStateDisplay();

                const result = mockAudioSystem.playShootSound(weaponType);
                if (result.success) {
                    logToElement('rapid-fire-log', `Shot ${shotCount + 1}: ${result.message}`);
                } else {
                    logToElement('rapid-fire-log', `Shot ${shotCount + 1} FAILED: ${result.message}`);
                }

                shotCount++;
                
                if (shotCount >= 20) {
                    window.stopRapidFire();
                    testResults.continuousShoot = true;
                }
            }, 200);
        };

        window.stopRapidFire = function() {
            if (rapidFireInterval) {
                clearInterval(rapidFireInterval);
                rapidFireInterval = null;
                updateStatus('rapid-fire-status', 'é€£ç¶šå°„æ’ƒå®Œäº†', 'success');
                logToElement('rapid-fire-log', 'Rapid fire test completed.');
                
                // æœ€çµ‚çµæœè¡¨ç¤º
                showFinalResults();
            }
        };

        function showFinalResults() {
            const results = [];
            results.push(`1. ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–: ${testResults.initialization ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            results.push(`2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚¢ã‚¯ã‚»ã‚¹: ${testResults.gameStateAccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            results.push(`3. å°„æ’ƒéŸ³å†ç”Ÿ: ${testResults.shootSounds ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            results.push(`4. ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆ: ${testResults.comboEffects ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            results.push(`5. é€£ç¶šå°„æ’ƒ: ${testResults.continuousShoot ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            
            const allPassed = Object.values(testResults).every(result => result);
            
            logToElement('rapid-fire-log', '\n=== æœ€çµ‚ãƒ†ã‚¹ãƒˆçµæœ ===');
            results.forEach(result => logToElement('rapid-fire-log', result));
            logToElement('rapid-fire-log', `\nç·åˆçµæœ: ${allPassed ? 'âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ' : 'âŒ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—'}`);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AudioSystem Integration Test loaded');
        });
    </script>
</body>
</html>