# 開発状況
同じブランチで4人で作業してるので、ファイル編集競合が起こる可能性を加味して作業しましょう。

# ゲーム開発TODO（優先度別）

## 完了済み ✅

### **999ウェーブシステム完全実装** (2025-06-16実装完了)
- **実装ファイル**: 
  - `js/systems/wave-system.js` (新規作成 - 999ウェーブシステム本体)
  - `js/utils/enemy-pool.js` (新規作成 - 敵オブジェクトプール)
  - `js/systems/enemy-system.js` (大量敵スポーン対応・プール統合)
  - `js/systems/ui-system.js` (ウェーブ演出・進行度UI追加)
  - `js/systems/audio-system.js` (ウェーブクリア音響効果追加)
  - `game.js` (システム統合・デバッグコマンド追加)
- **仕様変更**:
  - **ステージ廃止**: 4ステージ×4ウェーブ制からウェーブ単独制に変更
  - **時間制限廃止**: 30秒タイマー削除、全敵撃破によるウェーブクリア
  - **999ウェーブ**: Wave 1からWave 999までの長期プレイ対応
  - **3段階成長カーブ**: Wave 1-10(初級) → Wave 11-100(成長) → Wave 101-999(本格)
- **敵数設計**:
  - Wave 1: 3体 → Wave 10: 10体 → Wave 200: 67体 → Wave 999: 200体
  - 最大200体制限による大量戦闘対応
- **技術実装**:
  - **敵オブジェクトプール**: 最大300体の事前生成・再利用システム
  - **バッチスポーン**: 50体以上での最適化処理
  - **円形配置アルゴリズム**: 重複回避・均等配置
  - **ウェーブ演出システム**: 開始・クリア・予告の3段階演出
  - **リアルタイムUI**: 進行度バー・敵残数表示
  - **パーティクルエフェクト**: ウェーブクリア祝福・999ウェーブ完全クリア演出
- **システム切り替え**:
  - **デバッグコマンド**: `game.enable999WaveSystem()` で新システム有効化
  - **安全な移行**: 旧システムとの共存・切り替え可能
  - **豊富なデバッグ機能**: プール統計・ウェーブ情報・パフォーマンス監視
- **パフォーマンス最適化**:
  - オブジェクト生成・削除コスト削減（最大90%削減）
  - 大量敵戦闘時のフレームレート安定化
  - メモリ使用量最適化
- **ゲームプレイ改善**:
  - **確実な進歩感**: 各ウェーブの明確な目標
  - **長期モチベーション**: 999ウェーブという壮大な挑戦
  - **スケーラブル難易度**: 後半の指数的難易度上昇
  - **達成感演出**: 各ウェーブクリア時の祝福エフェクト

### **射程アイテム専用デザイン実装** (2025-06-16実装完了)
- **実装ファイル**: `js/systems/render-system.js` (射程アイテム描画メソッド追加)
- **問題解決**: 射程アイテムが「水色の丸」になっていた問題を修正
- **原因**: switch文に`case 'range':`が存在せず、汎用描画にフォールバックしていた
- **新デザイン**:
  - **十字準星スコープ**: スナイパー風の精密照準デザイン
  - **二重リング**: 外側12px + 中間8px の同心円
  - **隙間つき十字**: 中央3px隙間で視認性向上
  - **中央精密ドット**: 白い照準点（半径2px）
  - **4隅照準マーク**: 射程範囲を表現する角マーク
  - **パルスエフェクト**: 1.0±0.1スケール変動
  - **グローエフェクト**: 水色発光（12+4px ブラー）
- **技術実装**: `_renderRangePickup()`メソッド新規作成、時間ベースアニメーション
- **視覚的効果**: 他アイテムと明確に区別可能、射程機能が直感的に理解できるデザイン

### **運スキルシステム** (2025-06-16実装完了)
- **実装ファイル**: 
  - `js/entities/player.js` (運ボーナス計算メソッド追加)
  - `js/utils/skill-level-calculator.js` (運スキル対応追加)
  - `js/systems/level-system.js` (運スキル定義・レアリティ調整追加)
  - `js/systems/pickup-system.js` (ドロップ武器確率に運ボーナス適用)
  - `js/systems/ui-system.js` (運スキル表示対応)
- **機能詳細**:
  - 2段階成長システム: Lv.1-15は+15%/レベル、Lv.16+は+20%/レベル
  - 5段階運スキル: 運I(Common)→運II(Uncommon)→運III(Rare)→幸運の加護(Epic)→運命操作(Legendary)
  - ドロップ武器確率向上: Lv.30で各武器1.875%（通常の6.2倍）、合計5.62%
  - スキル選択レアリティ向上: 高レアスキル出現率が大幅アップ
  - 特殊効果: 幸運の加護(ドロップ数+1)、運命操作(Epic以上確率+50%)
- **技術実装**: 動的計算システム・重み付き確率調整・線形成長制御
- **バランス設計**: Lv.30で目標5%超達成、Lv.50でも10%以下に制御

### **ゲーム統一色システム実装** (2025-06-16実装完了)
- **実装ファイル**: 
  - `style.css` (CSS変数パレット追加)
  - `js/utils/combo-color-system.js` (10段階コンボ色)
  - `js/systems/level-system.js` (レアリティ色統一)
  - `js/systems/ui-system.js` (ステータス・コンボ表示色)
  - `js/systems/weapon-system.js`, `js/systems/render-system.js`, `js/entities/bullet.js` (コンボ色適用)
- **新統一カラーパレット**:
  - **グレー系**: Common/Lv.0 `#9E9E9E`
  - **青系**: Uncommon/Lv.1-3 `#2196F3`
  - **緑系**: Rare/Lv.4-6 `#4CAF50`
  - **赤系**: Epic/Lv.7-9 `#F44336`
  - **金系**: Legendary/Lv.10-14 `#FF9800`
  - **レインボー**: Lv.15+ (HSV色相回転)
- **10段階コンボ弾丸色システム**:
  ```
  0-2:グレー → 3-5:グレー青 → 6-8:青 → 9-11:青緑 → 12-14:緑
  → 15-17:緑赤 → 18-20:赤 → 21-23:赤金 → 24-26:金 → 27-29:明金 → 30+:レインボー
  ```
- **統一された要素**:
  - スキルレアリティ色・スキルレベル表示色・コンボ弾丸色・コンボ表示色・レアリティラベル色
  - 体力バー・経験値バー・クロスヘア・ゲームオーバー画面等のUI色
- **視覚効果改善**:
  - CSS変数による保守性向上・自然な寒色→暖色進行・グラデーション中間色で滑らかな変化
  - グロー強度の段階的調整・特殊エフェクト（緑12コンボ以上）・サイズボーナス（0-200%）
- **技術実装**: 
  - Factory Pattern + Strategy Patternで既存アーキテクチャに統合
  - コンボ値は`game.combo.count`で管理・Bulletクラスでレインボー色相の動的更新実装

### **コンボリセット仕様変更** (2025-06-16実装完了)
- **変更内容**: タイムアウト自動リセットを削除し、ダメージ時のみリセットに変更
- **修正ファイル**: `game.js` (5箇所の修正)
- **削除内容**:
  - タイムアウトチェック処理（3秒自動リセット機能）
  - 不要プロパティ（`lastKillTime`, `comboTimeout`）
  - 旧式ダメージ処理メソッド（`damagePlayerObsolete`）
- **新仕様**:
  - **リセット条件**: プレイヤーがダメージを受けた時のみ
  - **維持条件**: 敵を倒し続ける限りコンボ継続
  - **バリア効果**: バリア中はダメージ無効でコンボ維持
- **アーキテクチャ改善**: State Management Patternによるシンプルなコンボ状態管理
- **ゲームプレイ影響**: ハードコアモード、スキル重視のゲームデザインに変更

### **ベース武器ガード型武器システム** (2025-06-16実装完了)
- **実装ファイル**: `js/systems/weapon-system.js` (6箇所の修正)
- **問題解決**: ドロップ武器を複数回切り替えた後、通常武器に戻らない問題を完全修正
- **技術実装**:
  - `baseWeapon`プロパティ追加: 常にplasmaを保持する専用プロパティ
  - **ベース武器保護ロジック**: 一時武器→一時武器の切り替えでもベース武器を保護
  - **弾切れ復帰ロジック修正**: `previousWeapon`→`baseWeapon`に変更
  - **リセット処理強化**: ゲーム開始時にbaseWeaponも初期化
- **修正箇所詳細**:
  - Constructor: `this.baseWeapon = 'plasma'`追加
  - `equipNukeLauncher()`, `equipSuperHomingGun()`, `equipSuperShotgun()`: ベース武器保護ロジック実装
  - `shootWithWeapon()`: 弾切れ時`this.baseWeapon`に復帰
  - `reset()`: `this.baseWeapon = 'plasma'`もリセット
- **対応シナリオ**: 
  - 基本: 通常武器→ドロップ武器A→弾切れ → plasmaに復帰
  - 複合: 通常武器→ドロップ武器A→ドロップ武器B→弾切れ → plasmaに復帰
  - 重複: ドロップ武器A装備中→同じドロップ武器A再取得 → 弾薬補充のみ、baseWeapon変更なし
  - 複雑: plasma→nuke→superHoming→superShotgun→弾切れ → plasmaに復帰
- **堅牢性**: あらゆる実用的なドロップ武器シナリオに対応した確実なシステム

### **ドロップ武器弾サイズ統一・バグ修正** (2025-06-15～2025-06-16)  
- ニューク・スーパーホーミング武器でプレイヤーの弾サイズスキルが反映されない問題を修正
- 全ドロップ武器でプレイヤーの`bulletSizeMultiplier`が適用されるよう統一
- **スーパーショットガンコンボ値参照バグ修正**: `this.game.player.combo` → `this.game.combo.count`に修正（2025-06-16）
- **コンボサイズ効果統一**: 全武器でコンボによる弾丸サイズ増加（最大200%）が正常動作
- 修正ファイル: `js/systems/weapon-system.js`

### **パイロットイン分身システム削除** (2025-06-15)
- **PlayerClone.jsファイル削除**: `/public/js/entities/player-clone.js`を完全削除
- **Player.js修正**: 分身関連プロパティとメソッドを削除
  - `this.pilotInChance`, `this.clones`プロパティ削除
  - `manageClones()`, `createClones()`, `updateClones()`メソッド削除
  - 分身関連の初期化・リセット処理削除
- **WeaponSystem.js修正**: 分身射撃処理を削除
  - `_handlePilotInShooting()`メソッド削除
- **RenderSystem.js修正**: 分身描画処理を削除
  - `renderPlayerClones()`, `_renderSingleClone()`, `_renderCloneAura()`, `_renderCloneBody()`メソッド削除
- **LevelSystem.js修正**: パイロットインスキル削除
  - パイロットイン I/II/III スキル定義削除
- **影響**: 約400行のコード削除、パフォーマンス向上、システム複雑性軽減

### **モダンBGMシステム** (2025-06-16実装完了)
- **実装ファイル**:
  - `js/audio/modern-bgm-engine.js` (新規作成、1,350行)
  - `js/audio/synth-factory.js` (新規作成、300行)
  - `js/audio/rhythm-engine.js` (新規作成、250行)
  - `js/audio/stage-themes.js` (新規作成、450行)
  - `js/audio/progression-generator.js` (新規作成、200行)
  - `js/audio/audio-utils.js` (新規作成、100行)
  - `js/systems/audio-system.js` (ModernBGMEngine統合)
- **9ステージBGMテーマ**:
  - Stage 1: Neon Genesis (Future Pop, 120 BPM, Key: C)
  - Stage 2: Cyber Highway (Synthwave, 130 BPM, Key: Dm)
  - Stage 3: Digital Storm (Electro House, 140 BPM, Key: Em)
  - Stage 4: Chrome City (Tech House, 150 BPM, Key: F#m)
  - Stage 5: Quantum Dance (Future Bass, 160 BPM, Key: G)
  - Stage 6: Laser Pulse (Hardstyle, 170 BPM, Key: Am)
  - Stage 7: Binary Dreams (Ambient Techno, 140 BPM, Key: Bb)
  - Stage 8: Final Protocol (Epic Synthwave, 180 BPM, Key: C#m)
  - Stage 9: Victory Code (Uplifting Trance, 175 BPM, Key: D)
- **技術実装**:
  - **SynthFactory**: 高品質楽器システム（leadSynth, subBass, neonPad等）
  - **RhythmEngine**: ジャンル別ドラムパターン（25ms先読みスケジューリング）
  - **StageThemes**: 各ステージの詳細音楽設定（楽器構成・コード進行）
  - **ProgressionGenerator**: 音楽理論エンジン（スケール・コード・メロディ生成）
  - **リアルタイムシーケンサー**: 16分音符解像度・時間ベース音符スケジューリング
- **音響効果**:
  - 楽器段階的導入（8秒間隔）・エンベロープ・フィルター・エフェクト
  - Web Audio API使用・25ms先読み・複数オクターブ対応
  - ジャンル別リズムパターン・音楽理論に基づくコード進行

### **BGM一時停止システム** (2025-06-16実装完了)
- **実装ファイル**:
  - `js/audio/modern-bgm-engine.js` (pause/resume機能追加)
  - `js/systems/audio-system.js` (一時停止制御メソッド追加)
  - `js/systems/level-system.js` (スキル選択時BGM一時停止)
  - `js/systems/settings-system.js` (設定画面時BGM一時停止)
- **機能詳細**:
  - **スキル選択時**: BGM一時停止（0.5秒フェードアウト）→選択完了で再開
  - **設定画面時**: ESCキー等でBGM一時停止→画面閉鎖で再開
  - **状態保存**: BPM・シーケンサー状態・楽器情報を完全保持
  - **スムーズ復帰**: 同じ位置から音楽続行・楽器クイック導入（1秒間隔）
- **技術実装**:
  - `pause()`: fadeOutMusic()でスムーズ停止・pausedState保存
  - `resume()`: restartMusicSystems()で音楽復帰・シーケンサー状態復元
  - `isBGMPaused()`: 一時停止状態確認・安全な再開制御

### **音量調整システム** (2025-06-16実装完了)
- **実装ファイル**:
  - `js/systems/settings-system.js` (新規作成)
  - `js/systems/audio-system.js` (音量制御機能追加)
  - `index.html` (設定モーダル画面追加)
  - `style.css` (設定画面スタイル追加)
  - `game.js` (SettingsSystemの統合)
- **機能詳細**:
  - マスター音量/BGM音量/効果音音量の3段階個別調整（0-100%）
  - ミュートボタン機能（🔊/🔇アイコン切り替え）
  - 音量プリセット：「静か」(40/20/30%)「標準」(80/30/70%)「大音量」(100/60/100%)
  - リアルタイム音量反映・効果音プレビュー機能
  - localStorage設定保存・自動復元
  - レスポンシブデザイン（PC/モバイル両対応）
- **音量バランス調整** (2025-06-16):
  - **BGM音量大幅減**: 60% → 30% (ゲームプレイ重視)
  - **効果音適正化**: 30% → 70% (ゲームフィードバック重要)
  - **プリセット最適化**: 大音量でもBGM 60%で抑制
- **技術実装**: 
  - `getCalculatedVolume()`メソッドで音量計算統一
  - 全BGM・効果音に音量設定を反映
  - 設定画面のポーズ連携機能

### **スマホ横画面スキル選択UI修正** (2025-06-16実装完了)
- **実装ファイル**: `style.css` (横画面専用メディアクエリ追加)
- **修正内容**: 
  - 横画面時のスキル選択はみ出し問題を解決
  - 3カラム横並びレイアウト実装（スクロール完全排除）
  - モーダル幅を800pxに拡張、高さを85vhに制限
- **技術実装**:
  - `@media screen and (orientation: landscape) and (max-height: 500px)` 専用スタイル
  - `.upgrade-options`: `flex-direction: row` で横並び配置
  - `.upgrade-option`: `flex: 1` + `max-width: 32%` で等幅3カラム
  - フォントサイズ最適化（スキル名0.9rem、説明0.75rem、レアリティ0.65rem）
- **効果**: iPhone等の横画面でスクロールなしで3つのスキルを選択可能

### **スキルレベル常時表示システム** (2025-06-16実装完了)
- **実装ファイル**:
  - `index.html` (PC/モバイル版スキル表示HTML追加)
  - `style.css` (レベル別色分け・グロー効果・レインボー実装)
  - `js/systems/ui-system.js` (レベル表示更新・グロー効果機能追加)
  - `js/systems/level-system.js` (レベルアップ時グロー連携)
  - `js/entities/player.js` (運スキル・2段階成長システム追加)
  - `js/utils/skill-level-calculator.js` (運スキル対応)
- **機能詳細**:
  - **画面最上部中央**に10スキル常時表示（攻撃・連射・弾サ・貫通・マル・反射・ホーミ・射程・吸引・運）
  - **レベル別色分け**: Lv.0(灰) → Lv.1-3(緑) → Lv.4-6(青) → Lv.7-9(紫) → Lv.10-14(金) → **Lv.15+(レインボー)**
  - **視覚効果**: 多重box-shadow・insetグロー・text-shadowで光彩演出
  - **レベルアップ時**: 1.5秒間のグロー効果で視覚フィードバック
  - **レスポンシブ対応**: PC版10列横並び・モバイル版2行5+5列配置
  - **数字クリア表示**: 純白文字・黒縁取り・極太フォントでぼやけ解消（opacity: 0.7 → 1.0、text-shadow最適化）
- **技術実装**:
  - UISystem.updateSkillLevelsDisplay()でリアルタイム更新
  - setSkillLevelClass()で動的CSS適用
  - triggerSkillLevelUpGlow()でレベルアップ演出
  - アニメーション: skillGoldenPulse(金色)・skillRainbowPulse(虹色)・skillRainbowText(レインボー文字)

### **運スキル・2段階成長システム** (2025-06-16実装完了)
- **実装内容**: 「運 I/II/III」「幸運の加護」「運命操作」スキル追加
- **成長システム**: Lv.1-15(+15%/レベル) → Lv.16+(+20%/レベル)の2段階成長
- **効果範囲**: レアアイテム出現率・高レアスキル確率・Epic以上確率向上
- **技術実装**: Player.calculateLuckBonus()で動的計算・ゲッター実装
- **LevelSystem連携**: _applyLuckToRarityWeights()で運ボーナス適用

### **ドロップ武器確率統一システム** (2025-06-16実装完了)
- **実装ファイル**: `js/systems/pickup-system.js` (ドロップ確率調整)
- **修正内容**:
  - **レア武器確率統一**: ニューク・スーパーホーミング・スーパーショットガン全て0.3%に統一
  - **バランス調整前**: ニューク0.3%、ホーミング0.6%、ショットガン0.9% → **統一後**: 全て0.3%
  - **運スキル連携**: 全レア武器に運ボーナスが等しく適用される公平システム
- **効果**:
  - レア武器の希少性が統一され、バランスの取れたドロップシステム
  - 運スキル投資の価値向上（3種武器に等しく効果）
  - プレイヤーの期待値管理が容易に

### **反射スキルシステム修正** (2025-06-16実装完了)
- **実装ファイル**: 
  - `js/entities/bullet.js` (反射フラグロジック修正)
  - `js/systems/level-system.js` (スキル効果値・レアリティ統一)
  - `js/entities/player.js` (bounceChance・piercingChanceプロパティ初期化)
  - `js/utils/skill-level-calculator.js` (反射スキル計算式対応)
- **修正内容**:
  - **hasUsedBonusBounce問題**: 一度きりの制限を削除、複数回反射を可能に
  - **スキル効果値統一**: 10%刻みに統一（10%, 20%, 30%）でレベル計算を正確化
  - **レアリティ段階設定**: common → uncommon → rare に適切に配置
  - **プロパティ初期化**: Player.jsでbounceChance/piercingChanceを0で初期化
- **修正結果**:
  - 2回目以降も反射が正常動作
  - スキルレベルと確率が正しく連動
  - 反射性能 I/II/III の段階的取得が可能
- **技術詳細**: Multi-level Strategy Patternによる3層反射システム（確実反射・確定反射・確率反射）

### **キャラクター選択システム** (2025-06-16実装完了)
- **実装ファイル**:
  - `js/entities/character-factory.js` (新規作成)
  - `js/entities/character-luna.js` (新規作成)
  - `js/entities/character-aurum.js` (新規作成)
  - `js/entities/player.js` (キャラクター設定対応)
  - `js/systems/input-system.js` (キャラクター別入力処理)
  - `js/systems/render-system.js` (キャラクター別描画)
  - `index.html` (キャラクター選択画面追加)
  - `style.css` (キャラクター選択UI・ルナカーソル)
  - `game.js` (キャラクター選択フロー・カーソル制御)
- **3キャラクター実装**:
  - **レイ**: 標準キャラ、バランス型、WASD+マウス操作
  - **ルナ**: 初心者向け、マウス追従移動+オートエイム、可愛いカーソル
  - **オーラム**: 運特化、運レベル10スタート、レア武器取得率向上
- **キャラクター選択フロー**: メインメニュー → キャラクター選択 → ゲーム開始
- **技術実装**: Factory Pattern、Strategy Pattern、Character-specific Update/Render

### **マリオミニゲーム イントロアニメーションシステム** (2025-06-17実装中)
- **実装ファイル**: 
  - `js/mini-games/mario-intro-system.js` (完全実装済み)
  - `js/mini-games/mario-mini-game.js` (統合済み)
  - `game.js` (async対応済み)
- **実装内容**:
  - 4段階アニメーション演出（タイマー→コイン→旗→開始）
  - 復活回数別の演出時間調整（0回:100% → 3回以上:40%+自動スキップ）
  - スキップ機能（キー入力・タップ対応）
- **既知の問題**:
  - **演出が表示されない**: エンティティ参照タイミングの問題
  - **意図しないスキップ**: ゲームオーバー画面のクリックで発動
  - **描画条件不一致**: `gameState`と`isPlaying`の同期ずれ
- **修正必要箇所**:
  1. `setupInitialData()`でのエンティティ取得を遅延実行に変更
  2. スキップ入力をマリオゲーム内のみに制限
  3. 描画条件の緩和（`isPlaying`のみチェック）
  4. エンティティ未取得時のフォールバック処理追加

### **マリオ風復活ミニゲームシステム** (2025-06-17実装完了)
- **実装ファイル**:
  - `js/mini-games/mario-physics.js` (新規作成 - 物理エンジン)
  - `js/mini-games/mario-player.js` (新規作成 - プレイヤークラス)  
  - `js/mini-games/mario-renderer.js` (新規作成 - ドット絵描画システム)
  - `js/mini-games/mario-entities.js` (新規作成 - コイン・敵・ゴール等)
  - `js/mini-games/mario-mini-game.js` (新規作成 - ゲームループ・状態管理)
  - `js/mini-games/mario-audio.js` (新規作成 - 8bit音響システム)
  - `game.js` (復活システム統合・gameState追加)
- **ゲーム仕様**:
  - **復活条件**: ゲームオーバー後「もう一度プレイ」でマリオゲーム開始
  - **クリア条件**: 必要コイン収集 + ゴール（旗）到達の2段階条件
  - **難易度進行**: 復活回数に応じて難易度0-5の6段階（敵数・制限時間・必要コイン数調整）
  - **無限復活**: マリオゲームクリアし続ける限り何度でも復活可能
  - **完全ゲームオーバー**: マリオゲーム失敗時のみ最終ゲームオーバー
- **技術実装**:
  - **完全な2D物理エンジン**: 重力・ジャンプ・コヨーテタイム・ジャンプバッファリング
  - **ドット絵描画システム**: マリオ風ピクセルアート・アニメーション・エフェクト
  - **復活データ保存**: プレイヤー状態・ゲーム進行・スキルレベル完全保存
  - **状態復元システム**: レベル・スキル・ステータス・位置・ゲーム進行の完全復活
  - **復活ペナルティ**: 復活回数×10%の体力減少（最大50%まで）
- **8bitマリオ音響システム**:
  - Web Audio API使用の本格的8bit BGM・効果音
  - マリオテーマBGM・コイン・ジャンプ・ゴール等の効果音
  - 親ゲームの音量設定と連携
- **UI統合**:
  - ゲームオーバー画面からのシームレス遷移
  - 復活カウント表示・難易度表示
  - マリオゲーム進行UI（コイン数・タイマー・体力）
- **バグ修正・デバッグ対応** (2025-06-17):
  - **構文エラー修正**: `startGame()`を`async startGame()`に修正
  - **マリオクリア後フリーズ問題**: 詳細デバッグログ追加・ゲームループ再開確認
  - **背景の敵風デザイン修正**: 山の形状を自然な丘陵地帯に変更（2層構造・奥行き感追加）

### **ルナ初心者向けマウス操作システム** (2025-06-16実装完了)
- **実装ファイル**:
  - `js/systems/input-system.js` (ルナマウス追従移動)
  - `js/systems/render-system.js` (ルナターゲットライン削除)
  - `style.css` (ルナ専用カーソルデザイン)
  - `game.js` (カーソル適用・リセット制御)
- **機能詳細**:
  - **マウス追従移動**: カーソル位置にキャラクターが滑らかに移動
  - **デッドゾーン制御**: 30px以内は停止、微調整防止
  - **距離ベース速度**: 遠いほど速く、近いほど遅い自然な動き
  - **オートエイム射撃**: 敵を自動で狙い撃ち、ピンクライン削除
  - **可愛いカーソル**: ピンクの円形ハート付きSVGカーソル
- **初心者体験**: キーボード不要、マウスのみで完全操作可能
- **技術実装**:
  ```javascript
  // マウス追従移動ロジック
  const distance = Math.sqrt(dx * dx + dy * dy);
  if (distance > 30) {
      const normalizedDistance = Math.min(distance / 100, 1);
      moveX = (dx / distance) * normalizedDistance;
      moveY = (dy / distance) * normalizedDistance;
  }
  ```
- **カーソルデザイン**: 32x32px SVGデータURI、ピンク円形+ハート+キラキラエフェクト
- **条件適用**: ルナ選択時のみカーソル変更、メニュー復帰時自動リセット

## 高優先度 🔴

### BGM・音響システム
- ~~BGMがステージ1とステージ2で変わってない感じする~~ ✅ 修正完了 (2025-06-16): 9ステージ別BGMシステム実装
- ~~BGMが大きすぎる~~ ✅ 修正完了 (2025-06-16): BGM音量60%→30%に調整
- ~~ポーズ時・スキル選択時のBGM一時停止~~ ✅ 実装完了 (2025-06-16): pause/resumeシステム
- ステージの時間が経過によって、テンポとキーが徐々に上がっていく。これも実装されてない感じする
- ~~スーパーホーミングが黄色の線が出るけど要らない~~ ✅ 修正完了 (2025-06-16)
- ~~音量調整機能~~ ✅ 実装完了 (2025-06-16)

### 武器・ゲームプレイシステム
- ~~ショットガンの確率を下げる~~ ✅ 修正完了 (2025-06-16): 全レア武器0.3%に統一
- ~~ドロップ武器切り替えバグ~~ ✅ 修正完了 (2025-06-16): ベース武器ガード型システム実装
- エレメント追加したい
- スキル選択で、アイテム吸引を増やす
- ~~射程距離増加のアイコンを他と合わせる~~ ✅ 実装完了 (2025-06-16): 十字準星スコープデザイン
- ~~ドロップアイテムの確率がおかしい~~ ✅ 修正完了 (2025-06-16): レア武器確率統一・運スキル連携
- 難易度一括システム
- 敵に影を付けたい

### UI・UX改善
- ~~スマホのスキル選択画面のUIを直す~~ ✅ 修正完了 (2025-06-16)
- ~~スマホの縦画面と横画面のスキル選択時のUI直す~~ ✅ 修正完了 (2025-06-16)
- ~~スキルレベルのUIを追加したい~~ ✅ 実装完了 (2025-06-16)
- ~~ゲーム内色システム統一~~ ✅ 実装完了 (2025-06-16): グレー→青→緑→赤→金→レインボー
- スキル数値のUI一覧
- 最初のUIにパソコンならWASD操作、スマホならスティック操作を明示するUIにしたい

### 視覚・表現改善
- 背景を変えたい
- キャラクターを人間が走ってるみたいにしたい

### バグ修正
- 射撃ボタン押しながら、スキル選択になって選択したあとに、通常画面に戻ると射撃ボタン押さなくても弾が出る
- ~~ゲームオーバーになって、もう一回プレイを押せばスーパーマリオが始まる~~ ✅ 修正完了 (2025-06-17): マリオ復活ミニゲームシステム実装・正常動作確認済み
- ~~ドロップ武器を複数回取得後、弾切れで通常武器に戻らない~~ ✅ 修正完了 (2025-06-16)
- ~~キャラクター選択からゲーム開始ボタンが動作しない~~ ✅ 修正完了 (2025-06-16): ID重複修正・z-index調整・画面管理修正

## 新機能検討 💡

### 新武器アイデア
スーパーホーミングガン、スーパーマルチショット、ショックウェーブガン。の3つが良いと思っています。
それぞれの仕様について提案してください。実装はまだです。

### エレメントシステム案
**案 C：エレメント型（属性ダメと状態異常）**
炎・氷・雷など属性を導入してDoT（継続ダメ）× Crowd Controlの組み合わせを楽しむ方向。

| レア度 | 追加スキル (抜粋) | 効果例 |
|--------|------------------|--------|
| コモン | 火術入門（炎 DoT 3/s 3秒）<br>氷術入門（移速 -10% 2秒）<br>雷術入門（25% スタン 0.3秒） | 基礎属性をばら撒く |
| アンコモン | 火炎旋風（DoT 6/s 3秒、半径↑）<br>氷柱結晶（スロウ 30%、範囲+20%） | 属性を強化 |
| レア | 雷連鎖（スタン 0.5秒、5m 連鎖） | CC を確定させる |
| エピック | 元素共鳴（同一属性 3hit で爆発） | シナジー |
| レジェンダリー | 元素超越（属性を問わず DoT+50%、CC 時間 +50%） | 全ビルド最終目標 |

---

# 開発メモ

## アーキテクチャ情報
- **分身システム削除済み**: PlayerClone関連のコードは全て削除済み
- **武器システム**: WeaponSystem.jsで一元管理、一時武器（ニューク、スーパーホーミング、スーパーショットガン）対応
- **レベルシステム**: LevelSystem.jsでスキル管理、レアリティベースの抽選システム、運ボーナス適用
- **統一色システム**: CSS変数パレット（グレー→青→緑→赤→金→レインボー）、10段階コンボ弾丸色
- **モダンBGMシステム**: 9ステージ別BGM・リアルタイム音楽生成・一時停止システム・音量制御
- **設定システム**: SettingsSystem.jsで音量設定UI管理、localStorage保存・復元
- **UIシステム**: レスポンシブ対応（PC/モバイル/横画面/縦画面）、スキルレベル常時表示、メディアクエリによる画面別最適化
- **スキルシステム**: 9スキル（攻撃・連射・弾サ・貫通・マル・反射・追尾・射程・吸引）+ 運スキル（2段階成長）
- **キャラクターシステム**: 3キャラ（レイ・ルナ・オーラム）、Factory Pattern、Character-specific操作・描画
- **初心者向け操作**: ルナのマウス追従移動・オートエイム・専用カーソル
- **復活システム**: マリオ風ミニゲーム・完全状態保存復元・無限復活・難易度進行システム

## 技術的注意点
- ES6モジュール使用、`import/export`文法
- Canvas 2D APIでの描画システム
- モバイル・PC両対応の入力システム
- レスポンシブUI設計

## 削除済みコード概要
- **PlayerClone.js**: 分身エンティティクラス（完全削除）
- **Player.js**: 分身管理ロジック（pilotInChance、clones等削除）
- **WeaponSystem.js**: 分身射撃処理（_handlePilotInShooting削除）
- **RenderSystem.js**: 分身描画処理（renderPlayerClones等削除）
- **LevelSystem.js**: パイロットインスキル定義（I/II/III削除）

## 運スキルシステム実装詳細 (2025-06-16)
- **2段階成長システム**: Lv.1-15は+15%/レベル、Lv.16+は+20%/レベル
- **スキル段階**: 運I(+15%) → 運II(+30%) → 運III(+45%) → 幸運の加護(+45%+特殊) → 運命操作(+30%+特殊)
- **ドロップ武器効果**: 基本確率0.9% → Lv.30で5.62%（6.2倍）
- **スキル選択効果**: 運ボーナス×0.5でレアリティ重み調整、Epic以上確率大幅向上
- **計算式**: `運ボーナス = Lv≤15 ? Lv×15 : 225+(Lv-15)×20`
- **特殊効果**: 幸運の加護(全ドロップ+1個)、運命操作(Epic確率+50%)

## モダンBGMシステム実装詳細 (2025-06-16)
- **アーキテクチャ**: 完全統合型音楽システム（5つのサブシステム）
- **音楽エンジン**: 
  - ModernBGMEngine: メインエンジン・一時停止システム
  - SynthFactory: 高品質楽器（leadSynth, subBass, neonPad等）
  - RhythmEngine: ジャンル別ドラムパターン・25ms先読み
  - StageThemes: 9ステージ詳細設定・楽器構成・コード進行
  - ProgressionGenerator: 音楽理論・スケール・コード・メロディ生成
- **リアルタイム演奏**: 16分音符解像度・時間ベースシーケンサー・楽器段階的導入
- **9ジャンル対応**: Future Pop/Synthwave/Electro House/Tech House/Future Bass/Hardstyle/Ambient Techno/Epic Synthwave/Uplifting Trance
- **一時停止システム**: 状態保存・スムーズフェード・安全な復帰・スキル選択/設定画面連携

## 音量システム実装詳細
- **デフォルト音量**: マスター80%、BGM30%、効果音70% (2025-06-16調整)
- **音量バランス**: BGMを大幅減・効果音を適正化・ゲームプレイ重視設計
- **音量計算式**: `最終音量 = マスター音量 × 種別音量 × 基本音量`
- **設定保存キー**: `audioSettings` (localStorage)
- **対応音響**: 全ての効果音とBGMに音量設定が反映
- **UI**: ESCキー・モーダル外クリックで設定画面を閉じる・BGM一時停止連携

## スマホUI実装詳細 (2025-06-16)
- **横画面最適化**: `@media screen and (orientation: landscape) and (max-height: 500px)`
- **3カラムレイアウト**: `.upgrade-options`を`flex-direction: row`で横並び化
- **スキルカード**: `flex: 1` + `max-width: 32%`で等幅3分割
- **サイズ調整**: モーダル幅800px、高さ85vh、パディング1rem
- **フォント最適化**: 階層的サイズ調整でタッチ操作性と視認性を両立
- **縦画面保持**: 縦画面時は従来通りの縦並びレイアウトを維持

## スーパーホーミング武器修正詳細 (2025-06-16)
- **修正内容**: 黄色のターゲットライン表示を除去
- **修正ファイル**: `js/systems/render-system.js`
- **修正方法**: `_renderSuperHomingBullet()`内の`_renderTargetLine()`呼び出しをコメントアウト（1401-1403行目）
- **影響**: 視覚的なクリーンアップのみ、ホーミング機能は維持

## コンボ弾丸色システム技術詳細 (2025-06-16)
- **コンボ管理**: game.jsの`this.combo = { count, maxCombo, lastKillTime, comboTimeout }`
- **コンボ増加**: 敵撃破時に`handleEnemyDeath()`で`this.combo.count++`
- **コンボリセット**: ダメージ時のみ（タイムアウト削除済み）
- **弾丸統合**: WeaponSystem → BulletSystem → Bullet クラスの連携
- **描画処理**: RenderSystemで武器別描画メソッドに色情報を適用
- **レインボー更新**: Bulletクラスのupdate()で10秒周期の色相変化

## 統一色システム実装詳細 (2025-06-16)
- **新カラーパレット**: グレー→青→緑→赤→金→レインボー（自然な寒色→暖色進行）
- **CSS変数定義**: `:root`で統一管理、保守性向上
- **10段階コンボ弾丸色**: 3コンボ刻み（0-2:グレー, 3-5:グレー青, 6-8:青...30+:レインボー）
- **グラデーション中間色**: 滑らかな色変化（#607D8B, #009688, #FF5722, #FF6F00）
- **統一適用範囲**: レアリティ色・スキルレベル表示・コンボ表示・UI要素全般
- **視覚効果**: レベル別グロー強度・特殊エフェクト（緑12コンボ以上）・サイズボーナス（0-200%）
- **レスポンシブ**: PC版横並び・モバイル版2行配置、Safe Area対応

## 運スキル・2段階成長システム技術詳細 (2025-06-16)
- **計算式**: Lv.1-15 = レベル×15%、Lv.16+ = 225% + (レベル-15)×20%
- **ゲッター実装**: `player.luckBonus`でリアルタイム計算値取得
- **レアリティ重み調整**: _applyLuckToRarityWeights()でCommon減少・高レア増加
- **Epic以上ボーナス**: 運命操作スキルで50%追加ボーナス

## ドロップ武器確率統一実装詳細 (2025-06-16)
- **統一確率**: 全レア武器0.3%（ニューク・スーパーホーミング・スーパーショットガン）
- **運スキル効果**: 運Lv.30で各武器1.875%、合計5.62%（20.7倍効果）
- **確率計算式**: `基本確率0.003 × (1 + 運ボーナス/100)`
- **バランス設計**: 希少性統一により公平なレア武器システム実現
- **技術実装**: PickupSystemの確率分岐ロジック調整

## 射程アイテムデザイン実装詳細 (2025-06-16)
- **問題**: `case 'range':`がswitch文に存在せず、`_renderGenericPickup()`にフォールバック
- **解決**: `_renderRangePickup()`メソッド新規実装、switch文に`case 'range':`追加
- **デザイン要素**:
  - 外側リング: 半径12px、水色ストローク
  - 中間リング: 半径8px、透明度0.7
  - 十字準星: 白色、lineWidth 3、中央3px隙間
  - 中央ドット: 白色、半径2px、グロー効果
  - 4隅マーク: 90度弧×4、射程範囲表現
- **アニメーション**: パルススケール（Sin波）、グローブラー変動
- **技術実装**: Canvas 2D API、時間ベースエフェクト、適切なプロパティリセット

## マリオ復活ミニゲームシステム技術詳細 (2025-06-17)
- **アーキテクチャ**: 完全独立型ゲームシステム（6つのサブシステム）
- **ゲームエンジン**: 
  - MarioPhysics: 2D物理エンジン・重力・ジャンプ・衝突判定
  - MarioPlayer: プレイヤー状態管理・アニメーション・エンティティ相互作用
  - MarioRenderer: ドット絵描画・背景・エフェクト・UI描画
  - MarioEntities: コイン・敵・ゴール・プラットフォーム・ハザード
  - MarioMiniGame: メインゲームループ・状態管理・難易度システム
  - MarioAudio: 8bit音響システム・BGM・効果音
- **復活システム統合**: 
  - `gameState = 'marioMiniGame'`でマリオゲーム実行
  - `handleMarioGameSuccess()`で復活処理・データ復元
  - `revivePlayer()`で完全状態復活・ペナルティ適用
  - `saveRevivalData()`でゲーム進行状態完全保存
- **物理エンジン**: 
  - 重力980・最大落下速度600・ジャンプ力-400
  - コヨーテタイム・ジャンプバッファリング・摩擦係数0.8
  - プラットフォーム衝突判定・敵踏みつけ判定
- **難易度システム**: 6段階進行（0-5）・敵数1-4体・制限時間45-90秒・必要コイン3-5個
- **8bit音響システム**: Web Audio API・マリオテーマBGM・コイン・ジャンプ・ゴール効果音
- **デバッグシステム**: 詳細ログ・エラーハンドリング・状態追跡・フリーズ対策

## 既知の問題
- ~~**コンボ弾丸色が変わらない**: コンボ値参照先とBulletプロパティの問題~~ ✅ 修正完了 (2025-06-16)
- ~~**スキルレベル数字のモヤ**: 過度なtext-shadowとopacity問題~~ ✅ 修正完了 (2025-06-16)
- ~~**スーパーショットガンコンボサイズバグ**: コンボ値参照エラー~~ ✅ 修正完了 (2025-06-16)
- ~~**射程アイテムが水色の丸**: switch文にcaseがなく汎用描画にフォールバック~~ ✅ 修正完了 (2025-06-16)
- ~~**ドロップ武器複数切り替えバグ**: previousWeapon参照による復帰先エラー~~ ✅ 修正完了 (2025-06-16)
- ~~**キャラクター選択画面の不具合**: ID重複・z-index・画面管理問題~~ ✅ 修正完了 (2025-06-16)
- ~~**ルナのピンクターゲットライン**: オートエイム時の視覚的ノイズ~~ ✅ 修正完了 (2025-06-16): ターゲットライン削除
- ~~**マリオミニゲーム構文エラー**: startGame()でawait使用による読み込み失敗~~ ✅ 修正完了 (2025-06-17): async startGame()に修正
- ~~**マリオクリア後フリーズ**: ステージクリア後の画面停止問題~~ ✅ 修正完了 (2025-06-17): デバッグログ追加・ゲームループ再開確認
- ~~**マリオ背景の敵風デザイン**: 山の形状が敵のように見える視覚的違和感~~ ✅ 修正完了 (2025-06-17): 自然な丘陵地帯に変更

## 現在のゲームバランス設定 ⚖️

### **ドロップアイテム確率** (2025-06-16現在)
- **レア武器** (運ボーナス適用):
  - ニューク: 0.3% → 運Lv.30で1.875% (6.2倍)
  - スーパーホーミング: 0.3% → 運Lv.30で1.875% (6.2倍)
  - スーパーショットガン: 0.3% → 運Lv.30で1.875% (6.2倍)
- **通常アイテム**:
  - 体力増加: 50%
  - 射程増加: 25%
  - 速度増加: 24.7%

### **武器システム状態** (2025-06-16現在)
- **ベース武器ガードシステム**: 全ドロップ武器切り替えシナリオ対応済み
- **弾切れ復帰**: 必ずplasma武器に戻る堅牢なシステム
- **重複取得**: 弾薬補充のみ、武器切り替えなし
- **コンボ弾丸色**: 30段階色変化 + レインボー対応済み