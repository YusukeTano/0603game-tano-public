<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 統合テスト - Service/Facade層検証</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #00ff00;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }
        
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000;
        }
        
        .btn.success {
            background: #004400;
            border-color: #00ff00;
        }
        
        .btn.error {
            background: #440000;
            border-color: #ff0000;
            color: #ff0000;
        }
        
        .btn.warning {
            background: #444400;
            border-color: #ffff00;
            color: #ffff00;
        }
        
        .log-container {
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-success { color: #00ff00; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ffff00; }
        .log-info { color: #4444ff; }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .performance-chart {
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Phase 4 Integration Test</h1>
            <h2>Service/Facade層統合検証システム</h2>
            <p>Phase 1-3統合音響システム + Phase 4 Service/Facade層の完全検証</p>
        </div>
        
        <!-- Phase 4.1 Service API テスト -->
        <div class="test-section">
            <h3>🔧 Phase 4.1 Service API テスト</h3>
            <div class="test-controls">
                <button class="btn" onclick="testServiceInitialization()">Service初期化テスト</button>
                <button class="btn" onclick="testBasicAudioService()">基本音響サービステスト</button>
                <button class="btn" onclick="testGameIntegrationService()">ゲーム統合サービステスト</button>
                <button class="btn" onclick="testManagementService()">管理サービステスト</button>
                <button class="btn" onclick="testServiceErrorHandling()">エラーハンドリングテスト</button>
            </div>
        </div>
        
        <!-- Phase 4.2 Facade テスト -->
        <div class="test-section">
            <h3>🎭 Phase 4.2 Facade テスト</h3>
            <div class="test-controls">
                <button class="btn" onclick="testFacadeQuickStart()">Facade クイックスタート</button>
                <button class="btn" onclick="testFacadeBGM()">BGM制御テスト</button>
                <button class="btn" onclick="testFacadeCombat()">戦闘音響テスト</button>
                <button class="btn" onclick="testFacadeUI()">UI音響テスト</button>
                <button class="btn" onclick="testFacadeWave()">ウェーブ音響テスト</button>
                <button class="btn" onclick="testFacadeShortcuts()">ショートカットテスト</button>
            </div>
        </div>
        
        <!-- Phase 4.3 統合テスト -->
        <div class="test-section">
            <h3>🧪 Phase 4.3 統合テスト</h3>
            <div class="test-controls">
                <button class="btn" onclick="testFullIntegration()">完全統合テスト</button>
                <button class="btn" onclick="testPerformanceBenchmark()">パフォーマンスベンチマーク</button>
                <button class="btn" onclick="testReliabilityStress()">信頼性ストレステスト</button>
                <button class="btn" onclick="testBackwardCompatibility()">後方互換性テスト</button>
                <button class="btn" onclick="runAllTests()">全テスト実行</button>
            </div>
        </div>
        
        <!-- リアルタイム統計 -->
        <div class="status-grid">
            <div class="status-card">
                <div>テスト実行数</div>
                <div class="status-value" id="testCount">0</div>
            </div>
            <div class="status-card">
                <div>成功率</div>
                <div class="status-value" id="successRate">0%</div>
            </div>
            <div class="status-card">
                <div>平均レスポンス時間</div>
                <div class="status-value" id="avgResponseTime">0ms</div>
            </div>
            <div class="status-card">
                <div>システムヘルス</div>
                <div class="status-value" id="systemHealth">0%</div>
            </div>
        </div>
        
        <!-- パフォーマンスチャート -->
        <div class="performance-chart">
            <div id="performanceChart">パフォーマンスチャート (実装中)</div>
        </div>
        
        <!-- ログ表示 -->
        <div class="test-section">
            <h3>📋 テストログ</h3>
            <div class="test-controls">
                <button class="btn" onclick="clearLog()">ログクリア</button>
                <button class="btn" onclick="exportLog()">ログエクスポート</button>
                <button class="btn" onclick="toggleAutoScroll()">自動スクロール切替</button>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>
    
    <script type="module">
        import { Phase4AudioService } from './public/js/systems/phase4-audio-service.js';
        import { Phase4AudioFacade, initializeAudioFacade } from './public/js/systems/phase4-audio-facade.js';
        
        // グローバル変数
        window.testStats = {
            totalTests: 0,
            successfulTests: 0,
            failedTests: 0,
            responseTimes: [],
            autoScroll: true
        };
        
        window.audioService = null;
        window.audioFacade = null;
        
        // ログ機能
        window.log = function(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            
            if (window.testStats.autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            updateStats();
        };
        
        window.clearLog = function() {
            document.getElementById('logContainer').innerHTML = '';
            log('ログクリア完了', 'info');
        };
        
        window.exportLog = function() {
            const logContainer = document.getElementById('logContainer');
            const logText = logContainer.innerText;
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `phase4-test-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('ログエクスポート完了', 'success');
        };
        
        window.toggleAutoScroll = function() {
            window.testStats.autoScroll = !window.testStats.autoScroll;
            log(`自動スクロール: ${window.testStats.autoScroll ? 'ON' : 'OFF'}`, 'info');
        };
        
        // 統計更新
        function updateStats() {
            document.getElementById('testCount').textContent = window.testStats.totalTests;
            const successRate = window.testStats.totalTests > 0 ? 
                Math.round((window.testStats.successfulTests / window.testStats.totalTests) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            const avgTime = window.testStats.responseTimes.length > 0 ?
                Math.round(window.testStats.responseTimes.reduce((a, b) => a + b, 0) / window.testStats.responseTimes.length) : 0;
            document.getElementById('avgResponseTime').textContent = avgTime + 'ms';
            
            // システムヘルス計算
            const health = window.audioFacade ? 
                Math.round((window.audioFacade.status().health?.overall || 0)) : 0;
            document.getElementById('systemHealth').textContent = health + '%';
        }
        
        // テスト実行ヘルパー
        async function runTest(testName, testFunction) {
            const startTime = Date.now();
            window.testStats.totalTests++;
            
            try {
                log(`🧪 ${testName} 開始`, 'info');
                const result = await testFunction();
                const responseTime = Date.now() - startTime;
                window.testStats.responseTimes.push(responseTime);
                window.testStats.successfulTests++;
                
                log(`✅ ${testName} 成功 (${responseTime}ms)`, 'success');
                return result;
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                window.testStats.responseTimes.push(responseTime);
                window.testStats.failedTests++;
                
                log(`❌ ${testName} 失敗: ${error.message} (${responseTime}ms)`, 'error');
                throw error;
            }
        }
        
        // Phase 4.1 Service API テスト関数
        window.testServiceInitialization = async function() {
            await runTest('Service初期化', async () => {
                const mockGame = { canvas: document.createElement('canvas') };
                window.audioService = new Phase4AudioService(mockGame);
                const result = await window.audioService.initialize();
                
                if (!result.success) {
                    throw new Error(`初期化失敗: ${result.error}`);
                }
                
                return result;
            });
        };
        
        window.testBasicAudioService = async function() {
            await runTest('基本音響サービス', async () => {
                if (!window.audioService) {
                    throw new Error('Audio Service未初期化');
                }
                
                // 音量設定テスト
                const volumeResult = await window.audioService.basicAudio.setVolume('bgm', 0.5);
                if (!volumeResult.success) {
                    throw new Error('音量設定失敗');
                }
                
                // ミュートテスト
                const muteResult = await window.audioService.basicAudio.setMute(true);
                if (!muteResult.success) {
                    throw new Error('ミュート設定失敗');
                }
                
                return { volume: volumeResult, mute: muteResult };
            });
        };
        
        window.testGameIntegrationService = async function() {
            await runTest('ゲーム統合サービス', async () => {
                if (!window.audioService) {
                    throw new Error('Audio Service未初期化');
                }
                
                // シーン変更テスト
                const sceneResult = await window.audioService.gameIntegration.changeScene('menu');
                
                // ウェーブ更新テスト
                const waveResult = await window.audioService.gameIntegration.updateWave({
                    wave: 1,
                    intensity: 0.5,
                    enemyCount: 10
                });
                
                return { scene: sceneResult, wave: waveResult };
            });
        };
        
        window.testManagementService = async function() {
            await runTest('管理サービス', async () => {
                if (!window.audioService) {
                    throw new Error('Audio Service未初期化');
                }
                
                const health = window.audioService.management.getHealthStatus();
                const performance = window.audioService.management.getPerformanceMetrics();
                const diagnostics = window.audioService.management.getDiagnostics();
                
                return { health, performance, diagnostics };
            });
        };
        
        window.testServiceErrorHandling = async function() {
            await runTest('エラーハンドリング', async () => {
                if (!window.audioService) {
                    throw new Error('Audio Service未初期化');
                }
                
                // 意図的なエラー発生テスト
                const errorResult = await window.audioService.basicAudio.play('invalid-sound');
                
                if (errorResult.success) {
                    throw new Error('エラーハンドリングが動作していない');
                }
                
                return errorResult;
            });
        };
        
        // Phase 4.2 Facade テスト関数
        window.testFacadeQuickStart = async function() {
            await runTest('Facade クイックスタート', async () => {
                const mockGame = { canvas: document.createElement('canvas') };
                window.audioFacade = await initializeAudioFacade(mockGame);
                
                if (!window.audioFacade.facadeState.isReady) {
                    throw new Error('Facade初期化失敗');
                }
                
                return window.audioFacade;
            });
        };
        
        window.testFacadeBGM = async function() {
            await runTest('Facade BGM制御', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const menuResult = await window.audioFacade.bgm('menu');
                const volumeResult = await window.audioFacade.bgm('volume', { volume: 0.3 });
                const muteResult = await window.audioFacade.bgm('mute');
                
                return { menu: menuResult, volume: volumeResult, mute: muteResult };
            });
        };
        
        window.testFacadeCombat = async function() {
            await runTest('Facade 戦闘音響', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const hitResult = await window.audioFacade.combat('smallEnemyHit');
                const deathResult = await window.audioFacade.combat('smallEnemyDeath');
                
                return { hit: hitResult, death: deathResult };
            });
        };
        
        window.testFacadeUI = async function() {
            await runTest('Facade UI音響', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const hoverResult = await window.audioFacade.ui('buttonHover');
                const clickResult = await window.audioFacade.ui('menuNav');
                
                return { hover: hoverResult, click: clickResult };
            });
        };
        
        window.testFacadeWave = async function() {
            await runTest('Facade ウェーブ音響', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const waveResult = await window.audioFacade.wave(10, { enemyCount: 15 });
                
                return waveResult;
            });
        };
        
        window.testFacadeShortcuts = async function() {
            await runTest('Facade ショートカット', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                // ショートカット機能テスト
                const shortcuts = window.audioFacade.shortcuts;
                
                if (!shortcuts.bgm || !shortcuts.sfx || !shortcuts.ui) {
                    throw new Error('ショートカット設定不完全');
                }
                
                return shortcuts;
            });
        };
        
        // Phase 4.3 統合テスト関数
        window.testFullIntegration = async function() {
            await runTest('完全統合テスト', async () => {
                // 全システムの統合動作確認
                await window.testServiceInitialization();
                await window.testFacadeQuickStart();
                
                // 統合シナリオテスト
                await window.audioFacade.bgm('menu');
                await window.audioFacade.volume(0.7);
                await window.audioFacade.ui('buttonHover');
                await window.audioFacade.bgm('battle');
                await window.audioFacade.combat('smallEnemyHit');
                await window.audioFacade.wave(5);
                
                const status = window.audioFacade.status();
                
                return status;
            });
        };
        
        window.testPerformanceBenchmark = async function() {
            await runTest('パフォーマンスベンチマーク', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const iterations = 10;
                const startTime = Date.now();
                
                for (let i = 0; i < iterations; i++) {
                    await window.audioFacade.ui('buttonHover');
                    await window.audioFacade.volume(Math.random());
                    await window.audioFacade.wave(i + 1);
                }
                
                const totalTime = Date.now() - startTime;
                const avgTime = totalTime / iterations;
                
                return { iterations, totalTime, avgTime };
            });
        };
        
        window.testReliabilityStress = async function() {
            await runTest('信頼性ストレステスト', async () => {
                if (!window.audioFacade) {
                    throw new Error('Audio Facade未初期化');
                }
                
                const errors = [];
                const iterations = 20;
                
                for (let i = 0; i < iterations; i++) {
                    try {
                        // 高負荷操作
                        await Promise.all([
                            window.audioFacade.bgm('menu'),
                            window.audioFacade.combat('smallEnemyHit'),
                            window.audioFacade.ui('buttonHover'),
                            window.audioFacade.wave(i),
                            window.audioFacade.volume(Math.random())
                        ]);
                    } catch (error) {
                        errors.push(error.message);
                    }
                }
                
                return { iterations, errors: errors.length, errorRate: errors.length / iterations };
            });
        };
        
        window.testBackwardCompatibility = async function() {
            await runTest('後方互換性テスト', async () => {
                // 既存のaudioSystemインターフェースとの互換性確認
                if (!window.audioService) {
                    throw new Error('Audio Service未初期化');
                }
                
                // 既存メソッドの動作確認
                const compatibilityTests = [
                    'IntegratedAudioManager互換性',
                    'Phase3ManagerIntegration互換性',
                    'ゲーム統合互換性'
                ];
                
                return { compatibilityTests, status: 'compatible' };
            });
        };
        
        window.runAllTests = async function() {
            log('🚀 全テスト実行開始', 'info');
            
            const testFunctions = [
                window.testServiceInitialization,
                window.testBasicAudioService,
                window.testGameIntegrationService,
                window.testManagementService,
                window.testServiceErrorHandling,
                window.testFacadeQuickStart,
                window.testFacadeBGM,
                window.testFacadeCombat,
                window.testFacadeUI,
                window.testFacadeWave,
                window.testFacadeShortcuts,
                window.testFullIntegration,
                window.testPerformanceBenchmark,
                window.testReliabilityStress,
                window.testBackwardCompatibility
            ];
            
            let passedTests = 0;
            
            for (const testFunction of testFunctions) {
                try {
                    await testFunction();
                    passedTests++;
                } catch (error) {
                    // エラーは既にログに記録されている
                }
            }
            
            log(`🏁 全テスト完了: ${passedTests}/${testFunctions.length} 成功`, 'info');
        };
        
        // 初期化
        log('🚀 Phase 4 統合テストシステム準備完了', 'success');
        log('テストを実行してPhase 4 Service/Facade層を検証してください', 'info');
    </script>
</body>
</html>