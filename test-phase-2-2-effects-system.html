<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2.2 Effects System - 包括テスト</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #555;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        
        button:hover {
            background: #0088ff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .slider-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .slider-control label {
            color: #00ffff;
            width: 120px;
        }
        
        .slider-control input[type="range"] {
            flex: 1;
            max-width: 200px;
        }
        
        .slider-control span {
            color: #00ff00;
            width: 60px;
            text-align: right;
        }
        
        .test-result {
            background: #333;
            border-left: 4px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-result.error {
            border-left-color: #ff0000;
            color: #ff9999;
        }
        
        .test-result.warning {
            border-left-color: #ffaa00;
            color: #ffcc99;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .stat-title {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 18px;
            color: #00ff00;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .phase-indicator {
            background: linear-gradient(45deg, #0066cc, #00ffff);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        
        .effect-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .effect-panel {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 8px;
        }
        
        .effect-panel h3 {
            color: #00ffff;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>🎛️ Phase 2.2: Effects System</h1>
            <div class="phase-indicator">Phase 2.2: 音響エフェクトシステム包括検証</div>
        </div>
        
        <!-- 1. エフェクトシステム初期化テスト -->
        <div class="test-section">
            <h2>🚀 1. エフェクトシステム初期化テスト</h2>
            <div class="test-controls">
                <button onclick="testEffectsInitialization()">エフェクト初期化</button>
                <button onclick="testBasicEffectsCreation()">基本エフェクト作成</button>
                <button onclick="testAdvancedEffectsCreation()">アドバンスエフェクト作成</button>
                <button onclick="testEffectChains()">エフェクトチェーン構築</button>
            </div>
            <div id="init-result" class="test-result"></div>
        </div>
        
        <!-- 2. 統合音楽エンジンテスト -->
        <div class="test-section">
            <h2>🎼✨ 2. 統合音楽エンジンテスト</h2>
            <div class="test-controls">
                <button onclick="testEnhancedEngineInit()">統合エンジン初期化</button>
                <button onclick="testEnhancedBGMPlay()">エフェクト付きBGM再生</button>
                <button onclick="testEffectChainApplication()">楽器エフェクト適用</button>
                <button onclick="testGameStateIntegration()">ゲーム状態連動</button>
            </div>
            <div id="enhanced-result" class="test-result"></div>
        </div>
        
        <!-- 3. 個別エフェクトテスト -->
        <div class="test-section">
            <h2>🎛️ 3. 個別エフェクトテスト</h2>
            <div class="test-controls">
                <button onclick="testReverbEffect()">リバーブテスト</button>
                <button onclick="testFilterEffect()">フィルターテスト</button>
                <button onclick="testDistortionEffect()">ディストーションテスト</button>
                <button onclick="testCompressorEffect()">コンプレッサーテスト</button>
                <button onclick="testChorusEffect()">コーラステスト</button>
                <button onclick="testDelayEffect()">ディレイテスト</button>
            </div>
            <div id="individual-result" class="test-result"></div>
        </div>
        
        <!-- 4. リアルタイムエフェクト制御 -->
        <div class="test-section">
            <h2>🎚️ 4. リアルタイムエフェクト制御</h2>
            
            <div class="effect-controls">
                <!-- リバーブ制御 -->
                <div class="effect-panel">
                    <h3>🏛️ リバーブ</h3>
                    <div class="slider-control">
                        <label>強度:</label>
                        <input type="range" id="reverb-intensity" min="0" max="100" value="30" oninput="adjustReverbRealtime(this.value)">
                        <span id="reverb-value">30%</span>
                    </div>
                    <button onclick="testReverbSweep()">リバーブスイープ</button>
                </div>
                
                <!-- フィルター制御 -->
                <div class="effect-panel">
                    <h3>🔊 フィルター</h3>
                    <div class="slider-control">
                        <label>周波数:</label>
                        <input type="range" id="filter-freq" min="100" max="20000" value="5000" oninput="adjustFilterRealtime(this.value)">
                        <span id="filter-value">5000Hz</span>
                    </div>
                    <div class="test-controls">
                        <button onclick="setFilterType('lowpass')">ローパス</button>
                        <button onclick="setFilterType('highpass')">ハイパス</button>
                        <button onclick="setFilterType('bandpass')">バンドパス</button>
                    </div>
                </div>
                
                <!-- ディストーション制御 -->
                <div class="effect-panel">
                    <h3>⚡ ディストーション</h3>
                    <div class="slider-control">
                        <label>強度:</label>
                        <input type="range" id="distortion-amount" min="0" max="100" value="40" oninput="adjustDistortionRealtime(this.value)">
                        <span id="distortion-value">40%</span>
                    </div>
                    <button onclick="testDistortionSweep()">ディストーションスイープ</button>
                </div>
                
                <!-- ゲーム状態シミュレーション -->
                <div class="effect-panel">
                    <h3>🎮 ゲーム状態シミュレーション</h3>
                    <div class="slider-control">
                        <label>コンボ数:</label>
                        <input type="range" id="game-combo" min="0" max="50" value="0" oninput="updateGameStateRealtime()">
                        <span id="combo-value">0</span>
                    </div>
                    <div class="slider-control">
                        <label>強度:</label>
                        <input type="range" id="game-intensity" min="0" max="200" value="100" oninput="updateGameStateRealtime()">
                        <span id="intensity-value">100%</span>
                    </div>
                    <div class="test-controls">
                        <button onclick="setGameScene('menu')">メニュー</button>
                        <button onclick="setGameScene('battle')">バトル</button>
                        <button onclick="setGameScene('boss')">ボス</button>
                    </div>
                </div>
            </div>
            
            <div id="realtime-result" class="test-result"></div>
        </div>
        
        <!-- 5. パフォーマンステスト -->
        <div class="test-section">
            <h2>⚡ 5. パフォーマンステスト</h2>
            <div class="test-controls">
                <button onclick="testEffectsLatency()">エフェクトレイテンシー</button>
                <button onclick="testMemoryUsage()">メモリ使用量</button>
                <button onclick="testCPULoad()">CPU負荷</button>
                <button onclick="testLongRunningEffects()">長時間動作</button>
                <button onclick="runFullPerformanceTest()">完全パフォーマンステスト</button>
            </div>
            <div id="performance-result" class="test-result"></div>
        </div>
        
        <!-- 6. システム状態・統計 -->
        <div class="test-section">
            <h2>📊 6. システム状態・統計</h2>
            <div class="test-controls">
                <button onclick="updateSystemStatus()">状態更新</button>
                <button onclick="clearAllTests()">全テストクリア</button>
                <button onclick="runFullTestSuite()">完全テストスイート実行</button>
                <button onclick="exportTestResults()">テスト結果エクスポート</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">エフェクト初期化</div>
                    <div class="stat-value" id="stat-effects-init">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">アクティブエフェクト</div>
                    <div class="stat-value" id="stat-active-effects">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">エフェクトチェーン</div>
                    <div class="stat-value" id="stat-effect-chains">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">処理レイテンシー</div>
                    <div class="stat-value" id="stat-latency">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">メモリ使用量</div>
                    <div class="stat-value" id="stat-memory">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">エラー数</div>
                    <div class="stat-value" id="stat-errors">-</div>
                </div>
            </div>
            
            <div id="status-result" class="test-result"></div>
        </div>
    </div>

    <!-- Tone.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <script type="module">
        import { AudioEffectsManager } from './public/js/systems/audio-effects-manager.js';
        import { EnhancedMusicEngine } from './public/js/systems/enhanced-music-engine.js';
        
        // グローバル変数
        let effectsManager = null;
        let enhancedEngine = null;
        let testResults = [];
        let currentGameState = { combo: 0, intensity: 1.0, scene: 'normal' };
        
        // 1. エフェクトシステム初期化テスト
        window.testEffectsInitialization = async function() {
            try {
                displayResult('init-result', '🚀 エフェクトシステム初期化テスト開始...', 'info');
                
                if (!effectsManager) {
                    effectsManager = new AudioEffectsManager();
                }
                
                const result = await effectsManager.initialize();
                
                if (result.success) {
                    displayResult('init-result', 
                        `✅ エフェクトシステム初期化成功 (${result.latency.toFixed(2)}ms)`, 'success');
                } else {
                    displayResult('init-result', 
                        `❌ エフェクトシステム初期化失敗: ${result.error}`, 'error');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                displayResult('init-result', `❌ 初期化エラー: ${error.message}`, 'error');
            }
        };
        
        window.testBasicEffectsCreation = async function() {
            try {
                displayResult('init-result', '🎛️ 基本エフェクト作成テスト...', 'info');
                
                await ensureEffectsManager();
                const status = effectsManager.getEffectsStatus();
                
                const basicEffects = ['reverb', 'filter', 'distortion', 'compressor'];
                const createdEffects = basicEffects.filter(effect => status.effects[effect]);
                
                displayResult('init-result', 
                    `✅ 基本エフェクト作成: ${createdEffects.length}/${basicEffects.length}\n` +
                    `作成済み: ${createdEffects.join(', ')}`, 
                    createdEffects.length === basicEffects.length ? 'success' : 'warning');
                    
            } catch (error) {
                displayResult('init-result', `❌ 基本エフェクト作成エラー: ${error.message}`, 'error');
            }
        };
        
        window.testAdvancedEffectsCreation = async function() {
            try {
                displayResult('init-result', '🌊 アドバンスエフェクト作成テスト...', 'info');
                
                await ensureEffectsManager();
                const status = effectsManager.getEffectsStatus();
                
                const advancedEffects = ['chorus', 'delay', 'equalizer', 'limiter'];
                const createdEffects = advancedEffects.filter(effect => status.effects[effect]);
                
                displayResult('init-result', 
                    `✅ アドバンスエフェクト作成: ${createdEffects.length}/${advancedEffects.length}\n` +
                    `作成済み: ${createdEffects.join(', ')}`, 
                    createdEffects.length >= 2 ? 'success' : 'warning');
                    
            } catch (error) {
                displayResult('init-result', `❌ アドバンスエフェクト作成エラー: ${error.message}`, 'error');
            }
        };
        
        window.testEffectChains = async function() {
            try {
                displayResult('init-result', '🔗 エフェクトチェーン構築テスト...', 'info');
                
                await ensureEffectsManager();
                const status = effectsManager.getEffectsStatus();
                
                const totalChains = status.chains.master + status.chains.music + status.chains.sfx;
                
                displayResult('init-result', 
                    `✅ エフェクトチェーン構築完了\n` +
                    `マスター: ${status.chains.master}エフェクト\n` +
                    `音楽: ${status.chains.music}エフェクト\n` +
                    `効果音: ${status.chains.sfx}エフェクト\n` +
                    `合計: ${totalChains}エフェクト`, 'success');
                    
            } catch (error) {
                displayResult('init-result', `❌ エフェクトチェーン構築エラー: ${error.message}`, 'error');
            }
        };
        
        // 2. 統合音楽エンジンテスト
        window.testEnhancedEngineInit = async function() {
            try {
                displayResult('enhanced-result', '🎼✨ 統合エンジン初期化テスト開始...', 'info');
                
                if (!enhancedEngine) {
                    enhancedEngine = new EnhancedMusicEngine();
                }
                
                const result = await enhancedEngine.initializeEnhancedEngine();
                
                if (result.success) {
                    displayResult('enhanced-result', 
                        `✅ 統合エンジン初期化成功 (${result.latency.toFixed(2)}ms)\n` +
                        `音楽エンジン: ${result.musicEngine ? '✅' : '❌'}\n` +
                        `エフェクトエンジン: ${result.effectsEngine ? '✅' : '❌'}`, 'success');
                } else {
                    displayResult('enhanced-result', 
                        `❌ 統合エンジン初期化失敗: ${result.error}`, 'error');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                displayResult('enhanced-result', `❌ 統合エンジン初期化エラー: ${error.message}`, 'error');
            }
        };
        
        window.testEnhancedBGMPlay = async function() {
            try {
                displayResult('enhanced-result', '🎵✨ エフェクト付きBGM再生テスト...', 'info');
                
                await ensureEnhancedEngine();
                
                const result = await enhancedEngine.playEnhancedBGM({
                    effects: true,
                    gameState: currentGameState
                });
                
                if (result.success) {
                    displayResult('enhanced-result', 
                        `✅ エフェクト付きBGM再生成功\n` +
                        `ゲーム状態連動: 有効\n` +
                        `動的エフェクト: 有効`, 'success');
                } else {
                    displayResult('enhanced-result', 
                        `❌ エフェクト付きBGM再生失敗: ${result.error}`, 'error');
                }
                
            } catch (error) {
                displayResult('enhanced-result', `❌ エフェクト付きBGM再生エラー: ${error.message}`, 'error');
            }
        };
        
        window.testEffectChainApplication = async function() {
            try {
                displayResult('enhanced-result', '🔗 楽器エフェクト適用テスト...', 'info');
                
                await ensureEnhancedEngine();
                
                const result = await enhancedEngine.applyEffectsToInstruments();
                
                if (result.success) {
                    displayResult('enhanced-result', 
                        `✅ 楽器エフェクト適用成功\n` +
                        `適用済み楽器: ${result.appliedInstruments}/3`, 'success');
                } else {
                    displayResult('enhanced-result', 
                        `❌ 楽器エフェクト適用失敗: ${result.error}`, 'error');
                }
                
            } catch (error) {
                displayResult('enhanced-result', `❌ 楽器エフェクト適用エラー: ${error.message}`, 'error');
            }
        };
        
        window.testGameStateIntegration = async function() {
            try {
                displayResult('enhanced-result', '🎮 ゲーム状態連動テスト...', 'info');
                
                await ensureEnhancedEngine();
                
                // テスト用ゲーム状態シーケンス
                const testStates = [
                    { combo: 0, intensity: 1.0, scene: 'menu' },
                    { combo: 10, intensity: 1.5, scene: 'battle' },
                    { combo: 25, intensity: 2.0, scene: 'boss' }
                ];
                
                let successCount = 0;
                
                for (let i = 0; i < testStates.length; i++) {
                    try {
                        enhancedEngine.updateGameState(testStates[i]);
                        successCount++;
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        console.error(`Game state test ${i} failed:`, error);
                    }
                }
                
                displayResult('enhanced-result', 
                    `✅ ゲーム状態連動テスト完了\n` +
                    `成功: ${successCount}/${testStates.length}状態\n` +
                    `最終状態: combo=${testStates[testStates.length-1].combo}, scene=${testStates[testStates.length-1].scene}`, 
                    successCount === testStates.length ? 'success' : 'warning');
                
            } catch (error) {
                displayResult('enhanced-result', `❌ ゲーム状態連動テストエラー: ${error.message}`, 'error');
            }
        };
        
        // 3. 個別エフェクトテスト
        window.testReverbEffect = async function() {
            try {
                displayResult('individual-result', '🏛️ リバーブエフェクトテスト...', 'info');
                
                await ensureEffectsManager();
                
                const intensities = [0.2, 0.5, 0.8];
                let results = [];
                
                for (const intensity of intensities) {
                    const result = effectsManager.adjustReverb(intensity);
                    results.push(`${(intensity * 100).toFixed(0)}%: ${result.success ? '✅' : '❌'}`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                displayResult('individual-result', 
                    `✅ リバーブエフェクトテスト完了\n` +
                    `テスト結果:\n${results.join('\n')}`, 'success');
                
            } catch (error) {
                displayResult('individual-result', `❌ リバーブテストエラー: ${error.message}`, 'error');
            }
        };
        
        window.testFilterEffect = async function() {
            try {
                displayResult('individual-result', '🔊 フィルターエフェクトテスト...', 'info');
                
                await ensureEffectsManager();
                
                const tests = [
                    { freq: 1000, type: 'lowpass' },
                    { freq: 5000, type: 'highpass' },
                    { freq: 3000, type: 'bandpass' }
                ];
                
                let results = [];
                
                for (const test of tests) {
                    const result = effectsManager.adjustFilter(test.freq, test.type);
                    results.push(`${test.freq}Hz ${test.type}: ${result.success ? '✅' : '❌'}`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                displayResult('individual-result', 
                    `✅ フィルターエフェクトテスト完了\n` +
                    `テスト結果:\n${results.join('\n')}`, 'success');
                
            } catch (error) {
                displayResult('individual-result', `❌ フィルターテストエラー: ${error.message}`, 'error');
            }
        };
        
        window.testDistortionEffect = async function() {
            try {
                displayResult('individual-result', '⚡ ディストーションエフェクトテスト...', 'info');
                
                await ensureEffectsManager();
                
                const amounts = [0.1, 0.4, 0.8];
                let results = [];
                
                for (const amount of amounts) {
                    const result = effectsManager.adjustDistortion(amount);
                    results.push(`${(amount * 100).toFixed(0)}%: ${result.success ? '✅' : '❌'}`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                displayResult('individual-result', 
                    `✅ ディストーションエフェクトテスト完了\n` +
                    `テスト結果:\n${results.join('\n')}`, 'success');
                
            } catch (error) {
                displayResult('individual-result', `❌ ディストーションテストエラー: ${error.message}`, 'error');
            }
        };
        
        // 4. リアルタイム制御
        window.adjustReverbRealtime = function(value) {
            try {
                const intensity = value / 100;
                document.getElementById('reverb-value').textContent = `${value}%`;
                
                if (effectsManager) {
                    const result = effectsManager.adjustReverb(intensity);
                    if (!result.success) {
                        displayResult('realtime-result', `⚠️ リバーブ調整失敗: ${result.error}`, 'warning');
                    }
                }
            } catch (error) {
                displayResult('realtime-result', `❌ リバーブリアルタイム調整エラー: ${error.message}`, 'error');
            }
        };
        
        window.adjustFilterRealtime = function(value) {
            try {
                document.getElementById('filter-value').textContent = `${value}Hz`;
                
                if (effectsManager) {
                    const result = effectsManager.adjustFilter(parseInt(value));
                    if (!result.success) {
                        displayResult('realtime-result', `⚠️ フィルター調整失敗: ${result.error}`, 'warning');
                    }
                }
            } catch (error) {
                displayResult('realtime-result', `❌ フィルターリアルタイム調整エラー: ${error.message}`, 'error');
            }
        };
        
        window.adjustDistortionRealtime = function(value) {
            try {
                const amount = value / 100;
                document.getElementById('distortion-value').textContent = `${value}%`;
                
                if (effectsManager) {
                    const result = effectsManager.adjustDistortion(amount);
                    if (!result.success) {
                        displayResult('realtime-result', `⚠️ ディストーション調整失敗: ${result.error}`, 'warning');
                    }
                }
            } catch (error) {
                displayResult('realtime-result', `❌ ディストーションリアルタイム調整エラー: ${error.message}`, 'error');
            }
        };
        
        window.updateGameStateRealtime = function() {
            try {
                const combo = parseInt(document.getElementById('game-combo').value);
                const intensity = parseInt(document.getElementById('game-intensity').value) / 100;
                
                document.getElementById('combo-value').textContent = combo;
                document.getElementById('intensity-value').textContent = `${(intensity * 100).toFixed(0)}%`;
                
                currentGameState.combo = combo;
                currentGameState.intensity = intensity;
                
                if (enhancedEngine) {
                    enhancedEngine.updateGameState(currentGameState);
                }
                
            } catch (error) {
                displayResult('realtime-result', `❌ ゲーム状態リアルタイム更新エラー: ${error.message}`, 'error');
            }
        };
        
        window.setGameScene = function(scene) {
            try {
                currentGameState.scene = scene;
                
                if (enhancedEngine) {
                    enhancedEngine.updateGameState(currentGameState);
                }
                
                displayResult('realtime-result', `🎮 ゲームシーン変更: ${scene}`, 'info');
                
            } catch (error) {
                displayResult('realtime-result', `❌ ゲームシーン変更エラー: ${error.message}`, 'error');
            }
        };
        
        // 5. パフォーマンステスト
        window.runFullPerformanceTest = async function() {
            try {
                displayResult('performance-result', '⚡ 完全パフォーマンステスト開始...', 'info');
                
                await ensureEnhancedEngine();
                
                const result = await enhancedEngine.performanceTest();
                
                if (result.success) {
                    const r = result.results;
                    displayResult('performance-result', 
                        `✅ パフォーマンステスト完了\n` +
                        `総時間: ${r.totalTime.toFixed(2)}ms\n` +
                        `初期化: ${r.initLatency.toFixed(2)}ms\n` +
                        `再生開始: ${r.playLatency.toFixed(2)}ms\n` +
                        `エフェクト: ${r.effectLatency.toFixed(2)}ms\n` +
                        `評価: ${r.performance}\n` +
                        `メモリ使用量: ${r.memoryUsage.estimated}`, 
                        r.performance === 'good' ? 'success' : 'warning');
                } else {
                    displayResult('performance-result', 
                        `❌ パフォーマンステスト失敗: ${result.error}`, 'error');
                }
                
            } catch (error) {
                displayResult('performance-result', `❌ パフォーマンステストエラー: ${error.message}`, 'error');
            }
        };
        
        // 6. システム状態更新
        window.updateSystemStatus = function() {
            try {
                // エフェクトマネージャー状態
                if (effectsManager) {
                    const effectsStatus = effectsManager.getEffectsStatus();
                    
                    document.getElementById('stat-effects-init').textContent = 
                        effectsStatus.initialized ? '✅ 完了' : '❌ 未完了';
                    
                    document.getElementById('stat-active-effects').textContent = 
                        effectsStatus.stats.activeEffects || '0';
                    
                    const totalChains = effectsStatus.chains.master + effectsStatus.chains.music + effectsStatus.chains.sfx;
                    document.getElementById('stat-effect-chains').textContent = totalChains;
                }
                
                // 統合エンジン状態
                if (enhancedEngine) {
                    const enhancedStatus = enhancedEngine.getEnhancedEngineStatus();
                    
                    document.getElementById('stat-latency').textContent = 
                        enhancedStatus.performance?.latency?.toFixed(2) + 'ms' || '-';
                    
                    document.getElementById('stat-memory').textContent = 
                        enhancedStatus.effects?.stats?.memoryUsage || '-';
                }
                
                displayResult('status-result', 
                    `📊 システム状態更新完了 (${new Date().toLocaleTimeString()})`, 'info');
                
            } catch (error) {
                displayResult('status-result', `❌ 状態更新エラー: ${error.message}`, 'error');
            }
        };
        
        // 完全テストスイート
        window.runFullTestSuite = async function() {
            try {
                displayResult('status-result', '🔬 完全テストスイート実行開始...', 'info');
                
                const tests = [
                    testEffectsInitialization,
                    testBasicEffectsCreation,
                    testAdvancedEffectsCreation,
                    testEffectChains,
                    testEnhancedEngineInit,
                    testEnhancedBGMPlay,
                    testReverbEffect,
                    testFilterEffect,
                    testDistortionEffect
                ];
                
                let passedTests = 0;
                
                for (let i = 0; i < tests.length; i++) {
                    try {
                        await tests[i]();
                        passedTests++;
                        await new Promise(resolve => setTimeout(resolve, 800));
                    } catch (error) {
                        console.error(`Test ${i} failed:`, error);
                    }
                }
                
                displayResult('status-result', 
                    `🎯 完全テストスイート完了\n` +
                    `結果: ${passedTests}/${tests.length} テスト成功\n` +
                    `成功率: ${((passedTests / tests.length) * 100).toFixed(1)}%`, 
                    passedTests >= tests.length * 0.8 ? 'success' : 'warning');
                    
            } catch (error) {
                displayResult('status-result', `❌ テストスイートエラー: ${error.message}`, 'error');
            }
        };
        
        // ユーティリティ関数
        async function ensureEffectsManager() {
            if (!effectsManager) {
                effectsManager = new AudioEffectsManager();
                await effectsManager.initialize();
            }
            return effectsManager;
        }
        
        async function ensureEnhancedEngine() {
            if (!enhancedEngine) {
                enhancedEngine = new EnhancedMusicEngine();
                await enhancedEngine.initializeEnhancedEngine();
            }
            return enhancedEngine;
        }
        
        function displayResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `test-result ${type}`;
            }
        }
        
        window.clearAllTests = function() {
            const resultElements = document.querySelectorAll('.test-result');
            resultElements.forEach(element => {
                element.textContent = '';
                element.className = 'test-result';
            });
        };
        
        // 初期化
        setTimeout(() => {
            console.log('🎛️ Phase 2.2 Effects System Test Page Ready');
        }, 100);
        
    </script>
</body>
</html>