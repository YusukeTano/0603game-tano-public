<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioFoundationLayer テストシステム</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
        }
        .test-section {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        .button {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }
        .button:hover {
            background: #004400;
        }
        .button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .status-display {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 14px;
            white-space: pre-line;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
        .error { color: #ff0000; }
        .info { color: #00aaff; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(0, 100, 0, 0.1);
            border: 1px solid #006600;
            padding: 15px;
            border-radius: 5px;
        }
        
        .metric-title {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-value {
            color: #ffffff;
            font-size: 1.2em;
        }
        
        .phase-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
            font-weight: bold;
        }
        
        .phase-pending { background: #333; color: #999; }
        .phase-current { background: #ff6600; color: #fff; }
        .phase-completed { background: #00aa00; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 AudioFoundationLayer テストシステム</h1>
            <p>新音響アーキテクチャ Phase 1 - 基盤レイヤーテスト</p>
            
            <!-- フェーズ進行インジケーター -->
            <div class="phase-progress">
                <span class="phase-indicator phase-current">Phase 1.1: 基本構造</span>
                <span class="phase-indicator phase-pending">Phase 1.2: コンテキスト管理</span>
                <span class="phase-indicator phase-pending">Phase 1.3: リソース管理</span>
                <span class="phase-indicator phase-pending">Phase 1.4: 監視システム</span>
                <span class="phase-indicator phase-pending">Phase 1.5: テスト検証</span>
            </div>
        </div>

        <!-- Phase 1.1 テスト: 基本構造 -->
        <div class="test-section">
            <h2>🏗️ Phase 1.1: 基本構造テスト</h2>
            <p>型定義・インターフェース・クラス骨格の検証</p>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">クラス読み込み状態</div>
                    <div class="metric-value" id="class-load-status">未確認</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">インターフェース検証</div>
                    <div class="metric-value" id="interface-status">未確認</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">型検証システム</div>
                    <div class="metric-value" id="type-validation-status">未確認</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">エラーシステム</div>
                    <div class="metric-value" id="error-system-status">未確認</div>
                </div>
            </div>
            
            <button class="button" onclick="testPhase11()">🧪 Phase 1.1 テスト実行</button>
            <button class="button" onclick="testClassStructure()">🏗️ クラス構造テスト</button>
            <button class="button" onclick="testTypeSystem()">🔍 型システムテスト</button>
            <button class="button" onclick="testErrorSystem()">🚨 エラーシステムテスト</button>
        </div>

        <!-- コンストラクタテスト -->
        <div class="test-section">
            <h2>🔧 コンストラクタ・初期化テスト</h2>
            <p>AudioFoundationLayerインスタンス作成・初期状態検証</p>
            
            <button class="button" onclick="testConstructor()">🏗️ コンストラクタテスト</button>
            <button class="button" onclick="testInitialState()">🔍 初期状態確認</button>
            <button class="button" onclick="testDebugInfo()">📊 デバッグ情報取得</button>
        </div>

        <!-- 予定実装テスト -->
        <div class="test-section">
            <h2>📋 予定実装メソッドテスト</h2>
            <p>Phase 1.2-1.4で実装予定のメソッドスタブ確認</p>
            
            <button class="button" onclick="testPendingMethods()">🔮 予定メソッドテスト</button>
            <button class="button" onclick="showImplementationPlan()">📅 実装計画表示</button>
        </div>

        <!-- ログ・診断表示 -->
        <div class="test-section">
            <h2>📊 テスト結果・診断情報</h2>
            <div id="test-results" class="status-display">
                テスト結果がここに表示されます...
            </div>
            <button class="button" onclick="clearLog()">🧹 ログクリア</button>
            <button class="button" onclick="exportTestResults()">💾 結果エクスポート</button>
        </div>
    </div>

    <!-- Tone.js読み込み -->
    <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
    
    <!-- AudioFoundationLayer読み込み -->
    <script type="module">
        import { AudioFoundationLayer } from './public/js/systems/audio-foundation-layer.js';
        import { 
            AudioError, 
            AudioContextError, 
            ResourceError, 
            SynthError,
            AudioTypeValidator,
            AudioPerformanceTracker,
            AudioDebugLogger,
            AudioFoundationConfig
        } from './public/js/systems/audio-types.js';
        
        // グローバル変数
        let foundationLayer = null;
        let testResults = [];
        let testSession = {
            startTime: Date.now(),
            phase: '1.1',
            results: []
        };
        
        // ==================== Phase 1.1 メインテスト ====================
        
        async function testPhase11() {
            logToDisplay('🧪 Phase 1.1 包括テスト開始...', 'info');
            
            const tests = [
                testClassStructure,
                testTypeSystem,
                testErrorSystem,
                testConstructor,
                testInitialState
            ];
            
            let passed = 0;
            let total = tests.length;
            
            for (const test of tests) {
                try {
                    const result = await test();
                    if (result) passed++;
                } catch (error) {
                    logToDisplay(`❌ テスト実行エラー: ${error.message}`, 'error');
                }
            }
            
            const successRate = Math.round((passed / total) * 100);
            const status = successRate >= 80 ? 'success' : successRate >= 60 ? 'warning' : 'error';
            
            logToDisplay(`✅ Phase 1.1 テスト完了: ${passed}/${total} 成功 (${successRate}%)`, status);
            
            updatePhaseStatus('1.1', successRate >= 80 ? 'completed' : 'current');
        }
        
        // ==================== 個別テスト関数 ====================
        
        async function testClassStructure() {
            logToDisplay('🏗️ クラス構造テスト開始...', 'info');
            
            try {
                // AudioFoundationLayerクラス存在確認
                if (typeof AudioFoundationLayer !== 'function') {
                    throw new Error('AudioFoundationLayer class not found');
                }
                
                // インスタンス作成テスト
                const layer = new AudioFoundationLayer();
                if (!(layer instanceof AudioFoundationLayer)) {
                    throw new Error('Instance creation failed');
                }
                
                // 必須プロパティ確認
                const requiredProps = ['isInitialized', 'context', 'synthPool', 'performanceTracker'];
                for (const prop of requiredProps) {
                    if (!(prop in layer)) {
                        throw new Error(`Required property missing: ${prop}`);
                    }
                }
                
                // 必須メソッド確認
                const requiredMethods = ['initializeContext', 'createSynth', 'getResourceStats'];
                for (const method of requiredMethods) {
                    if (typeof layer[method] !== 'function') {
                        throw new Error(`Required method missing: ${method}`);
                    }
                }
                
                updateMetric('class-load-status', '✅ 正常');
                logToDisplay('✅ クラス構造テスト成功', 'success');
                return true;
                
            } catch (error) {
                updateMetric('class-load-status', '❌ 失敗');
                logToDisplay(`❌ クラス構造テスト失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testTypeSystem() {
            logToDisplay('🔍 型システムテスト開始...', 'info');
            
            try {
                // AudioTypeValidator テスト
                const validTypes = ['basic', 'plasma', 'nuke'];
                const invalidTypes = ['invalid', null, 123];
                
                for (const type of validTypes) {
                    if (!AudioTypeValidator.isValidSynthType(type)) {
                        throw new Error(`Valid type rejected: ${type}`);
                    }
                }
                
                for (const type of invalidTypes) {
                    if (AudioTypeValidator.isValidSynthType(type)) {
                        throw new Error(`Invalid type accepted: ${type}`);
                    }
                }
                
                // SynthConfig テスト
                const validConfigs = [
                    { volume: 0.5 },
                    { volume: 1.0, maxVoices: 2 },
                    {}
                ];
                
                const invalidConfigs = [
                    { volume: -1 },
                    { volume: 2 },
                    { maxVoices: 0 },
                    null
                ];
                
                for (const config of validConfigs) {
                    if (!AudioTypeValidator.isValidSynthConfig(config)) {
                        throw new Error(`Valid config rejected: ${JSON.stringify(config)}`);
                    }
                }
                
                for (const config of invalidConfigs) {
                    if (AudioTypeValidator.isValidSynthConfig(config)) {
                        throw new Error(`Invalid config accepted: ${JSON.stringify(config)}`);
                    }
                }
                
                updateMetric('type-validation-status', '✅ 正常');
                logToDisplay('✅ 型システムテスト成功', 'success');
                return true;
                
            } catch (error) {
                updateMetric('type-validation-status', '❌ 失敗');
                logToDisplay(`❌ 型システムテスト失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testErrorSystem() {
            logToDisplay('🚨 エラーシステムテスト開始...', 'info');
            
            try {
                // 各エラークラステスト
                const audioError = new AudioError('Test error', 'TEST_CODE', { detail: 'test' });
                if (audioError.name !== 'AudioError' || audioError.code !== 'TEST_CODE') {
                    throw new Error('AudioError creation failed');
                }
                
                const contextError = new AudioContextError('Context test');
                if (contextError.name !== 'AudioContextError') {
                    throw new Error('AudioContextError creation failed');
                }
                
                const resourceError = new ResourceError('Resource test');
                if (resourceError.name !== 'ResourceError') {
                    throw new Error('ResourceError creation failed');
                }
                
                const synthError = new SynthError('Synth test');
                if (synthError.name !== 'SynthError') {
                    throw new Error('SynthError creation failed');
                }
                
                // JSON化テスト
                const errorJson = audioError.toJSON();
                if (!errorJson.message || !errorJson.timestamp) {
                    throw new Error('Error serialization failed');
                }
                
                updateMetric('error-system-status', '✅ 正常');
                logToDisplay('✅ エラーシステムテスト成功', 'success');
                return true;
                
            } catch (error) {
                updateMetric('error-system-status', '❌ 失敗');
                logToDisplay(`❌ エラーシステムテスト失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testConstructor() {
            logToDisplay('🔧 コンストラクタテスト開始...', 'info');
            
            try {
                foundationLayer = new AudioFoundationLayer();
                
                // 初期状態確認
                if (foundationLayer.isInitialized !== false) {
                    throw new Error('Initial isInitialized should be false');
                }
                
                if (foundationLayer.isDisposed !== false) {
                    throw new Error('Initial isDisposed should be false');
                }
                
                if (!(foundationLayer.synthPool instanceof Map)) {
                    throw new Error('synthPool should be Map instance');
                }
                
                if (!(foundationLayer.performanceTracker instanceof AudioPerformanceTracker)) {
                    throw new Error('performanceTracker should be AudioPerformanceTracker instance');
                }
                
                logToDisplay('✅ コンストラクタテスト成功', 'success');
                return true;
                
            } catch (error) {
                logToDisplay(`❌ コンストラクタテスト失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testInitialState() {
            logToDisplay('🔍 初期状態確認開始...', 'info');
            
            try {
                if (!foundationLayer) {
                    foundationLayer = new AudioFoundationLayer();
                }
                
                const debugInfo = foundationLayer.getDebugInfo();
                
                // システム状態確認
                if (debugInfo.system.isInitialized !== false) {
                    throw new Error('System should not be initialized initially');
                }
                
                // リソース状態確認
                if (debugInfo.resources.activeSynths !== 0) {
                    throw new Error('Should have no active synths initially');
                }
                
                // 統計確認
                if (debugInfo.statistics.synthsCreated !== 0) {
                    throw new Error('Initial synth count should be 0');
                }
                
                logToDisplay('✅ 初期状態確認成功', 'success');
                logToDisplay(`📊 デバッグ情報: ${JSON.stringify(debugInfo, null, 2)}`, 'info');
                return true;
                
            } catch (error) {
                logToDisplay(`❌ 初期状態確認失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testDebugInfo() {
            logToDisplay('📊 デバッグ情報取得テスト...', 'info');
            
            try {
                if (!foundationLayer) {
                    foundationLayer = new AudioFoundationLayer();
                }
                
                const debugInfo = foundationLayer.getDebugInfo();
                
                // 必須セクション確認
                const requiredSections = ['system', 'context', 'resources', 'performance', 'statistics'];
                for (const section of requiredSections) {
                    if (!(section in debugInfo)) {
                        throw new Error(`Debug info missing section: ${section}`);
                    }
                }
                
                foundationLayer.debugPrint(); // コンソール出力テスト
                
                logToDisplay('✅ デバッグ情報取得成功', 'success');
                return true;
                
            } catch (error) {
                logToDisplay(`❌ デバッグ情報取得失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testPendingMethods() {
            logToDisplay('🔮 予定メソッドテスト開始...', 'info');
            
            try {
                if (!foundationLayer) {
                    foundationLayer = new AudioFoundationLayer();
                }
                
                const pendingMethods = [
                    'initializeContext',
                    'resumeContext', 
                    'suspendContext',
                    'createSynth',
                    'disposeSynth'
                ];
                
                for (const method of pendingMethods) {
                    try {
                        await foundationLayer[method]();
                        throw new Error(`Method ${method} should throw 'implementation pending' error`);
                    } catch (error) {
                        if (!error.message.includes('implementation pending')) {
                            throw new Error(`Method ${method} should throw 'implementation pending' error, got: ${error.message}`);
                        }
                    }
                }
                
                logToDisplay('✅ 予定メソッドテスト成功 - 全てpending状態確認', 'success');
                return true;
                
            } catch (error) {
                logToDisplay(`❌ 予定メソッドテスト失敗: ${error.message}`, 'error');
                return false;
            }
        }
        
        function showImplementationPlan() {
            const plan = `
📅 AudioFoundationLayer 実装計画:

Phase 1.1: 基本構造・インターフェース定義 ✅
- 型定義・エラークラス作成完了
- AudioFoundationLayerクラス骨格完了
- 基本テストシステム完了

Phase 1.2: コンテキスト管理システム (予定)
- initializeContext() 実装
- getContextState() 実装  
- resumeContext() / suspendContext() 実装

Phase 1.3: リソース管理システム (予定)
- createSynth() 実装
- disposeSynth() 実装
- synthPool 管理システム実装

Phase 1.4: 監視・ログシステム (予定)
- getResourceStats() 実装
- ヘルスメトリクス実装
- パフォーマンス監視機能実装

Phase 1.5: テスト・検証 (予定)
- 包括的単体テスト作成
- 統合テスト作成
- エラーシナリオテスト作成
            `;
            
            logToDisplay(plan, 'info');
        }
        
        // ==================== ユーティリティ関数 ====================
        
        function logToDisplay(message, type = 'info') {
            const display = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type || 'info';
            
            const logEntry = `[${timestamp}] ${message}`;
            
            if (display.textContent === 'テスト結果がここに表示されます...') {
                display.textContent = '';
            }
            
            display.textContent += logEntry + '\n';
            display.scrollTop = display.scrollHeight;
            
            // テスト結果記録
            testResults.push({
                timestamp: Date.now(),
                type,
                message
            });
            
            console.log(`[AudioFoundationTest] ${logEntry}`);
        }
        
        function updateMetric(metricId, value) {
            const element = document.getElementById(metricId);
            if (element) {
                element.textContent = value;
            }
        }
        
        function updatePhaseStatus(phase, status) {
            const indicators = document.querySelectorAll('.phase-indicator');
            indicators.forEach(indicator => {
                if (indicator.textContent.includes(`Phase ${phase}`)) {
                    indicator.className = `phase-indicator phase-${status}`;
                }
            });
        }
        
        function clearLog() {
            document.getElementById('test-results').textContent = 'テスト結果がここに表示されます...';
            testResults = [];
        }
        
        function exportTestResults() {
            const exportData = {
                session: testSession,
                results: testResults,
                timestamp: new Date().toISOString(),
                phase: '1.1',
                summary: {
                    totalTests: testResults.filter(r => r.message.includes('テスト')).length,
                    successfulTests: testResults.filter(r => r.type === 'success').length,
                    errors: testResults.filter(r => r.type === 'error').length
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `audio-foundation-test-phase1.1-${Date.now()}.json`;
            link.click();
            
            logToDisplay('💾 テスト結果をエクスポートしました', 'success');
        }
        
        // グローバルに公開
        window.testPhase11 = testPhase11;
        window.testClassStructure = testClassStructure;
        window.testTypeSystem = testTypeSystem;
        window.testErrorSystem = testErrorSystem;
        window.testConstructor = testConstructor;
        window.testInitialState = testInitialState;
        window.testDebugInfo = testDebugInfo;
        window.testPendingMethods = testPendingMethods;
        window.showImplementationPlan = showImplementationPlan;
        window.clearLog = clearLog;
        window.exportTestResults = exportTestResults;
        
        // 初期化実行
        logToDisplay('🔧 AudioFoundationLayer テストシステム初期化完了', 'success');
        logToDisplay('🧪 Phase 1.1 テストの準備が整いました', 'info');
        
    </script>
</body>
</html>