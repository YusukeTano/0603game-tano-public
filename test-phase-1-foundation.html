<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 Foundation Audio System - 単体テスト</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #555;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        
        button:hover {
            background: #0088ff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .test-result {
            background: #333;
            border-left: 4px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-result.error {
            border-left-color: #ff0000;
            color: #ff9999;
        }
        
        .test-result.warning {
            border-left-color: #ffaa00;
            color: #ffcc99;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .stat-title {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 18px;
            color: #00ff00;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ffff);
            transition: width 0.3s ease;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .phase-indicator {
            background: linear-gradient(45deg, #0066cc, #00ffff);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>🔧 Phase 1: Foundation Audio System</h1>
            <div class="phase-indicator">Phase 1.3: 単体テスト & 検証システム</div>
        </div>

        <!-- FoundationAudioAPI テスト -->
        <div class="test-section">
            <h2>🎯 FoundationAudioAPI 単体テスト</h2>
            <div class="test-controls">
                <button onclick="testFoundationAPI()">基本機能テスト</button>
                <button onclick="testFoundationAPIInitialization()">初期化テスト</button>
                <button onclick="testFoundationAPIErrorHandling()">エラーハンドリングテスト</button>
                <button onclick="testFoundationAPIPerformance()">パフォーマンステスト</button>
            </div>
            <div id="foundationapi-results" class="test-result">テスト結果がここに表示されます...</div>
        </div>

        <!-- AudioResourcePool テスト -->
        <div class="test-section">
            <h2>🏊 AudioResourcePool 単体テスト</h2>
            <div class="test-controls">
                <button onclick="testResourcePool()">プール機能テスト</button>
                <button onclick="testResourcePoolLimits()">リソース制限テスト</button>
                <button onclick="testResourcePoolCleanup()">クリーンアップテスト</button>
                <button onclick="testResourcePoolPerformance()">プール効率テスト</button>
            </div>
            <div id="resourcepool-results" class="test-result">テスト結果がここに表示されます...</div>
        </div>

        <!-- AudioSafetyLayer テスト -->
        <div class="test-section">
            <h2>🛡️ AudioSafetyLayer 単体テスト</h2>
            <div class="test-controls">
                <button onclick="testSafetyLayer()">安全性テスト</button>
                <button onclick="testCircuitBreaker()">Circuit Breakerテスト</button>
                <button onclick="testGracefulDegradation()">劣化処理テスト</button>
                <button onclick="testHealthMonitoring()">ヘルス監視テスト</button>
            </div>
            <div id="safetylayer-results" class="test-result">テスト結果がここに表示されます...</div>
        </div>

        <!-- 統合テスト -->
        <div class="test-section">
            <h2>⚡ Phase 1 統合テスト</h2>
            <div class="test-controls">
                <button onclick="runIntegrationTest()">統合テスト実行</button>
                <button onclick="runLoadTest()">負荷テスト</button>
                <button onclick="runRegressionTest()">回帰テスト</button>
                <button onclick="validatePhase1Requirements()">Phase 1要件検証</button>
            </div>
            <div id="integration-results" class="test-result">統合テスト結果がここに表示されます...</div>
        </div>

        <!-- 統計・監視 -->
        <div class="test-section">
            <h2>📊 リアルタイム統計</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">テスト実行状況</div>
                    <div class="stat-value" id="test-progress">0/0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">成功率</div>
                    <div class="stat-value" id="success-rate">--%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">平均レイテンシー</div>
                    <div class="stat-value" id="avg-latency">--ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">メモリ使用量</div>
                    <div class="stat-value" id="memory-usage">--/20</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">システム健康状態</div>
                    <div class="stat-value" id="system-health">unknown</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 1 達成度</div>
                    <div class="stat-value" id="phase1-completion">--%</div>
                </div>
            </div>
        </div>

        <!-- 全体制御 -->
        <div class="test-section">
            <h2>🎮 テスト制御</h2>
            <div class="test-controls">
                <button onclick="runAllTests()" style="background: #ff6600;">全テスト実行</button>
                <button onclick="clearResults()">結果クリア</button>
                <button onclick="exportResults()">結果エクスポート</button>
                <button onclick="startContinuousMonitoring()">連続監視開始</button>
                <button onclick="stopContinuousMonitoring()">連続監視停止</button>
            </div>
        </div>
    </div>

    <!-- Tone.js -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    
    <!-- Phase 1 コンポーネント -->
    <script type="module">
        import { FoundationAudioAPI } from './public/js/systems/foundation-audio-api.js';
        import { AudioResourcePool } from './public/js/systems/audio-resource-pool.js';
        import { AudioSafetyLayer } from './public/js/systems/audio-safety-layer.js';

        // グローバル変数
        window.foundationAPI = null;
        window.resourcePool = null;
        window.safetyLayer = null;
        window.testStats = {
            totalTests: 0,
            passedTests: 0,
            failedTests: 0,
            startTime: null,
            latencies: []
        };
        window.continuousMonitoring = null;

        // テスト初期化
        async function initializeTestEnvironment() {
            try {
                console.log('🧪 Phase 1 テスト環境初期化開始');
                
                // コンポーネント初期化
                window.foundationAPI = new FoundationAudioAPI();
                window.resourcePool = new AudioResourcePool();
                window.safetyLayer = new AudioSafetyLayer();
                
                await window.foundationAPI.initialize();
                await window.resourcePool.initializePools();
                
                console.log('✅ Phase 1 テスト環境初期化完了');
                updateStats();
                
            } catch (error) {
                console.error('❌ テスト環境初期化失敗:', error);
            }
        }

        // FoundationAudioAPI テスト
        window.testFoundationAPI = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent = '🧪 FoundationAudioAPI テスト実行中...\n';
            
            try {
                const startTime = performance.now();
                
                // 基本機能テスト
                const tests = await window.foundationAPI.runBasicTests();
                
                const latency = performance.now() - startTime;
                window.testStats.latencies.push(latency);
                
                resultDiv.textContent += `✅ 基本機能テスト: ${tests.passed}/${tests.total} 成功\n`;
                resultDiv.textContent += `⏱️ レイテンシー: ${latency.toFixed(2)}ms\n`;
                resultDiv.textContent += `📊 システム状態: ${JSON.stringify(tests.systemStatus, null, 2)}\n`;
                
                window.testStats.totalTests++;
                if (tests.passed === tests.total) {
                    window.testStats.passedTests++;
                } else {
                    window.testStats.failedTests++;
                }
                
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `❌ テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // リソースプールテスト
        window.testResourcePool = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent = '🏊 AudioResourcePool テスト実行中...\n';
            
            try {
                const startTime = performance.now();
                
                // プール機能テスト
                const synthResult = await window.resourcePool.acquireObject('synth');
                resultDiv.textContent += `✅ Synthオブジェクト取得: ${synthResult ? '成功' : '失敗'}\n`;
                
                if (synthResult) {
                    window.resourcePool.releaseObject(synthResult.id);
                    resultDiv.textContent += `✅ Synthオブジェクト返却: 成功\n`;
                }
                
                const poolStatus = window.resourcePool.getPoolStatus();
                resultDiv.textContent += `📊 プール状態:\n${JSON.stringify(poolStatus, null, 2)}\n`;
                
                const latency = performance.now() - startTime;
                window.testStats.latencies.push(latency);
                resultDiv.textContent += `⏱️ プール操作レイテンシー: ${latency.toFixed(2)}ms\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `❌ テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // 安全性レイヤーテスト
        window.testSafetyLayer = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent = '🛡️ AudioSafetyLayer テスト実行中...\n';
            
            try {
                // 正常操作テスト
                const normalResult = await window.safetyLayer.safeExecute(
                    async () => ({ success: true, message: 'Normal operation' }),
                    null
                );
                
                resultDiv.textContent += `✅ 正常操作: ${normalResult.success ? '成功' : '失敗'}\n`;
                
                // エラー操作テスト
                const errorResult = await window.safetyLayer.safeExecute(
                    async () => { throw new Error('Test error'); },
                    () => ({ success: true, fallback: true })
                );
                
                resultDiv.textContent += `✅ エラー処理: ${errorResult.fallback ? '成功' : '失敗'}\n`;
                
                const systemStatus = window.safetyLayer.getSystemStatus();
                resultDiv.textContent += `📊 安全性状態:\n${JSON.stringify(systemStatus, null, 2)}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `❌ テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // 統合テスト
        window.runIntegrationTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent = '⚡ Phase 1 統合テスト実行中...\n';
            
            try {
                const startTime = performance.now();
                
                // 全コンポーネント連携テスト
                resultDiv.textContent += '1. FoundationAPI + ResourcePool 連携テスト...\n';
                
                const pooledSound = await window.resourcePool.acquireObject('synth');
                if (pooledSound) {
                    const soundResult = await window.foundationAPI.playSound('test');
                    window.resourcePool.releaseObject(pooledSound.id);
                    
                    resultDiv.textContent += `   ✅ 音響再生 + プール管理: 成功\n`;
                } else {
                    resultDiv.textContent += `   ❌ プールオブジェクト取得失敗\n`;
                }
                
                resultDiv.textContent += '2. 安全性レイヤー統合テスト...\n';
                
                const safeResult = await window.safetyLayer.safeExecute(
                    async () => {
                        const pool = await window.resourcePool.acquireObject('noise');
                        const sound = await window.foundationAPI.playSound('click');
                        if (pool) window.resourcePool.releaseObject(pool.id);
                        return { success: true, components: ['API', 'Pool', 'Safety'] };
                    },
                    () => ({ success: true, fallback: true })
                );
                
                resultDiv.textContent += `   ✅ 3コンポーネント統合: ${safeResult.success ? '成功' : '失敗'}\n`;
                
                const totalLatency = performance.now() - startTime;
                resultDiv.textContent += `⏱️ 統合テスト所要時間: ${totalLatency.toFixed(2)}ms\n`;
                
                // Phase 1 要件確認
                const phase1Requirements = validatePhase1Requirements();
                resultDiv.textContent += `📋 Phase 1 要件達成度: ${phase1Requirements.completionRate}%\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `❌ 統合テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // Phase 1 要件検証
        window.validatePhase1Requirements = function() {
            const requirements = [
                {
                    name: 'Tone.js依存性のみ',
                    check: () => typeof window.Tone !== 'undefined',
                    weight: 20
                },
                {
                    name: '基盤技術（既知パターン）',
                    check: () => window.foundationAPI && window.foundationAPI.isInitialized,
                    weight: 25
                },
                {
                    name: 'リソース制限（20個以下）',
                    check: () => {
                        const status = window.resourcePool?.getPoolStatus();
                        return status && status.totalMemoryUsage <= 20;
                    },
                    weight: 25
                },
                {
                    name: '安全性設計',
                    check: () => {
                        const status = window.safetyLayer?.getSystemStatus();
                        return status && status.systemHealth !== 'failed';
                    },
                    weight: 30
                }
            ];
            
            let totalWeight = 0;
            let achievedWeight = 0;
            
            for (const req of requirements) {
                totalWeight += req.weight;
                if (req.check()) {
                    achievedWeight += req.weight;
                }
            }
            
            return {
                completionRate: Math.round((achievedWeight / totalWeight) * 100),
                requirements,
                achievedWeight,
                totalWeight
            };
        };

        // 統計更新
        function updateStats() {
            const totalTests = window.testStats.totalTests;
            const passedTests = window.testStats.passedTests;
            
            document.getElementById('test-progress').textContent = `${passedTests}/${totalTests}`;
            document.getElementById('success-rate').textContent = 
                totalTests > 0 ? `${Math.round((passedTests / totalTests) * 100)}%` : '--%';
            
            const avgLatency = window.testStats.latencies.length > 0 ?
                window.testStats.latencies.reduce((a, b) => a + b, 0) / window.testStats.latencies.length : 0;
            document.getElementById('avg-latency').textContent = `${avgLatency.toFixed(2)}ms`;
            
            if (window.resourcePool) {
                const poolStatus = window.resourcePool.getPoolStatus();
                document.getElementById('memory-usage').textContent = 
                    `${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}`;
            }
            
            if (window.safetyLayer) {
                const safetyStatus = window.safetyLayer.getSystemStatus();
                document.getElementById('system-health').textContent = safetyStatus.systemHealth;
            }
            
            const phase1Status = validatePhase1Requirements();
            document.getElementById('phase1-completion').textContent = `${phase1Status.completionRate}%`;
            
            // プログレスバー更新
            const progressPercent = totalTests > 0 ? (passedTests / totalTests) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }

        // 全テスト実行
        window.runAllTests = async function() {
            console.log('🚀 Phase 1 全テスト実行開始');
            window.testStats.startTime = Date.now();
            
            await testFoundationAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testResourcePool();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSafetyLayer();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runIntegrationTest();
            
            console.log('✅ Phase 1 全テスト実行完了');
        };

        // === 追加テスト関数実装 ===
        
        // FoundationAudioAPI 詳細テスト
        window.testFoundationAPIInitialization = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\n🔄 初期化テスト実行中...\n';
            
            try {
                const api = new FoundationAudioAPI();
                const initResult = await api.initialize();
                
                resultDiv.textContent += `✅ 初期化: ${initResult.success ? '成功' : '失敗'}\n`;
                resultDiv.textContent += `⏱️ 初期化時間: ${initResult.latency?.toFixed(2) || '--'}ms\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ 初期化テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testFoundationAPIErrorHandling = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\n🛡️ エラーハンドリングテスト実行中...\n';
            
            try {
                // 無効な音響タイプでテスト
                const result = await window.foundationAPI.playSound('invalid_sound_type');
                resultDiv.textContent += `✅ 無効音響処理: ${result.success ? 'フォールバック成功' : '適切な失敗'}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ エラーハンドリングテスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testFoundationAPIPerformance = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\n⚡ パフォーマンステスト実行中...\n';
            
            try {
                const iterations = 10;
                const latencies = [];
                
                for (let i = 0; i < iterations; i++) {
                    const start = performance.now();
                    await window.foundationAPI.playSound('test');
                    latencies.push(performance.now() - start);
                }
                
                const avgLatency = latencies.reduce((a, b) => a + b, 0) / latencies.length;
                const maxLatency = Math.max(...latencies);
                
                resultDiv.textContent += `✅ 平均レイテンシー: ${avgLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `📊 最大レイテンシー: ${maxLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `🎯 パフォーマンス評価: ${avgLatency < 50 ? '優秀' : avgLatency < 100 ? '良好' : '要改善'}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ パフォーマンステスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // ResourcePool 詳細テスト
        window.testResourcePoolLimits = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\n📊 リソース制限テスト実行中...\n';
            
            try {
                const acquiredObjects = [];
                
                // 制限を超えるまでオブジェクト取得
                for (let i = 0; i < 25; i++) {  // 制限20を超える数
                    const obj = await window.resourcePool.acquireObject('synth');
                    if (obj) {
                        acquiredObjects.push(obj);
                    }
                }
                
                const poolStatus = window.resourcePool.getPoolStatus();
                resultDiv.textContent += `✅ 取得オブジェクト数: ${acquiredObjects.length}\n`;
                resultDiv.textContent += `📊 メモリ使用量: ${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}\n`;
                resultDiv.textContent += `🛡️ 制限遵守: ${poolStatus.isOptimal ? '成功' : '制限内'}\n`;
                
                // オブジェクト返却
                for (const obj of acquiredObjects) {
                    window.resourcePool.releaseObject(obj.id);
                }
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ リソース制限テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testResourcePoolCleanup = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\n🧹 クリーンアップテスト実行中...\n';
            
            try {
                const beforeStatus = window.resourcePool.getPoolStatus();
                
                // 強制クリーンアップ実行
                window.resourcePool.cleanupPools();
                
                const afterStatus = window.resourcePool.getPoolStatus();
                
                resultDiv.textContent += `✅ クリーンアップ前: ${beforeStatus.totalMemoryUsage}個\n`;
                resultDiv.textContent += `✅ クリーンアップ後: ${afterStatus.totalMemoryUsage}個\n`;
                resultDiv.textContent += `🧹 クリーンアップ: 正常実行\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ クリーンアップテスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testResourcePoolPerformance = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\n⚡ プール効率テスト実行中...\n';
            
            try {
                const iterations = 20;
                const acquireLatencies = [];
                const releaseLatencies = [];
                
                for (let i = 0; i < iterations; i++) {
                    // 取得時間測定
                    const acquireStart = performance.now();
                    const obj = await window.resourcePool.acquireObject('noise');
                    acquireLatencies.push(performance.now() - acquireStart);
                    
                    if (obj) {
                        // 返却時間測定
                        const releaseStart = performance.now();
                        window.resourcePool.releaseObject(obj.id);
                        releaseLatencies.push(performance.now() - releaseStart);
                    }
                }
                
                const avgAcquire = acquireLatencies.reduce((a, b) => a + b, 0) / acquireLatencies.length;
                const avgRelease = releaseLatencies.reduce((a, b) => a + b, 0) / releaseLatencies.length;
                const poolStatus = window.resourcePool.getPoolStatus();
                
                resultDiv.textContent += `⚡ 平均取得時間: ${avgAcquire.toFixed(2)}ms\n`;
                resultDiv.textContent += `⚡ 平均返却時間: ${avgRelease.toFixed(2)}ms\n`;
                resultDiv.textContent += `🎯 プールヒット率: ${poolStatus.stats.poolHitRate.toFixed(1)}%\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ プール効率テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // SafetyLayer 詳細テスト
        window.testCircuitBreaker = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\n⚡ Circuit Breakerテスト実行中...\n';
            
            try {
                // 意図的に複数回エラーを発生させてCircuit Breakerをテスト
                for (let i = 0; i < 6; i++) {  // しきい値5を超える
                    await window.safetyLayer.safeExecute(
                        async () => { throw new Error(`Test error ${i + 1}`); },
                        () => ({ success: true, fallback: true })
                    );
                }
                
                const status = window.safetyLayer.getSystemStatus();
                resultDiv.textContent += `⚡ Circuit Breaker状態: ${status.circuitBreaker.isOpen ? '開放' : '閉鎖'}\n`;
                resultDiv.textContent += `📊 失敗カウント: ${status.circuitBreaker.failureCount}\n`;
                resultDiv.textContent += `🛡️ 劣化レベル: ${status.degradationLevel}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ Circuit Breakerテスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testGracefulDegradation = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\n⬇️ 劣化処理テスト実行中...\n';
            
            try {
                const beforeStatus = window.safetyLayer.getSystemStatus();
                
                // システム劣化をトリガー
                window.safetyLayer.degradeSystem();
                
                const afterStatus = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `⬇️ 劣化前レベル: ${beforeStatus.degradationLevel}\n`;
                resultDiv.textContent += `⬇️ 劣化後レベル: ${afterStatus.degradationLevel}\n`;
                resultDiv.textContent += `📊 フォールバック名: ${afterStatus.fallbackLevel.name}\n`;
                resultDiv.textContent += `📝 説明: ${afterStatus.fallbackLevel.description}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ 劣化処理テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testHealthMonitoring = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\n💊 ヘルス監視テスト実行中...\n';
            
            try {
                // 手動ヘルスチェック実行
                window.safetyLayer.performHealthCheck();
                
                const status = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `💊 システム健康状態: ${status.systemHealth}\n`;
                resultDiv.textContent += `📊 エラー率: ${status.errorRate.toFixed(1)}%\n`;
                resultDiv.textContent += `⏱️ 平均レイテンシー: ${status.metrics.averageLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `🔍 最近のエラー数: ${status.metrics.recentErrors}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ ヘルス監視テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // 統合テスト詳細
        window.runLoadTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent += '\n🔥 負荷テスト実行中...\n';
            
            try {
                const concurrentOperations = 10;
                const operationsPerConcurrent = 5;
                const promises = [];
                
                for (let i = 0; i < concurrentOperations; i++) {
                    promises.push(async () => {
                        for (let j = 0; j < operationsPerConcurrent; j++) {
                            const obj = await window.resourcePool.acquireObject('fm');
                            await window.foundationAPI.playSound('test');
                            if (obj) window.resourcePool.releaseObject(obj.id);
                        }
                    });
                }
                
                const startTime = performance.now();
                await Promise.all(promises.map(p => p()));
                const duration = performance.now() - startTime;
                
                const poolStatus = window.resourcePool.getPoolStatus();
                const safetyStatus = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `🔥 負荷テスト完了: ${duration.toFixed(2)}ms\n`;
                resultDiv.textContent += `📊 同時操作数: ${concurrentOperations}×${operationsPerConcurrent}\n`;
                resultDiv.textContent += `🛡️ システム健康状態: ${safetyStatus.systemHealth}\n`;
                resultDiv.textContent += `📈 リソース使用量: ${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ 負荷テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.runRegressionTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent += '\n🔄 回帰テスト実行中...\n';
            
            try {
                // 既知の動作パターンを再テスト
                const regressionTests = [
                    { name: 'FoundationAPI基本動作', test: () => window.foundationAPI.playSound('test') },
                    { name: 'ResourcePool取得・返却', test: async () => {
                        const obj = await window.resourcePool.acquireObject('synth');
                        if (obj) window.resourcePool.releaseObject(obj.id);
                        return { success: true };
                    }},
                    { name: 'SafetyLayer正常処理', test: () => window.safetyLayer.safeExecute(async () => ({ success: true })) },
                    { name: 'SafetyLayerエラー処理', test: () => window.safetyLayer.safeExecute(
                        async () => { throw new Error('Regression test error'); },
                        () => ({ success: true, fallback: true })
                    )}
                ];
                
                let passedRegression = 0;
                
                for (const regTest of regressionTests) {
                    try {
                        const result = await regTest.test();
                        if (result.success || result.fallback) {
                            passedRegression++;
                            resultDiv.textContent += `✅ ${regTest.name}: 成功\n`;
                        } else {
                            resultDiv.textContent += `❌ ${regTest.name}: 失敗\n`;
                        }
                    } catch (error) {
                        resultDiv.textContent += `❌ ${regTest.name}: エラー (${error.message})\n`;
                    }
                }
                
                resultDiv.textContent += `🔄 回帰テスト結果: ${passedRegression}/${regressionTests.length} 成功\n`;
                
                window.testStats.totalTests++;
                if (passedRegression === regressionTests.length) {
                    window.testStats.passedTests++;
                } else {
                    window.testStats.failedTests++;
                }
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `❌ 回帰テスト失敗: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // その他のユーティリティ関数
        window.clearResults = function() {
            document.querySelectorAll('.test-result').forEach(div => {
                div.textContent = 'テスト結果がここに表示されます...';
                div.className = 'test-result';
            });
            window.testStats = { totalTests: 0, passedTests: 0, failedTests: 0, latencies: [] };
            updateStats();
        };

        // 初期化実行
        initializeTestEnvironment();
    </script>
</body>
</html>