<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 Foundation Audio System - å˜ä½“ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #555;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        
        button:hover {
            background: #0088ff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .test-result {
            background: #333;
            border-left: 4px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-result.error {
            border-left-color: #ff0000;
            color: #ff9999;
        }
        
        .test-result.warning {
            border-left-color: #ffaa00;
            color: #ffcc99;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .stat-title {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 18px;
            color: #00ff00;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ffff);
            transition: width 0.3s ease;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .phase-indicator {
            background: linear-gradient(45deg, #0066cc, #00ffff);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ğŸ”§ Phase 1: Foundation Audio System</h1>
            <div class="phase-indicator">Phase 1.3: å˜ä½“ãƒ†ã‚¹ãƒˆ & æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ </div>
        </div>

        <!-- FoundationAudioAPI ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ¯ FoundationAudioAPI å˜ä½“ãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-controls">
                <button onclick="testFoundationAPI()">åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testFoundationAPIInitialization()">åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testFoundationAPIErrorHandling()">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testFoundationAPIPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="foundationapi-results" class="test-result">ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>

        <!-- AudioResourcePool ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸŠ AudioResourcePool å˜ä½“ãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-controls">
                <button onclick="testResourcePool()">ãƒ—ãƒ¼ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testResourcePoolLimits()">ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testResourcePoolCleanup()">ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testResourcePoolPerformance()">ãƒ—ãƒ¼ãƒ«åŠ¹ç‡ãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="resourcepool-results" class="test-result">ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>

        <!-- AudioSafetyLayer ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ›¡ï¸ AudioSafetyLayer å˜ä½“ãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-controls">
                <button onclick="testSafetyLayer()">å®‰å…¨æ€§ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testCircuitBreaker()">Circuit Breakerãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testGracefulDegradation()">åŠ£åŒ–å‡¦ç†ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testHealthMonitoring()">ãƒ˜ãƒ«ã‚¹ç›£è¦–ãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="safetylayer-results" class="test-result">ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>

        <!-- çµ±åˆãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>âš¡ Phase 1 çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-controls">
                <button onclick="runIntegrationTest()">çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="runLoadTest()">è² è·ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="runRegressionTest()">å›å¸°ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="validatePhase1Requirements()">Phase 1è¦ä»¶æ¤œè¨¼</button>
            </div>
            <div id="integration-results" class="test-result">çµ±åˆãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>

        <!-- çµ±è¨ˆãƒ»ç›£è¦– -->
        <div class="test-section">
            <h2>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒçŠ¶æ³</div>
                    <div class="stat-value" id="test-progress">0/0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">æˆåŠŸç‡</div>
                    <div class="stat-value" id="success-rate">--%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼</div>
                    <div class="stat-value" id="avg-latency">--ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</div>
                    <div class="stat-value" id="memory-usage">--/20</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹</div>
                    <div class="stat-value" id="system-health">unknown</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Phase 1 é”æˆåº¦</div>
                    <div class="stat-value" id="phase1-completion">--%</div>
                </div>
            </div>
        </div>

        <!-- å…¨ä½“åˆ¶å¾¡ -->
        <div class="test-section">
            <h2>ğŸ® ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h2>
            <div class="test-controls">
                <button onclick="runAllTests()" style="background: #ff6600;">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
                <button onclick="exportResults()">çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button onclick="startContinuousMonitoring()">é€£ç¶šç›£è¦–é–‹å§‹</button>
                <button onclick="stopContinuousMonitoring()">é€£ç¶šç›£è¦–åœæ­¢</button>
            </div>
        </div>
    </div>

    <!-- Tone.js -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    
    <!-- Phase 1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <script type="module">
        import { FoundationAudioAPI } from './public/js/systems/foundation-audio-api.js';
        import { AudioResourcePool } from './public/js/systems/audio-resource-pool.js';
        import { AudioSafetyLayer } from './public/js/systems/audio-safety-layer.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.foundationAPI = null;
        window.resourcePool = null;
        window.safetyLayer = null;
        window.testStats = {
            totalTests: 0,
            passedTests: 0,
            failedTests: 0,
            startTime: null,
            latencies: []
        };
        window.continuousMonitoring = null;

        // ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
        async function initializeTestEnvironment() {
            try {
                console.log('ğŸ§ª Phase 1 ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–é–‹å§‹');
                
                // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–
                window.foundationAPI = new FoundationAudioAPI();
                window.resourcePool = new AudioResourcePool();
                window.safetyLayer = new AudioSafetyLayer();
                
                await window.foundationAPI.initialize();
                await window.resourcePool.initializePools();
                
                console.log('âœ… Phase 1 ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–å®Œäº†');
                updateStats();
                
            } catch (error) {
                console.error('âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–å¤±æ•—:', error);
            }
        }

        // FoundationAudioAPI ãƒ†ã‚¹ãƒˆ
        window.testFoundationAPI = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent = 'ğŸ§ª FoundationAudioAPI ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const startTime = performance.now();
                
                // åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                const tests = await window.foundationAPI.runBasicTests();
                
                const latency = performance.now() - startTime;
                window.testStats.latencies.push(latency);
                
                resultDiv.textContent += `âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: ${tests.passed}/${tests.total} æˆåŠŸ\n`;
                resultDiv.textContent += `â±ï¸ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ${latency.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${JSON.stringify(tests.systemStatus, null, 2)}\n`;
                
                window.testStats.totalTests++;
                if (tests.passed === tests.total) {
                    window.testStats.passedTests++;
                } else {
                    window.testStats.failedTests++;
                }
                
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // ãƒªã‚½ãƒ¼ã‚¹ãƒ—ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
        window.testResourcePool = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent = 'ğŸŠ AudioResourcePool ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const startTime = performance.now();
                
                // ãƒ—ãƒ¼ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                const synthResult = await window.resourcePool.acquireObject('synth');
                resultDiv.textContent += `âœ… Synthã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—: ${synthResult ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
                
                if (synthResult) {
                    window.resourcePool.releaseObject(synthResult.id);
                    resultDiv.textContent += `âœ… Synthã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿”å´: æˆåŠŸ\n`;
                }
                
                const poolStatus = window.resourcePool.getPoolStatus();
                resultDiv.textContent += `ğŸ“Š ãƒ—ãƒ¼ãƒ«çŠ¶æ…‹:\n${JSON.stringify(poolStatus, null, 2)}\n`;
                
                const latency = performance.now() - startTime;
                window.testStats.latencies.push(latency);
                resultDiv.textContent += `â±ï¸ ãƒ—ãƒ¼ãƒ«æ“ä½œãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ${latency.toFixed(2)}ms\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // å®‰å…¨æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ã‚¹ãƒˆ
        window.testSafetyLayer = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent = 'ğŸ›¡ï¸ AudioSafetyLayer ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                // æ­£å¸¸æ“ä½œãƒ†ã‚¹ãƒˆ
                const normalResult = await window.safetyLayer.safeExecute(
                    async () => ({ success: true, message: 'Normal operation' }),
                    null
                );
                
                resultDiv.textContent += `âœ… æ­£å¸¸æ“ä½œ: ${normalResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
                
                // ã‚¨ãƒ©ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆ
                const errorResult = await window.safetyLayer.safeExecute(
                    async () => { throw new Error('Test error'); },
                    () => ({ success: true, fallback: true })
                );
                
                resultDiv.textContent += `âœ… ã‚¨ãƒ©ãƒ¼å‡¦ç†: ${errorResult.fallback ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
                
                const systemStatus = window.safetyLayer.getSystemStatus();
                resultDiv.textContent += `ğŸ“Š å®‰å…¨æ€§çŠ¶æ…‹:\n${JSON.stringify(systemStatus, null, 2)}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // çµ±åˆãƒ†ã‚¹ãƒˆ
        window.runIntegrationTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent = 'âš¡ Phase 1 çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const startTime = performance.now();
                
                // å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æºãƒ†ã‚¹ãƒˆ
                resultDiv.textContent += '1. FoundationAPI + ResourcePool é€£æºãƒ†ã‚¹ãƒˆ...\n';
                
                const pooledSound = await window.resourcePool.acquireObject('synth');
                if (pooledSound) {
                    const soundResult = await window.foundationAPI.playSound('test');
                    window.resourcePool.releaseObject(pooledSound.id);
                    
                    resultDiv.textContent += `   âœ… éŸ³éŸ¿å†ç”Ÿ + ãƒ—ãƒ¼ãƒ«ç®¡ç†: æˆåŠŸ\n`;
                } else {
                    resultDiv.textContent += `   âŒ ãƒ—ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—\n`;
                }
                
                resultDiv.textContent += '2. å®‰å…¨æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ...\n';
                
                const safeResult = await window.safetyLayer.safeExecute(
                    async () => {
                        const pool = await window.resourcePool.acquireObject('noise');
                        const sound = await window.foundationAPI.playSound('click');
                        if (pool) window.resourcePool.releaseObject(pool.id);
                        return { success: true, components: ['API', 'Pool', 'Safety'] };
                    },
                    () => ({ success: true, fallback: true })
                );
                
                resultDiv.textContent += `   âœ… 3ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ: ${safeResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
                
                const totalLatency = performance.now() - startTime;
                resultDiv.textContent += `â±ï¸ çµ±åˆãƒ†ã‚¹ãƒˆæ‰€è¦æ™‚é–“: ${totalLatency.toFixed(2)}ms\n`;
                
                // Phase 1 è¦ä»¶ç¢ºèª
                const phase1Requirements = validatePhase1Requirements();
                resultDiv.textContent += `ğŸ“‹ Phase 1 è¦ä»¶é”æˆåº¦: ${phase1Requirements.completionRate}%\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent += `âŒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };

        // Phase 1 è¦ä»¶æ¤œè¨¼
        window.validatePhase1Requirements = function() {
            const requirements = [
                {
                    name: 'Tone.jsä¾å­˜æ€§ã®ã¿',
                    check: () => typeof window.Tone !== 'undefined',
                    weight: 20
                },
                {
                    name: 'åŸºç›¤æŠ€è¡“ï¼ˆæ—¢çŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰',
                    check: () => window.foundationAPI && window.foundationAPI.isInitialized,
                    weight: 25
                },
                {
                    name: 'ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ï¼ˆ20å€‹ä»¥ä¸‹ï¼‰',
                    check: () => {
                        const status = window.resourcePool?.getPoolStatus();
                        return status && status.totalMemoryUsage <= 20;
                    },
                    weight: 25
                },
                {
                    name: 'å®‰å…¨æ€§è¨­è¨ˆ',
                    check: () => {
                        const status = window.safetyLayer?.getSystemStatus();
                        return status && status.systemHealth !== 'failed';
                    },
                    weight: 30
                }
            ];
            
            let totalWeight = 0;
            let achievedWeight = 0;
            
            for (const req of requirements) {
                totalWeight += req.weight;
                if (req.check()) {
                    achievedWeight += req.weight;
                }
            }
            
            return {
                completionRate: Math.round((achievedWeight / totalWeight) * 100),
                requirements,
                achievedWeight,
                totalWeight
            };
        };

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const totalTests = window.testStats.totalTests;
            const passedTests = window.testStats.passedTests;
            
            document.getElementById('test-progress').textContent = `${passedTests}/${totalTests}`;
            document.getElementById('success-rate').textContent = 
                totalTests > 0 ? `${Math.round((passedTests / totalTests) * 100)}%` : '--%';
            
            const avgLatency = window.testStats.latencies.length > 0 ?
                window.testStats.latencies.reduce((a, b) => a + b, 0) / window.testStats.latencies.length : 0;
            document.getElementById('avg-latency').textContent = `${avgLatency.toFixed(2)}ms`;
            
            if (window.resourcePool) {
                const poolStatus = window.resourcePool.getPoolStatus();
                document.getElementById('memory-usage').textContent = 
                    `${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}`;
            }
            
            if (window.safetyLayer) {
                const safetyStatus = window.safetyLayer.getSystemStatus();
                document.getElementById('system-health').textContent = safetyStatus.systemHealth;
            }
            
            const phase1Status = validatePhase1Requirements();
            document.getElementById('phase1-completion').textContent = `${phase1Status.completionRate}%`;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            const progressPercent = totalTests > 0 ? (passedTests / totalTests) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        window.runAllTests = async function() {
            console.log('ğŸš€ Phase 1 å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
            window.testStats.startTime = Date.now();
            
            await testFoundationAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testResourcePool();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSafetyLayer();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runIntegrationTest();
            
            console.log('âœ… Phase 1 å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†');
        };

        // === è¿½åŠ ãƒ†ã‚¹ãƒˆé–¢æ•°å®Ÿè£… ===
        
        // FoundationAudioAPI è©³ç´°ãƒ†ã‚¹ãƒˆ
        window.testFoundationAPIInitialization = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\nğŸ”„ åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const api = new FoundationAudioAPI();
                const initResult = await api.initialize();
                
                resultDiv.textContent += `âœ… åˆæœŸåŒ–: ${initResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}\n`;
                resultDiv.textContent += `â±ï¸ åˆæœŸåŒ–æ™‚é–“: ${initResult.latency?.toFixed(2) || '--'}ms\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testFoundationAPIErrorHandling = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\nğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                // ç„¡åŠ¹ãªéŸ³éŸ¿ã‚¿ã‚¤ãƒ—ã§ãƒ†ã‚¹ãƒˆ
                const result = await window.foundationAPI.playSound('invalid_sound_type');
                resultDiv.textContent += `âœ… ç„¡åŠ¹éŸ³éŸ¿å‡¦ç†: ${result.success ? 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ' : 'é©åˆ‡ãªå¤±æ•—'}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testFoundationAPIPerformance = async function() {
            const resultDiv = document.getElementById('foundationapi-results');
            resultDiv.textContent += '\nâš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const iterations = 10;
                const latencies = [];
                
                for (let i = 0; i < iterations; i++) {
                    const start = performance.now();
                    await window.foundationAPI.playSound('test');
                    latencies.push(performance.now() - start);
                }
                
                const avgLatency = latencies.reduce((a, b) => a + b, 0) / latencies.length;
                const maxLatency = Math.max(...latencies);
                
                resultDiv.textContent += `âœ… å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ${avgLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ“Š æœ€å¤§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ${maxLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡: ${avgLatency < 50 ? 'å„ªç§€' : avgLatency < 100 ? 'è‰¯å¥½' : 'è¦æ”¹å–„'}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // ResourcePool è©³ç´°ãƒ†ã‚¹ãƒˆ
        window.testResourcePoolLimits = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\nğŸ“Š ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const acquiredObjects = [];
                
                // åˆ¶é™ã‚’è¶…ãˆã‚‹ã¾ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
                for (let i = 0; i < 25; i++) {  // åˆ¶é™20ã‚’è¶…ãˆã‚‹æ•°
                    const obj = await window.resourcePool.acquireObject('synth');
                    if (obj) {
                        acquiredObjects.push(obj);
                    }
                }
                
                const poolStatus = window.resourcePool.getPoolStatus();
                resultDiv.textContent += `âœ… å–å¾—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${acquiredObjects.length}\n`;
                resultDiv.textContent += `ğŸ“Š ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}\n`;
                resultDiv.textContent += `ğŸ›¡ï¸ åˆ¶é™éµå®ˆ: ${poolStatus.isOptimal ? 'æˆåŠŸ' : 'åˆ¶é™å†…'}\n`;
                
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿”å´
                for (const obj of acquiredObjects) {
                    window.resourcePool.releaseObject(obj.id);
                }
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testResourcePoolCleanup = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\nğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const beforeStatus = window.resourcePool.getPoolStatus();
                
                // å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                window.resourcePool.cleanupPools();
                
                const afterStatus = window.resourcePool.getPoolStatus();
                
                resultDiv.textContent += `âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‰: ${beforeStatus.totalMemoryUsage}å€‹\n`;
                resultDiv.textContent += `âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œ: ${afterStatus.totalMemoryUsage}å€‹\n`;
                resultDiv.textContent += `ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: æ­£å¸¸å®Ÿè¡Œ\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testResourcePoolPerformance = async function() {
            const resultDiv = document.getElementById('resourcepool-results');
            resultDiv.textContent += '\nâš¡ ãƒ—ãƒ¼ãƒ«åŠ¹ç‡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const iterations = 20;
                const acquireLatencies = [];
                const releaseLatencies = [];
                
                for (let i = 0; i < iterations; i++) {
                    // å–å¾—æ™‚é–“æ¸¬å®š
                    const acquireStart = performance.now();
                    const obj = await window.resourcePool.acquireObject('noise');
                    acquireLatencies.push(performance.now() - acquireStart);
                    
                    if (obj) {
                        // è¿”å´æ™‚é–“æ¸¬å®š
                        const releaseStart = performance.now();
                        window.resourcePool.releaseObject(obj.id);
                        releaseLatencies.push(performance.now() - releaseStart);
                    }
                }
                
                const avgAcquire = acquireLatencies.reduce((a, b) => a + b, 0) / acquireLatencies.length;
                const avgRelease = releaseLatencies.reduce((a, b) => a + b, 0) / releaseLatencies.length;
                const poolStatus = window.resourcePool.getPoolStatus();
                
                resultDiv.textContent += `âš¡ å¹³å‡å–å¾—æ™‚é–“: ${avgAcquire.toFixed(2)}ms\n`;
                resultDiv.textContent += `âš¡ å¹³å‡è¿”å´æ™‚é–“: ${avgRelease.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ¯ ãƒ—ãƒ¼ãƒ«ãƒ’ãƒƒãƒˆç‡: ${poolStatus.stats.poolHitRate.toFixed(1)}%\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ãƒ—ãƒ¼ãƒ«åŠ¹ç‡ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // SafetyLayer è©³ç´°ãƒ†ã‚¹ãƒˆ
        window.testCircuitBreaker = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\nâš¡ Circuit Breakerãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                // æ„å›³çš„ã«è¤‡æ•°å›ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦Circuit Breakerã‚’ãƒ†ã‚¹ãƒˆ
                for (let i = 0; i < 6; i++) {  // ã—ãã„å€¤5ã‚’è¶…ãˆã‚‹
                    await window.safetyLayer.safeExecute(
                        async () => { throw new Error(`Test error ${i + 1}`); },
                        () => ({ success: true, fallback: true })
                    );
                }
                
                const status = window.safetyLayer.getSystemStatus();
                resultDiv.textContent += `âš¡ Circuit BreakerçŠ¶æ…‹: ${status.circuitBreaker.isOpen ? 'é–‹æ”¾' : 'é–‰é–'}\n`;
                resultDiv.textContent += `ğŸ“Š å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ: ${status.circuitBreaker.failureCount}\n`;
                resultDiv.textContent += `ğŸ›¡ï¸ åŠ£åŒ–ãƒ¬ãƒ™ãƒ«: ${status.degradationLevel}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ Circuit Breakerãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testGracefulDegradation = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\nâ¬‡ï¸ åŠ£åŒ–å‡¦ç†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const beforeStatus = window.safetyLayer.getSystemStatus();
                
                // ã‚·ã‚¹ãƒ†ãƒ åŠ£åŒ–ã‚’ãƒˆãƒªã‚¬ãƒ¼
                window.safetyLayer.degradeSystem();
                
                const afterStatus = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `â¬‡ï¸ åŠ£åŒ–å‰ãƒ¬ãƒ™ãƒ«: ${beforeStatus.degradationLevel}\n`;
                resultDiv.textContent += `â¬‡ï¸ åŠ£åŒ–å¾Œãƒ¬ãƒ™ãƒ«: ${afterStatus.degradationLevel}\n`;
                resultDiv.textContent += `ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å: ${afterStatus.fallbackLevel.name}\n`;
                resultDiv.textContent += `ğŸ“ èª¬æ˜: ${afterStatus.fallbackLevel.description}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ åŠ£åŒ–å‡¦ç†ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.testHealthMonitoring = async function() {
            const resultDiv = document.getElementById('safetylayer-results');
            resultDiv.textContent += '\nğŸ’Š ãƒ˜ãƒ«ã‚¹ç›£è¦–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                // æ‰‹å‹•ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
                window.safetyLayer.performHealthCheck();
                
                const status = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `ğŸ’Š ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹: ${status.systemHealth}\n`;
                resultDiv.textContent += `ğŸ“Š ã‚¨ãƒ©ãƒ¼ç‡: ${status.errorRate.toFixed(1)}%\n`;
                resultDiv.textContent += `â±ï¸ å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ${status.metrics.averageLatency.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ” æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼æ•°: ${status.metrics.recentErrors}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ ãƒ˜ãƒ«ã‚¹ç›£è¦–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // çµ±åˆãƒ†ã‚¹ãƒˆè©³ç´°
        window.runLoadTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent += '\nğŸ”¥ è² è·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                const concurrentOperations = 10;
                const operationsPerConcurrent = 5;
                const promises = [];
                
                for (let i = 0; i < concurrentOperations; i++) {
                    promises.push(async () => {
                        for (let j = 0; j < operationsPerConcurrent; j++) {
                            const obj = await window.resourcePool.acquireObject('fm');
                            await window.foundationAPI.playSound('test');
                            if (obj) window.resourcePool.releaseObject(obj.id);
                        }
                    });
                }
                
                const startTime = performance.now();
                await Promise.all(promises.map(p => p()));
                const duration = performance.now() - startTime;
                
                const poolStatus = window.resourcePool.getPoolStatus();
                const safetyStatus = window.safetyLayer.getSystemStatus();
                
                resultDiv.textContent += `ğŸ”¥ è² è·ãƒ†ã‚¹ãƒˆå®Œäº†: ${duration.toFixed(2)}ms\n`;
                resultDiv.textContent += `ğŸ“Š åŒæ™‚æ“ä½œæ•°: ${concurrentOperations}Ã—${operationsPerConcurrent}\n`;
                resultDiv.textContent += `ğŸ›¡ï¸ ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹: ${safetyStatus.systemHealth}\n`;
                resultDiv.textContent += `ğŸ“ˆ ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡: ${poolStatus.totalMemoryUsage}/${poolStatus.maxCapacity}\n`;
                
                window.testStats.totalTests++;
                window.testStats.passedTests++;
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ è² è·ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        window.runRegressionTest = async function() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.textContent += '\nğŸ”„ å›å¸°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            try {
                // æ—¢çŸ¥ã®å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ãƒ†ã‚¹ãƒˆ
                const regressionTests = [
                    { name: 'FoundationAPIåŸºæœ¬å‹•ä½œ', test: () => window.foundationAPI.playSound('test') },
                    { name: 'ResourcePoolå–å¾—ãƒ»è¿”å´', test: async () => {
                        const obj = await window.resourcePool.acquireObject('synth');
                        if (obj) window.resourcePool.releaseObject(obj.id);
                        return { success: true };
                    }},
                    { name: 'SafetyLayeræ­£å¸¸å‡¦ç†', test: () => window.safetyLayer.safeExecute(async () => ({ success: true })) },
                    { name: 'SafetyLayerã‚¨ãƒ©ãƒ¼å‡¦ç†', test: () => window.safetyLayer.safeExecute(
                        async () => { throw new Error('Regression test error'); },
                        () => ({ success: true, fallback: true })
                    )}
                ];
                
                let passedRegression = 0;
                
                for (const regTest of regressionTests) {
                    try {
                        const result = await regTest.test();
                        if (result.success || result.fallback) {
                            passedRegression++;
                            resultDiv.textContent += `âœ… ${regTest.name}: æˆåŠŸ\n`;
                        } else {
                            resultDiv.textContent += `âŒ ${regTest.name}: å¤±æ•—\n`;
                        }
                    } catch (error) {
                        resultDiv.textContent += `âŒ ${regTest.name}: ã‚¨ãƒ©ãƒ¼ (${error.message})\n`;
                    }
                }
                
                resultDiv.textContent += `ğŸ”„ å›å¸°ãƒ†ã‚¹ãƒˆçµæœ: ${passedRegression}/${regressionTests.length} æˆåŠŸ\n`;
                
                window.testStats.totalTests++;
                if (passedRegression === regressionTests.length) {
                    window.testStats.passedTests++;
                } else {
                    window.testStats.failedTests++;
                }
                updateStats();
                
            } catch (error) {
                resultDiv.textContent += `âŒ å›å¸°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n`;
                window.testStats.totalTests++;
                window.testStats.failedTests++;
                updateStats();
            }
        };
        
        // ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        window.clearResults = function() {
            document.querySelectorAll('.test-result').forEach(div => {
                div.textContent = 'ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
                div.className = 'test-result';
            });
            window.testStats = { totalTests: 0, passedTests: 0, failedTests: 0, latencies: [] };
            updateStats();
        };

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initializeTestEnvironment();
    </script>
</body>
</html>